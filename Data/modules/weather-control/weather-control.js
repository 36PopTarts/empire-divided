(()=>{"use strict";var e,t={};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),function(e){e.DateTimeChange="simple-calendar-date-time-change",e.ClockStartStop="simple-calendar-clock-start-stop"}(e||(e={}));class i{}const a=new class{};a.year=null,a.month=null,a.weekdays=null,a.currentWeekdayIndex=null,a.day=null,a.hour=null,a.minute=null,a.second=null;const s=new class{};s.fullDate=null,s.time=null;const r=new i;r.raw=a,r.display=s;class n{static get SimpleCalendar(){return window.SimpleCalendar.api}static clockStatus(){return this.SimpleCalendar.clockStatus()}static isPrimaryGM(){return this.SimpleCalendar.isPrimaryGM()}static startClock(){return this.SimpleCalendar.startClock()}static stopClock(){return this.SimpleCalendar.stopClock()}static timestamp(){return this.SimpleCalendar.timestamp()}static timestampToDate(e){return this.SimpleCalendar.timestampToDate(e)}static changeDate(e){return this.SimpleCalendar.changeDate(e)}}class o{static createDateObject(e){const t=new i;return t.raw={year:e.year,month:Number(e.display.month),weekdays:e.weekdays,currentWeekdayIndex:e.dayOfTheWeek,day:Number(e.display.day),hour:e.hour,minute:e.minute,second:e.second},t.display={fullDate:e.display.date,time:e.display.time},t}static timestampToDate(e){return this.createDateObject(n.timestampToDate(e))}}const l=JSON.parse('{"u2":"weather-control","S":"WeatherControl","TN":"Weather Control","i8":"4.1.9","B8":["4.0.1"]}');var c,h,p;!function(e){e[e.NONE=0]="NONE",e[e.INFO=1]="INFO",e[e.ERROR=2]="ERROR",e[e.DEBUG=3]="DEBUG",e[e.WARN=4]="WARN",e[e.ALL=5]="ALL"}(c||(c={}));class d{static renderTemplate(e,t){return window.renderTemplate(e,t)}static srcExists(e){return window.srcExists(e)}}class m{static sortSemver(e){return e.sort(this.compareSemver)}static isMoreRecent(e,t){return 0===this.sortSemver([e,t]).indexOf(e)}static compareSemver(e,t){let i,a;const s=/^[vV]|(\.0+)+$/,r=e.replace(s,"").split("."),n=t.replace(s,"").split("."),o=Math.min(r.length,n.length);for(i=0;i<o;i++)if(a=parseInt(n[i],10)-parseInt(r[i],10),a)return a;return n.length-r.length}}class u{constructor(e,t){this.gameRef=e,this.moduleSettings=t}async checkForNotices(){this.noticeForCurrentVersionIsDeclared()&&!this.noticeForCurrentVersionWasRead()&&await this.noticeFileExistsForCurrentVersion()?this.spawnNotice(this.moduleSettings.getVersion()):!await this.previousNoticeExists()||this.noticeForPreviousVersionWasRead()||this.noticeForCurrentVersionWasRead()||this.spawnNotice(this.getPreviousVersion())}noticeFileExistsForCurrentVersion(){return this.noticeFileExists(this.moduleSettings.getVersion())}noticeForCurrentVersionWasRead(){return this.moduleSettings.getListOfReadNoticesVersions().includes(this.moduleSettings.getVersion())}noticeForCurrentVersionIsDeclared(){return this.moduleSettings.getVersionsWithNotices().includes(this.moduleSettings.getVersion())}previousNoticeExists(){return!!this.getPreviousVersion()&&this.noticeFileExists(this.getPreviousVersion())}noticeForPreviousVersionWasRead(){return this.moduleSettings.getListOfReadNoticesVersions().includes(this.getPreviousVersion())}getPreviousVersion(){return m.sortSemver(this.moduleSettings.getVersionsWithNotices()).filter((e=>e!==this.moduleSettings.getVersion()))[0]}spawnNotice(e){const t=this.getPathOfNotice(e);d.renderTemplate(t).then((e=>{new Dialog({title:"Weather Control Update",content:e,buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:this.gameRef.i18n.localize("wctrl.notice.Acknowledge"),callback:()=>this.markNoticeAsSeen()}},default:"yes"},{width:600,height:700,classes:["wctrlDialog"]}).render(!0)}))}markNoticeAsSeen(){this.moduleSettings.addVersionToReadNotices(this.moduleSettings.getVersion())}noticeFileExists(e){try{return d.srcExists(`modules/${this.moduleSettings.getModuleName()}/templates/notices/${e}.html`)}catch(e){return!1}}getPathOfNotice(e){return`modules/${this.moduleSettings.getModuleName()}/templates/notices/${e}.html`}}class g{constructor(e){this.logger=e,this.migrations=new Set}register(e){this.migrations.add(e)}run(e=0,t){return 0===Object.keys(t).length?(this.logger.info("Cannot migrate empty data"),!1):(this.logger.info("Applying migrations"),this.applyMigrations(e,t))}applyMigrations(e,t){const i=this.buildListOfMigrations(e);if(i.length>0){let e=t;return i.forEach((t=>{e=t.migrate(e),this.logger.info("Migration to version "+t.version+" applied")})),e}return this.logger.info("No migration needed"),!1}buildListOfMigrations(e){return[...this.migrations].filter((t=>t.version>e)).sort(((e,t)=>e.version-t.version))}}class w extends class{constructor(e){this.version=e}}{constructor(){super(1)}migrate(e){return{version:1,currentDate:this.migrateToCurrentDate(e),climate:e.climate,isVolcanic:e.isVolcanic,lastTemp:e.lastTemp,precipitation:e.precipitation,temp:e.temp,tempRange:e.tempRange}}migrateToCurrentDate(e){const t=e.dateTime.date,i={raw:null,display:null};return i.raw={year:t.year,month:t.month,weekdays:t.weekdays,currentWeekdayIndex:t.dayOfTheWeek,day:t.day,hour:t.hour,minute:t.minute,second:t.second},i.display={fullDate:t.display.date,time:t.display.time},i}}class f{}!function(e){e.temperate="temperate",e.temperateMountain="temperateMountain",e.desert="desert",e.tundra="tundra",e.tropical="tropical",e.taiga="taiga",e.volcanic="volcanic",e.polar="polar"}(h||(h={}));class y{constructor(e={}){this.version=1,this.climate=new f,Object.assign(this,e)}get tempRange(){return this.climate.temperatureRange}set tempRange(e){this.climate.temperatureRange=e}}!function(e){e.calendarDisplay="calendarDisplay",e.noticeVersion="noticeVersion",e.outputWeatherToChat="outputWeatherChat",e.playerSeeWeatherInfo="playerSeeWeatherInfo",e.useCelcius="useCelcius",e.weatherData="weatherData",e.windowPosition="windowPosition"}(p||(p={}));class D{constructor(e){this.gameRef=e,this.registerSettings()}isSettingValueEmpty(e){return 0===Object.keys(e).length||null==e}getModuleName(){return l.u2}getVersion(){return l.i8}getVersionsWithNotices(){return l.B8}getWeatherData(){return new y(this.get(p.weatherData))}setWeatherData(e){return this.set(p.weatherData,e)}getWindowPosition(){return this.get(p.windowPosition)}setWindowPosition(e){this.set(p.windowPosition,e)}getCalendarDisplay(){return this.get(p.calendarDisplay)}getOutputWeatherToChat(){return this.get(p.outputWeatherToChat)}getUseCelcius(){return this.get(p.useCelcius)}getPlayerSeeWeather(){return this.get(p.playerSeeWeatherInfo)}getListOfReadNoticesVersions(){return this.get(p.noticeVersion)}addVersionToReadNotices(e){const t=this.getListOfReadNoticesVersions();t.push(e),this.set(p.noticeVersion,t)}register(e,t){this.gameRef.settings.register(this.getModuleName(),e,t)}get(e){return this.gameRef.settings.get(this.getModuleName(),e)}set(e,t){return this.gameRef.settings.set(this.getModuleName(),e,t)}registerSettings(){this.register(p.windowPosition,{name:"Calendar Position",scope:"client",config:!1,type:Object,default:{top:100,lefT:100}}),this.register(p.weatherData,{name:"Weather Data",scope:"world",config:!1,type:Object,default:this.createDefaultWeatherData()}),this.register(p.weatherData+"Backup",{name:"Weather Data Backup",scope:"world",config:!1,type:Object,default:null}),this.register(p.noticeVersion,{name:"Version of the last notice displayed",scope:"world",config:!1,type:Array,default:[]}),this.register(p.calendarDisplay,{name:this.gameRef.i18n.localize("wctrl.settings.DisplayWindowNonGM"),hint:this.gameRef.i18n.localize("wctrl.settings.DisplayWindowNonGMHelp"),scope:"world",config:!0,default:!0,type:Boolean}),this.register(p.outputWeatherToChat,{name:this.gameRef.i18n.localize("wctrl.settings.OutputWeatherToChat"),hint:this.gameRef.i18n.localize("wctrl.settings.OutputWeatherToChatHelp"),scope:"world",config:!0,default:!0,type:Boolean}),this.register(p.useCelcius,{name:this.gameRef.i18n.localize("wctrl.settings.useCelcius"),hint:this.gameRef.i18n.localize("wctrl.settings.useCelciusHelp"),scope:"world",config:!0,default:!1,type:Boolean}),this.register(p.playerSeeWeatherInfo,{name:this.gameRef.i18n.localize("wctrl.settings.playerSeeWeather"),hint:this.gameRef.i18n.localize("wctrl.settings.playerSeeWeatherHelp"),scope:"world",config:!0,default:!1,type:Boolean})}createDefaultWeatherData(){const e=o.timestampToDate(n.timestamp());return new y({climate:new f,currentDate:e,lastTemp:null,precipitation:null,temp:null,tempRange:null,version:1})}}function k(e){return Number((5*(e-32)/9).toFixed(1))}class R{constructor(){this.mouseMoveCallback=e=>{this.mouseMove(e)}}start(e,t){this.parent=e,document.addEventListener("mousemove",this.mouseMoveCallback),document.addEventListener("mouseup",(()=>{document.removeEventListener("mousemove",this.mouseMoveCallback),t({top:this.parent.offsetTop,left:this.parent.offsetLeft})}))}mouseMove(e){this.parent.style.top=this.parent.offsetTop+e.movementY+"px",this.parent.style.left=this.parent.offsetLeft+e.movementX+"px",this.parent.style.position="fixed",this.parent.style.zIndex="100"}}class T extends Application{constructor(e,t,i,a,s){super(),this.gameRef=e,this.settings=t,this.weatherTracker=i,this.logger=a,this.renderCompleteCallback=s,this.render(!0)}static get defaultOptions(){const e=super.defaultOptions;return e.template=`modules/${l.u2}/templates/calendar.html`,e.popOut=!1,e.resizable=!1,e}getData(){return{isGM:this.isTimeManipulationEnabled()}}activateListeners(e){this.renderCompleteCallback(),this.initializeWindowInteractions(e),e.find("#date-display").on("mousedown",(e=>{this.toggleDateFormat(e)})),e.find("#start-stop-clock").on("mousedown",(e=>{this.startStopClock(e)})),this.listenToWindowExpand(e),this.listenToWeatherRefreshClick(e),this.setClimate(e),this.listenToClimateChange(e),this.isTimeManipulationEnabled()&&this.listenToTimeSkipButtons(e),t.g[l.S]={},t.g[l.S].resetPosition=()=>this.resetPosition()}updateWeather(e){this.getElementById("current-temperature").innerHTML=this.getTemperature(e),this.getElementById("precipitation").innerHTML=e.precipitation}getTemperature(e){return this.settings.getUseCelcius()?k(e.temp)+" 째C":e.temp+" 째F"}updateClockStatus(){this.isTimeManipulationEnabled()&&(n.clockStatus().started?(this.getElementById("btn-advance_01").classList.add("disabled"),this.getElementById("btn-advance_02").classList.add("disabled"),this.getElementById("time-running").classList.add("isRunning"),this.getElementById("clock-run-indicator").classList.add("isRunning")):(this.getElementById("btn-advance_01").classList.remove("disabled"),this.getElementById("btn-advance_02").classList.remove("disabled"),this.getElementById("time-running").classList.remove("isRunning"),this.getElementById("clock-run-indicator").classList.remove("isRunning")))}updateDateTime(e){document.getElementById("weekday").innerHTML=e.raw.weekdays[e.raw.currentWeekdayIndex],document.getElementById("date").innerHTML=e.display.fullDate,document.getElementById("date-num").innerHTML=e.raw.day+"/"+e.raw.month+"/"+e.raw.year,document.getElementById("calendar-time").innerHTML=e.display.time,this.updateClockStatus()}resetPosition(){const e=this.getElementById("weather-control-container");e&&(this.logger.info("Resetting Window Position"),e.style.top="100px",e.style.left="100px",this.settings.setWindowPosition({top:e.offsetTop,left:e.offsetLeft}),e.style.bottom=null)}listenToWindowExpand(e){this.gameRef.user.isGM||this.settings.getPlayerSeeWeather()||(document.getElementById("weather-toggle").style.display="none"),e.find("#weather-toggle").on("click",(e=>{e.preventDefault(),(this.gameRef.user.isGM||this.settings.getPlayerSeeWeather())&&document.getElementById("weather-control-container").classList.toggle("showWeather")}))}listenToWeatherRefreshClick(e){e.find("#weather-regenerate").on("click",(e=>{e.preventDefault(),this.updateWeather(this.weatherTracker.generate())}))}setClimate(e){var t;const i=(null===(t=this.weatherTracker.getWeatherData().climate)||void 0===t?void 0:t.name)||h.temperate;e.find("#climate-selection").val(i)}listenToClimateChange(e){e.find("#climate-selection").on("change",(e=>{const t=e.originalEvent.target,i=this.weatherTracker.generate(t.value);this.updateWeather(i)}))}getElementById(e){return document.getElementById(e)}toggleDateFormat(e){e.currentTarget.classList.toggle("altFormat")}startStopClock(e){e.preventDefault(),e=e||window.event,n.isPrimaryGM()&&(n.clockStatus().started?(this.logger.debug("Stopping clock"),n.stopClock()):(this.logger.debug("Starting clock"),n.startClock())),this.updateClockStatus()}initializeWindowInteractions(e){const t=e.find("#window-move-handle"),i=t.parents("#weather-control-container").get(0),a=this.settings.getWindowPosition();i.style.top=a.top+"px",i.style.left=a.left+"px",this.windowDragHandler=new R,t.on("mousedown",(()=>{this.windowDragHandler.start(i,(e=>{this.settings.setWindowPosition(e)}))}))}listenToTimeSkipButtons(e){e.find(".advance-btn").on("click",(e=>{const t=e.target.getAttribute("data-increment"),i=e.target.getAttribute("data-unit");n.changeDate({[i]:Number(t)})}))}isTimeManipulationEnabled(){return this.gameRef.user.isGM}}class v{constructor(e){this.gameRef=e}generate(e,t){let i="";const a=[];return e<=3?i=t.isVolcanic?this.gameRef.i18n.localize("wctrl.weather.tracker.normal.Ashen"):this.gameRef.i18n.localize("wctrl.weather.tracker.normal.Clear"):e<=6?t.isVolcanic?(a.push({type:"clouds",options:{density:"13",speed:"29",scale:"34",tint:"#4a4a4a",direction:"50",apply_tint:!0}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.Dark")):(a.push({type:"clouds",options:{density:"13",speed:"29",scale:"34",tint:"#bcbcbc",direction:"50",apply_tint:!0}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.Scattered")):7==e?t.isVolcanic?i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.SunAsh"):t.temp<25?(a.push({type:"clouds",options:{density:"41",speed:"29",scale:"34",tint:"#bcbcbc",direction:"50",apply_tint:!0}}),a.push({type:"snow",options:{density:"30",speed:"31",scale:"17",tint:"#000000",direction:"50",apply_tint:!0}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.Overcast")):t.temp<32?(a.push({type:"clouds",options:{density:"41",speed:"29",scale:"34",tint:"#bcbcbc",direction:"50",apply_tint:!0}}),a.push({type:"rain",options:{density:"19",speed:"50",scale:"31",direction:"50"}}),a.push({type:"snow",options:{density:"30",speed:"31",scale:"17",direction:"50"}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.OvercastLight")):(a.push({type:"clouds",options:{density:"40",speed:"29",scale:"20",tint:"#bcbcbc",direction:"50",apply_tint:!0}}),a.push({type:"rain",options:{density:"40",speed:"50",scale:"30",tint:"#acd2cd",direction:"50",apply_tint:!0}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.OvercastDrizzle")):8==e?t.isVolcanic?(a.push({type:"snow",options:{density:"50",speed:"50",scale:"50",tint:"#000000",direction:"50",apply_tint:!0}}),a.push({type:"embers",options:{density:"50",speed:"50",scale:"50",tint:"#ff1c1c",direction:"50",apply_tint:!0}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.Ashfall")):t.temp<25?(a.push({type:"snow",options:{density:"50",speed:"50",scale:"50",tint:"#ffffff",direction:"50",apply_tint:!0}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.LightSnow")):t.temp<32?(a.push({type:"snow",options:{density:"25",speed:"50",scale:"25",tint:"#ffffff",direction:"50",apply_tint:!0}}),a.push({type:"rain",options:{density:"25",speed:"50",scale:"50",tint:"#acd2cd",direction:"50",apply_tint:!0}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.LightRain")):(a.push({type:"rain",options:{density:"50",speed:"50",scale:"50",tint:"#acd2cd",direction:"50",apply_tint:!0}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.ModerateRainW")):9==e?t.isVolcanic?(a.push({type:"rain",options:{density:"72",speed:"50",scale:"67",tint:"#ff8040",direction:"50",apply_tint:!0}}),a.push({type:"embers",options:{density:"50",speed:"50",scale:"50",tint:"#ff1c1c",direction:"50",apply_tint:!0}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.FireyRain")):t.temp<25?(a.push({type:"snow",options:{density:"72"}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.LargeSnow")):t.temp<32?(a.push({type:"snow",options:{density:"50",speed:"50",scale:"50",tint:"#ffffff",direction:"50",apply_tint:!0}}),a.push({type:"rain",options:{density:"50",speed:"50",scale:"50",tint:"#acd2cd",direction:"50",apply_tint:!0}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.LargeFreezingRain")):(a.push({type:"rain",options:{density:"72",speed:"50",scale:"67",tint:"#acd2cd",direction:"50",apply_tint:!0}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.HeavyRain")):e>=10&&(20==this.rand(1,20)?i=this.extremeWeather(t):t.isVolcanic?(a.push({type:"rain",options:{density:"100",speed:"75",scale:"100",tint:"#ff8040",direction:"50",apply_tint:!0}}),a.push({type:"embers",options:{density:"100",speed:"50",scale:"100",tint:"#ff1c1c",direction:"50",apply_tint:!0}}),a.push({type:"snow",options:{density:"50",speed:"50",scale:"50",tint:"#ffffff",direction:"50",apply_tint:!0}}),a.push({type:"clouds",options:{density:"50",speed:"8",scale:"50",tint:"#d2e8ce",direction:"50",apply_tint:!0}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.Earthquake")):t.temp<25?(a.push({type:"snow",options:{density:"100",speed:"75",scale:"100",tint:"#ffffff",direction:"50",apply_tint:!0}}),a.push({type:"clouds",options:{density:"50",speed:"50",scale:"50",direction:"50"}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.Blizzard")):t.temp<32?(a.push({type:"snow",options:{density:"50",speed:"50",scale:"50",tint:"#ffffff",direction:"50",apply_tint:!0}}),a.push({type:"rain",options:{density:"83",speed:"17",scale:"100",tint:"#ffffff",direction:"50",apply_tint:!0}}),a.push({type:"clouds",options:{density:"50",speed:"50",scale:"50",direction:"50"}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.Icestorm")):(a.push({type:"rain",options:{density:"100",speed:"75",scale:"100",tint:"#acd2cd",direction:"50",apply_tint:!0}}),a.push({type:"rain",options:{density:"100",speed:"75",scale:"100",tint:"#acd2cd",direction:"50",apply_tint:!0}}),a.push({type:"clouds",options:{density:"50",speed:"50",scale:"50",direction:"50"}}),i=this.gameRef.i18n.localize("wctrl.weather.tracker.normal.TorrentialRain"))),i}extremeWeather(e){const t=this.rand(1,5);let i="";if(e.isVolcanic)return this.gameRef.i18n.localize("wctrl.weather.tracker.extreme.VolcanoEruption");switch(t){case 1:i=this.gameRef.i18n.localize("wctrl.weather.tracker.extreme.Tornado");break;case 2:i=this.gameRef.i18n.localize("wctrl.weather.tracker.extreme.Hurricane");break;case 3:i=this.gameRef.i18n.localize("wctrl.weather.tracker.extreme.Drought");break;case 4:i=this.gameRef.i18n.localize("wctrl.weather.tracker.extreme.BaseballHail");break;case 5:i=e.temp<=32?this.gameRef.i18n.localize("wctrl.weather.tracker.extreme.Blizzard"):this.gameRef.i18n.localize("wctrl.weather.tracker.extreme.Monsoon")}return this.gameRef.i18n.localize("wctrl.weather.tracker.extreme.Extreme")+i}rand(e,t){return Math.floor(Math.random()*(t-e+1)+e)}}class W{constructor(e,t,i){this.gameRef=e,this.chatProxy=t,this.settings=i,this.precipitations=new v(this.gameRef)}getWeatherData(){return this.weatherData}setWeatherData(e){this.weatherData=e,this.settings.setWeatherData(e)}generate(e){return this.weatherData.climate||(this.weatherData.climate=this.getClimateData(h.temperate)),this.setTemperatureRange(),e?(this.weatherData.climate=this.getClimateData(e),this.weatherData.temp=this.randAroundValue(this.weatherData.lastTemp||this.rand(0,20),5)+this.weatherData.climate.baseTemperature+(20===this.rand(1,20)?20:0)):3===this.rand(1,3)?this.weatherData.temp=this.rand(40,70)+this.weatherData.climate.baseTemperature:this.weatherData.temp=this.randAroundValue(this.weatherData.lastTemp,5)+Math.floor(this.weatherData.climate.baseTemperature/20),this.weatherData.lastTemp>this.weatherData.tempRange.max?this.weatherData.temp=this.rand(this.weatherData.lastTemp-10,this.weatherData.lastTemp-5):this.weatherData.lastTemp<this.weatherData.tempRange.min&&(this.weatherData.temp=this.rand(this.weatherData.lastTemp+5,this.weatherData.lastTemp+10)),this.weatherData.lastTemp=this.weatherData.temp,this.weatherData.precipitation=this.precipitations.generate(this.rand(1,20),this.weatherData),this.settings.getOutputWeatherToChat()&&this.output(),this.setWeatherData(this.weatherData),this.weatherData}setTemperatureRange(){void 0===this.weatherData.tempRange&&(this.weatherData.tempRange={max:90,min:-20})}getTemperature(){return this.settings.getUseCelcius()?k(this.weatherData.temp)+" 째C":this.weatherData.temp+" 째F"}output(){let e=null;this.settings.getOutputWeatherToChat()||(e=this.chatProxy.getWhisperRecipients("GM")[0].id);const t="<b>"+this.getTemperature()+"</b> - "+this.weatherData.precipitation;this.chatProxy.create({speaker:{alias:this.gameRef.i18n.localize("wctrl.weather.tracker.Today")},whisper:[e],content:t})}rand(e,t){return Math.floor(Math.random()*(t-e+1)+e)}randAroundValue(e,t){return this.rand(e-t,e+t)}getClimateData(e){const t=new f;switch(t.isVolcanic=!1,t.name=e,e){case h.temperate:t.humidity=0,t.baseTemperature=0,t.temperatureRange={max:100,min:-5};break;case h.temperateMountain:t.humidity=0,t.baseTemperature=-10,t.temperatureRange={max:75,min:-40};break;case h.desert:t.humidity=-4,t.baseTemperature=20,t.temperatureRange={max:134,min:50};break;case h.tundra:t.humidity=0,t.baseTemperature=-20,t.temperatureRange={max:30,min:-60};break;case h.tropical:t.humidity=1,t.baseTemperature=20,t.temperatureRange={max:100,min:60};break;case h.taiga:t.humidity=-1,t.baseTemperature=-20,t.temperatureRange={max:70,min:-65};break;case h.volcanic:t.humidity=0,t.baseTemperature=40,t.isVolcanic=!0,t.temperatureRange={max:170,min:70};break;case h.polar:t.humidity=0,t.baseTemperature=-50,t.temperatureRange={max:10,min:-170}}return t}}class b{constructor(e,t,i,a){this.gameRef=e,this.chatProxy=t,this.logger=i,this.settings=a,this.weatherTracker=new W(this.gameRef,this.chatProxy,this.settings),this.logger.info("Init completed")}isUserGM(){return this.gameRef.user.isGM}async onReady(){await this.initializeWeatherData(),this.initializeWeatherApplication()}onDateTimeChange(e){let t=this.mergePreviousDateTimeWithNewOne(e);this.hasDateChanged(e)&&(this.logger.info("DateTime has changed"),this.weatherTracker.setWeatherData(t),this.isUserGM()&&(this.logger.info("Generate new weather"),t=this.weatherTracker.generate())),this.isUserGM()&&this.weatherTracker.setWeatherData(t),this.isWeatherApplicationAvailable()&&(this.logger.debug("Update weather display"),this.updateWeatherDisplay(e))}onClockStartStop(){this.isWeatherApplicationAvailable()&&this.weatherApplication.updateClockStatus()}resetWindowPosition(){this.isWeatherApplicationAvailable()&&this.weatherApplication.resetPosition()}isWeatherApplicationAvailable(){return this.settings.getCalendarDisplay()||this.isUserGM()}async initializeWeatherData(){let e=this.settings.getWeatherData();this.isWeatherDataValid(e)?(this.logger.info("Using saved weather data",e),this.weatherTracker.setWeatherData(e)):this.isUserGM()&&(this.logger.info("No saved weather data - Generating weather"),e.currentDate=o.timestampToDate(n.timestamp()),this.weatherTracker.setWeatherData(e),e=this.weatherTracker.generate(h.temperate),await this.settings.setWeatherData(e))}initializeWeatherApplication(){this.isWeatherApplicationAvailable()&&(this.weatherApplication=new T(this.gameRef,this.settings,this.weatherTracker,this.logger,(()=>{const e=this.settings.getWeatherData();this.weatherApplication.updateDateTime(e.currentDate),this.weatherApplication.updateWeather(e)})))}mergePreviousDateTimeWithNewOne(e){return Object.assign({},this.weatherTracker.getWeatherData(),{currentDate:e})}hasDateChanged(e){var t;const i=null===(t=this.weatherTracker.getWeatherData().currentDate)||void 0===t?void 0:t.raw,a=e.raw;return!(!this.isDateTimeValid(e.raw)||a.day===i.day&&a.month===i.month&&a.year===i.year)}isDateTimeValid(e){return!!(this.isDefined(e.second)&&this.isDefined(e.minute)&&this.isDefined(e.day)&&this.isDefined(e.month)&&this.isDefined(e.year))}isDefined(e){return null!=e}isWeatherDataValid(e){return!!e.temp}updateWeatherDisplay(e){this.weatherApplication.updateDateTime(e),this.weatherApplication.updateWeather(this.weatherTracker.getWeatherData())}}const C=new class{constructor(){this.messagePrefix=l.TN+" | ",this.checkLevel=()=>c.ERROR}registerLevelCheckCallback(e){this.checkLevel=e}info(e,...t){this.checkLevel()>=c.INFO&&console.info(this.messagePrefix+e,...t)}error(e,...t){this.checkLevel()>=c.ERROR&&console.error(this.messagePrefix+e,...t)}debug(e,...t){this.checkLevel()>=c.DEBUG&&console.debug(this.messagePrefix+e,...t)}warn(e,...t){this.checkLevel()>=c.WARN&&console.warn(this.messagePrefix+e,...t)}log(e,...t){this.checkLevel()>=c.ALL&&console.log(this.messagePrefix+e,...t)}},S=new class{create(e){ChatMessage.create(e)}getWhisperRecipients(e){return ChatMessage.getWhisperRecipients(e)}};let x;function M(){if(!(game instanceof Game))throw new Error("Game is not initialized yet!");return game}Hooks.once("devModeReady",(({registerPackageDebugFlag:e})=>{e("weather-control","level");const t=M().modules.get("_dev-mode");try{C.registerLevelCheckCallback((()=>{var e;return null===(e=null==t?void 0:t.api)||void 0===e?void 0:e.getPackageDebugValue("weather-control","level")}))}catch(e){}})),Hooks.once("ready",(()=>{!function(){if(!function(){const e="v1.3.73",t=M().modules.get("foundryvtt-simple-calendar").data.version;return m.isMoreRecent(t,e)||t===e}()){const e="Weather Control cannot initialize and requires Simple Calendar v1.3.73. Make sure the latest version of Simple Calendar is installed.";console.error(e),ui.notifications.error(e)}}()})),Hooks.once("simple-calendar-ready",(()=>{!function(){const t=new D(M());var i;(function(e){M().user.isGM&&new u(M(),e).checkForNotices()})(t),(i=t,new Promise((e=>{const t=new g(C);t.register(new w);const a=i.getWeatherData(),s=t.run(a.version,a);s?(C.info("Saving migrated data"),i.setWeatherData(s).then((()=>{e()}))):e()}))).then((()=>{x=new b(M(),S,C,t),Hooks.on(e.DateTimeChange,(({...e})=>{x.onDateTimeChange(o.createDateObject(e.date))})),Hooks.on(e.ClockStartStop,(()=>{x.onClockStartStop()})),x.onReady()}))}()}))})();