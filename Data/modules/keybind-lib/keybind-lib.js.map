{"version":3,"file":"keybind-lib.js","sources":["../src/configurator.ts","../src/key-utils.ts","../src/keybind-lib.ts"],"sourcesContent":["export class KeybindConfigurator extends FormApplication {\n  constructor() {\n    super(null);\n  }\n\n  get element(): JQuery<HTMLElement> {\n    return super.element as JQuery<HTMLElement>;\n  }\n\n  static get defaultOptions(): FormApplication.Options {\n    return {\n      ...super.defaultOptions,\n      title: \"Keybinds\",\n      id: \"keybind-configurator\",\n      template: \"modules/keybind-lib/templates/configurator.hbs\",\n      resizable: false,\n      width: 600,\n      closeOnSubmit: false,\n      submitOnChange: false,\n      submitOnClose: false,\n    };\n  }\n\n  getData(): any {\n    const data = {\n      modules: [],\n    };\n    for (const [\n      name,\n      registeredBind,\n    ] of globalThis.KeybindLib.registeredBinds.entries()) {\n      const [moduleName, bindName] = name.split(\".\");\n      let moduleData = data.modules.find((m) => m.name == moduleName);\n      if (!moduleData) {\n        moduleData = {\n          name: moduleName,\n          title: (game.modules.get(moduleName).data as any).title,\n          binds: [],\n        };\n        data.modules.push(moduleData);\n      }\n\n      moduleData.binds.push({\n        bindName,\n        ...registeredBind.options,\n        key: registeredBind.keyBind.toString(),\n      });\n    }\n\n    return data;\n  }\n\n  resetSetting(fullName: string): string {\n    const [moduleName, bindName] = fullName.split(\".\");\n    const defaultSetting = game.settings.settings.get(fullName)\n      .default as string;\n    if (defaultSetting) {\n      game.settings.set(moduleName, bindName, defaultSetting);\n    }\n    return defaultSetting;\n  }\n\n  activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n    this.element\n      .find(\"input\")\n      .on(\"keydown\", (evt) =>\n        globalThis.KeybindLib._handleConfigInput(evt, html)\n      );\n\n    this.element.find(`button[name=\"reset\"]`).on(\"click\", () => {\n      const formData = this._getSubmitData();\n\n      for (const fullName of Object.keys(formData)) {\n        this.resetSetting(fullName);\n      }\n      this.render(true);\n    });\n\n    this.element.find(\".fa-undo[data-bind]\").on(\"click\", (evt) => {\n      const fullName = evt.target.dataset[\"bind\"];\n      if (!fullName) return;\n      const val = this.resetSetting(fullName);\n      this.element.find(`input[name=\"${fullName}\"]`).val(val);\n      globalThis.KeybindLib._resolveConflicts(html);\n    });\n\n    globalThis.KeybindLib._resolveConflicts(html);\n  }\n\n  async _updateObject(\n    event: unknown,\n    formData: { [fullName: string]: unknown }\n  ): Promise<void> {\n    for (const [fullName, value] of Object.entries(formData)) {\n      const [moduleName, bindName] = fullName.split(\".\");\n      game.settings.set(moduleName, bindName, value);\n    }\n    this.render(true);\n  }\n}\n","export class KeySequence {\n  sequence: KeyEvent[];\n}\n\n// Modifiers show up as the key code if no other key is pressed\nconst extraKeys = [\n  \"Unidentified\",\n  \"AltLeft\",\n  \"ControlLeft\",\n  \"ControlRight\",\n  \"MetaLeft\",\n  \"MetaRight\",\n  \"OSLeft\",\n  \"OSRight\",\n  \"ShiftLeft\",\n  \"ShiftRight\",\n  \"F5\",\n];\n\n// Map between names and props\nconst modifiers = [\n  [\"ctrlKey\", \"Ctrl\"],\n  [\"shiftKey\", \"Shift\"],\n  [\"metaKey\", \"Meta\"],\n  [\"altKey\", \"Alt\"],\n];\n\ninterface KeyEventObject {\n  key: string;\n  altKey?: boolean;\n  ctrlKey?: boolean;\n  shiftKey?: boolean;\n  metaKey?: boolean;\n  originalEvent?: KeyboardEvent;\n}\n\nconst allowedKeyPattern = /^[A-Z]\\w+$/;\nfunction checkKeyAllowed(key: string) {\n  if (key === \"Unidentified\") {\n    throw new Error(`Key \"Unidentified\" is not allowed`);\n  }\n  if (!allowedKeyPattern.test(key)) {\n    throw new Error(\n      `Unexpected key format \"${key}\". Key is required to be a modifier (Ctrl|Shift|Meta|Alt) ` +\n        `or in KeyboardEvent.code format: https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/code`\n    );\n  }\n}\n\nexport class KeyEvent {\n  key: string;\n  altKey = false;\n  ctrlKey = false;\n  shiftKey = false;\n  metaKey = false;\n  originalEvent?: KeyboardEvent;\n\n  static fromObject(keyEventObject: KeyEventObject): KeyEvent {\n    if (!keyEventObject.key) {\n      throw new Error(`Object is missing \"key\" property`);\n    }\n    checkKeyAllowed(keyEventObject.key);\n\n    const keyEvent = new KeyEvent();\n    keyEvent.key = keyEventObject.key;\n    keyEvent.altKey = !!keyEventObject.altKey;\n    keyEvent.ctrlKey = !!keyEventObject.ctrlKey;\n    keyEvent.shiftKey = !!keyEventObject.shiftKey;\n    keyEvent.metaKey = !!keyEventObject.metaKey;\n    keyEvent.originalEvent = keyEventObject.originalEvent || null;\n    return keyEvent;\n  }\n\n  // Create a new KeyEvent from a source event\n  static fromEvent(event: JQuery.KeyboardEventBase | KeyboardEvent): KeyEvent {\n    if (isJQueryEvent(event)) {\n      event = event.originalEvent;\n    }\n    if (extraKeys.includes(event.code)) {\n      return null;\n    }\n\n    const keyEvent = new KeyEvent();\n    keyEvent.originalEvent = event;\n    keyEvent.altKey = event.altKey;\n    keyEvent.ctrlKey = event.ctrlKey;\n    keyEvent.shiftKey = event.shiftKey;\n    keyEvent.metaKey = event.metaKey;\n    keyEvent.key = event.code;\n\n    return keyEvent;\n  }\n\n  static fromString(str: string): KeyEvent {\n    if (!str) return null;\n\n    const pieces = str.split(\"+\").map((key) => key.trim());\n    const keyEvent = new KeyEvent();\n\n    for (const piece of pieces) {\n      checkKeyAllowed(piece);\n\n      const mod = modifiers.find(([, name]) => name === piece);\n      if (mod) {\n        keyEvent[mod[0]] = true;\n      } else if (keyEvent.key) {\n        throw new Error(\n          \"More than one non-modifier detected in key combination\"\n        );\n      } else {\n        keyEvent.key = piece;\n      }\n    }\n\n    return keyEvent;\n  }\n\n  toString(): string {\n    const keys = modifiers.filter(([mod]) => this[mod]).map(([, name]) => name);\n    if (this.key) {\n      keys.push(this.key);\n    }\n    return keys.join(\" + \");\n  }\n\n  static getEvent(event: AnyEventFormat): KeyEvent {\n    if (event instanceof KeyEvent) return event;\n\n    if (\n      event?.constructor?.name == \"KeyboardEvent\" ||\n      event[\"originalEvent\"] ||\n      event[\"code\"]\n    ) {\n      return KeyEvent.fromEvent(event as KeyboardEvent);\n    }\n    if (typeof event === \"string\") {\n      return KeyEvent.fromString(event);\n    }\n    console.log(event);\n  }\n\n  equals(keyEvent: KeyEvent): boolean {\n    if (!keyEvent) return false;\n    return (\n      this.altKey == keyEvent.altKey &&\n      this.ctrlKey == keyEvent.ctrlKey &&\n      this.shiftKey == keyEvent.shiftKey &&\n      this.metaKey == keyEvent.metaKey &&\n      this.key == keyEvent.key\n    );\n  }\n}\n// TODO: Support KeyEventObject interface?\nexport type AnyEventFormat =\n  | KeyEvent\n  | string\n  | JQuery.KeyboardEventBase\n  | KeyboardEvent;\n\nexport function matchEvent(\n  event1: AnyEventFormat,\n  event2: AnyEventFormat\n): boolean {\n  const keyEvent1 = KeyEvent.getEvent(event1);\n  const keyEvent2 = KeyEvent.getEvent(event2);\n  if (keyEvent1 === null || keyEvent1 === null) return;\n  return keyEvent1?.equals(keyEvent2);\n}\n\n// Type utils\nexport function isJQueryEvent(\n  event: JQuery.KeyboardEventBase | KeyboardEvent\n): event is JQuery.KeyboardEventBase {\n  return !!event[\"originalEvent\"];\n}\n","import { KeybindConfigurator } from \"./configurator\";\nimport { KeyEvent, AnyEventFormat, matchEvent } from \"./key-utils\";\n\ninterface RegistrationOptions {\n  name?: string;\n  hint?: string;\n  default?: AnyEventFormat;\n  config?: boolean;\n  onKeyDown?: (evt: KeyEvent) => void;\n  onKeyUp?: (evt: KeyEvent) => void;\n  scope?: \"client\" | \"world\";\n  type?;\n}\n\nclass RegisteredKeybind {\n  moduleName: string;\n  bindName: string;\n\n  options: RegistrationOptions;\n  fullName: string;\n\n  public get keyBind(): KeyEvent {\n    const setting = game.settings.get(this.moduleName, this.bindName) as string;\n    if (setting) {\n      return KeyEvent.fromString(setting);\n    }\n  }\n\n  constructor(moduleName, bindName, options: RegistrationOptions) {\n    this.moduleName = moduleName;\n    this.bindName = bindName;\n    this.fullName = `${moduleName}.${bindName}`;\n    this.options = { ...options };\n    delete this.options.name;\n  }\n}\n\nconst defaultOptions: RegistrationOptions = {\n  scope: \"client\",\n  config: false,\n  type: String,\n};\n\nclass KeybindLib {\n  static registeredBinds = new Map<string, RegisteredKeybind>();\n\n  static isBoundTo(\n    evt: AnyEventFormat,\n    moduleName: string,\n    bindName: string\n  ): boolean {\n    const bind = this.registeredBinds.get(`${moduleName}.${bindName}`);\n    if (!bind) return false;\n    return matchEvent(evt, bind.keyBind);\n  }\n\n  static register(\n    moduleName: string,\n    bindName: string,\n    options: RegistrationOptions\n  ): void {\n    if (!game.modules.get(moduleName) && moduleName !== game.system.id) {\n      throw new Error(`Module or system does not exist: ${moduleName}`);\n    }\n    const fullName = `${moduleName}.${bindName}`;\n    const opt = { ...defaultOptions, ...options, fullName };\n\n    if (this.registeredBinds.has(fullName))\n      throw new Error(\n        `Keybind already registered, module: ${moduleName}, bindName: ${bindName}`\n      );\n\n    const setting = game.settings.settings.get(`${moduleName}.${bindName}`);\n    if (setting) {\n      if (setting.type != String) {\n        throw new Error(\n          `Keybind Lib | Setting for keybind already registered, needs to be String. Incorrect type: ${setting.type}, module: ${moduleName}, bindName: ${bindName}`\n        );\n      }\n      console.info(\n        `Keybind Lib | Setting for keybind already registered, will be used; module: ${moduleName}, bindName: ${bindName}`\n      );\n    } else {\n      game.settings.register(moduleName, bindName, {\n        ...(options as ClientSettings.PartialSetting),\n        type: String,\n      });\n    }\n\n    this.registeredBinds.set(\n      fullName,\n      new RegisteredKeybind(moduleName, bindName, opt)\n    );\n  }\n\n  // UI methods for configurator conflicts\n  static _resolveConflicts(html: JQuery): void {\n    // Reset visuals\n    const inputs = html.find(\".keybind-input\") as JQuery<HTMLInputElement>;\n    inputs.removeClass(\"keybind-conflict\");\n    inputs.parent().find(\".conflict-info\").detach();\n\n    // Collect all on-screen inputs\n    const values: { [key: string]: KeyEvent } = {};\n    inputs.each(function () {\n      values[this.getAttribute(\"name\")] = KeyEvent.fromString(this.value);\n    });\n\n    // Collect all off-screen keybinds\n    // KeybindLib.registeredBinds.entries();\n    // for (const [fullName, reg] of KeybindLib.registeredBinds.entries()) {\n    //   if (!values[fullName]) {\n    //     values[fullName] = reg.keyBind;\n    //   }\n    // }\n\n    // Find all conflicts\n    const vals = Object.entries(values);\n    const conflicts: { [fn: string]: string[] } = {};\n    vals.forEach(([fn, e]) => {\n      for (const [fn2, e2] of vals) {\n        if (fn != fn2 && e.equals(e2)) {\n          conflicts[fn] = conflicts[fn] || [];\n          conflicts[fn].push(fn2);\n        }\n      }\n    });\n\n    // Modify DOM\n    Object.entries(conflicts).forEach(([fn, conflicts]) => {\n      const input = $(html).find(\n        `input[name=\"${fn}\"]`\n      ) as JQuery<HTMLInputElement>;\n\n      if (input.length == 0) return;\n\n      const conflictTitles = conflicts.map(\n        (fn) => KeybindLib.registeredBinds.get(fn).options.name\n      );\n\n      let conflictText = conflictTitles\n        .map((title) => game.i18n.localize(title))\n        .join(\", \");\n      conflictText = game.i18n.format(\"KEYBINDLIB.ConflictsWith\", {\n        conflicts: conflictText,\n      });\n      input.addClass(\"keybind-conflict\");\n      input.after(`<span class=\"hint conflict-info\">${conflictText}</span>`);\n    });\n  }\n\n  static _handleConfigInput(evt: JQuery.KeyboardEventBase, html: JQuery): void {\n    const keyEvent = KeyEvent.fromEvent(evt);\n    if (!keyEvent) return;\n    evt.preventDefault();\n    evt.stopPropagation();\n    evt.target.value = keyEvent.toString();\n    this._resolveConflicts(html);\n  }\n\n  private static _onKeyDown(evt: KeyboardEvent): void {\n    const keyEvent = KeyEvent.fromEvent(evt);\n    if (!keyEvent) return;\n    for (const [bindName, bind] of this.registeredBinds.entries()) {\n      if (bind.keyBind.equals(keyEvent)) {\n        console.log(\"Keybind Lib | Key down\", bindName);\n        bind.options?.onKeyDown?.(keyEvent);\n      }\n    }\n  }\n\n  private static _onKeyUp(evt: KeyboardEvent): void {\n    const keyEvent = KeyEvent.fromEvent(evt);\n    if (!keyEvent) return;\n    for (const [bindName, bind] of this.registeredBinds.entries()) {\n      if (bind.keyBind.equals(keyEvent)) {\n        console.log(\"Keybind Lib | Key up\", bindName);\n        bind.options?.onKeyUp?.(keyEvent);\n      }\n    }\n  }\n\n  static _registerEventListeners(): void {\n    document.addEventListener(\"keydown\", this._onKeyDown.bind(KeybindLib));\n    document.addEventListener(\"keyup\", this._onKeyUp.bind(KeybindLib));\n  }\n}\n\nfunction registerMenu(): void {\n  if (KeybindLib.registeredBinds.size === 0) return;\n\n  let bindsNotInConfig = false;\n  KeybindLib.registeredBinds.forEach(\n    (bind) => (bindsNotInConfig = bindsNotInConfig || !bind.options.config)\n  );\n\n  if (!bindsNotInConfig) return;\n\n  game.settings.registerMenu(\"keybind-lib\", \"keybinds\", {\n    name: \"KEYBINDLIB.MenuName\",\n    label: \"KEYBINDLIB.MenuLabel\",\n    icon: \"fas fa-keyboard\",\n    type: KeybindConfigurator,\n    restricted: false,\n  });\n}\n\nHooks.on(\"ready\", () => {\n  KeybindLib._registerEventListeners();\n\n  // Allow time for modules to register if they use the ready hook\n  setTimeout(registerMenu, 200);\n});\n\nHooks.on(\"renderSettingsConfig\", (app, html: JQuery<HTMLElement>) => {\n  for (const [fullName] of KeybindLib.registeredBinds.entries()) {\n    const input = $(html).find(\n      `input[name=\"${fullName}\"]`\n    ) as JQuery<HTMLInputElement>;\n    input.attr(\"readonly\", \"true\");\n    input.addClass(\"keybind-input\");\n    input.parent().addClass(\"keybind-fields\");\n    input\n      .parent()\n      .append(`<i class=\"far fa-keyboard keybind-lib-settings-icon\"></i>`);\n    input.on(\"keydown\", (evt) => KeybindLib._handleConfigInput(evt, html));\n  }\n\n  KeybindLib._resolveConflicts(html);\n});\n\nglobalThis.KeybindLib = KeybindLib;\nexport { KeybindLib };\n\nif (__buildEnv__ != \"production\") {\n  import(\"../test/unit/tests\").then((tests) => tests.registerTests());\n}\n"],"names":[],"mappings":"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"}