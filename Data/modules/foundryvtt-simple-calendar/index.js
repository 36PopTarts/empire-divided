(()=>{var e={162:function(e,t,a){var n,s;void 0===(s="function"==typeof(n=function(){"use strict";function t(e,t,a){var n=new XMLHttpRequest;n.open("GET",e),n.responseType="blob",n.onload=function(){o(n.response,t,a)},n.onerror=function(){console.error("could not download file")},n.send()}function n(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(e){}return 200<=t.status&&299>=t.status}function s(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(a){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var i="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof a.g&&a.g.global===a.g?a.g:void 0,r=i.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),o=i.saveAs||("object"!=typeof window||window!==i?function(){}:"download"in HTMLAnchorElement.prototype&&!r?function(e,a,r){var o=i.URL||i.webkitURL,c=document.createElement("a");a=a||e.name||"download",c.download=a,c.rel="noopener","string"==typeof e?(c.href=e,c.origin===location.origin?s(c):n(c.href)?t(e,a,r):s(c,c.target="_blank")):(c.href=o.createObjectURL(e),setTimeout((function(){o.revokeObjectURL(c.href)}),4e4),setTimeout((function(){s(c)}),0))}:"msSaveOrOpenBlob"in navigator?function(e,a,i){if(a=a||e.name||"download","string"!=typeof e)navigator.msSaveOrOpenBlob(function(e,t){return void 0===t?t={autoBom:!1}:"object"!=typeof t&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e}(e,i),a);else if(n(e))t(e,a,i);else{var r=document.createElement("a");r.href=e,r.target="_blank",setTimeout((function(){s(r)}))}}:function(e,a,n,s){if((s=s||open("","_blank"))&&(s.document.title=s.document.body.innerText="downloading..."),"string"==typeof e)return t(e,a,n);var o="application/octet-stream"===e.type,c=/constructor/i.test(i.HTMLElement)||i.safari,l=/CriOS\/[\d]+/.test(navigator.userAgent);if((l||o&&c||r)&&"undefined"!=typeof FileReader){var h=new FileReader;h.onloadend=function(){var e=h.result;e=l?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),s?s.location.href=e:location=e,s=null},h.readAsDataURL(e)}else{var d=i.URL||i.webkitURL,m=d.createObjectURL(e);s?s.location=m:location.href=m,s=null,setTimeout((function(){d.revokeObjectURL(m)}),4e4)}});i.saveAs=o.saveAs=o,e.exports=o})?n.apply(t,[]):n)||(e.exports=s)},983:e=>{"use strict";e.exports='<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="16.217882" cy="42.249027" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(-24)" /><path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="m 31.651447,14.498703 c 0.04016,34.977641 0.01944,27.709462 0.04016,34.977641 9.74162,0.07836 17.711025,-7.738374 17.821085,-17.479687 C 49.412665,22.232359 41.41574,14.398087 31.651447,14.498703 Z"/></svg>\n'},395:e=>{"use strict";e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="17.5" fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>\n'},764:e=>{"use strict";e.exports='<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="-16.217882" cy="-42.249027" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(156)" /><path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="m 32.348553,49.501297 c -0.04016,-34.977641 -0.01944,-27.709462 -0.04016,-34.977641 -9.74162,-0.07836 -17.711025,7.738374 -17.821085,17.479687 0.100027,9.764298 8.096952,17.59857 17.861245,17.497954 z"/></svg>\n'},705:e=>{"use strict";e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>\n'},726:e=>{"use strict";e.exports='<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="42.249027" cy="16.217882" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(24)" /><path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="m 34.422458,49.301058 c -15.451442,-6.354 -15.456399,-28.248933 0.0034,-34.599957 v 0 l 0.09749,-0.02227 a 18.38,18.38 0 0 0 -2.524032,-0.182384 17.508125,17.508125 45 1 0 -0.0026,35.016249 18.21,18.21 0 0 0 2.521223,-0.180096 z"/></svg>\n'},634:e=>{"use strict";e.exports='<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="42.249027" cy="16.217882" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(24)" /><path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M 38.163354,44.316704 C 30.937776,37.984029 30.507493,28.490768 36.581412,21.046356 39.089436,18.621787 39.94547,18.422461 41.135375,17.578924 33.984048,12.487765 24.11729,13.768992 18.50341,20.51775 c -6.096193,7.464693 -5.157206,18.422603 2.120091,24.741318 5.853103,5.207431 14.525266,5.687523 20.917408,1.15799 z"/></svg>\n'},693:e=>{"use strict";e.exports='<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="-42.249027" cy="-16.217882" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(-156)" /><path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="m 29.577542,14.698942 c 15.451442,6.354 15.456399,28.248933 -0.0034,34.599957 v 0 l -0.09749,0.02227 a -18.38,-18.38 0 0 0 2.524032,0.182384 17.508125,17.508125 0 1 0 0.0026,-35.016249 -18.21,-18.21 0 0 0 -2.521223,0.180096 z"/></svg>\n'},559:e=>{"use strict";e.exports='<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="-42.249027" cy="-16.217882" r="17.5" fill="#000000" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(-156)" /><path fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="m 25.836646,19.683296 c 7.225578,6.332675 7.655861,15.825936 1.581942,23.270348 -2.508024,2.424569 -3.364058,2.623895 -4.553963,3.467432 7.151327,5.091159 17.018085,3.809932 22.631965,-2.938826 6.096193,-7.464693 5.157206,-18.422603 -2.120091,-24.741318 -5.853103,-5.207431 -14.525266,-5.687523 -20.917408,-1.15799 z"/></svg>\n'}},t={};function a(n){var s=t[n];if(void 0!==s)return s.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,a),i.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{"use strict";class e{static info(e){e&&console.info("%cSimple Calendar","color:blue;",` | ${e}`)}static warn(e){e&&console.warn("%cSimple Calendar","color:orange;",` | ${e}`)}static error(e){e instanceof Error?console.error("%cSimple Calendar","color:red;",` | Error "${e.message}"\n${e.stack}`):console.error("%cSimple Calendar","color:red;",` | ${e}`)}static debug(t){t&&e.debugMode&&console.debug("%cSimple Calendar","color:green;",` | ${t}`)}}e.debugMode=!1;const t="foundryvtt-simple-calendar",n=`module.${t}`;var s,i,r,o,c,l,h,d,m,u,y,g,p,f;!function(e){e.CalendarConfigurationMenu="calendar-configuration-menu",e.YearConfiguration="year-config",e.WeekdayConfiguration="weekday-config",e.MonthConfiguration="month-config",e.CurrentDate="current-date",e.Notes="notes",e.AllowPlayersToAddNotes="allow-players-add-notes",e.DefaultNoteVisibility="default-note-visibility",e.LeapYearRule="leap-year-rule",e.TimeConfiguration="time-configuration",e.GeneralConfiguration="general-configuration",e.SeasonConfiguration="season-configuration",e.MoonConfiguration="moon-configuration",e.NoteCategories="note-categories"}(s||(s={})),function(e){e.Gregorian="gregorian",e.DarkSun="darksun",e.Eberron="eberron",e.Exandrian="exandrian",e.ForbiddenLands="forbidden-lands",e.Harptos="harptos",e.GolarianPF1E="golarianpf1e",e.GolarianPF2E="golarianpf2e",e.Greyhawk="greyhawk",e.TravellerImperialCalendar="traveller-ic",e.WarhammerImperialCalendar="warhammer"}(i||(i={})),function(e){e[e.Never=0]="Never",e[e.Weekly=1]="Weekly",e[e.Monthly=2]="Monthly",e[e.Yearly=3]="Yearly"}(r||(r={})),function(e){e.None="none",e.Start="start",e.End="end",e.Middle="mid",e.Exact="exact"}(o||(o={})),function(e){e.None="none",e.Gregorian="gregorian",e.Custom="custom"}(c||(c={})),function(e){e.Default="default",e.Repeat="repeat",e.Random="random"}(l||(l={})),function(e){e.primary="primary",e.time="time",e.checkClockRunning="check-clock-running",e.journal="journal",e.dateTime="date-time",e.date="date",e.noteReminders="note-reminder",e.emitHook="emit-hook"}(h||(h={})),function(e){e.None="none",e.Self="self",e.ThirdParty="third-party",e.Mixed="mixed"}(d||(d={})),function(e){e.NewMoon="new",e.WaxingCrescent="waxing-crescent",e.FirstQuarter="first-quarter",e.WaxingGibbous="waxing-gibbous",e.Full="full",e.WaningGibbous="waning-gibbous",e.LastQuarter="last-quarter",e.WaningCrescent="waning-crescent"}(m||(m={})),function(e){e.None="none",e.LeapYear="leap-year",e.XYears="x-years"}(u||(u={})),function(e){e.Midnight="midnight",e.Sunrise="sunrise",e.Midday="midday",e.Sunset="sunset"}(y||(y={})),function(e){e.DnD5E="dnd5e",e.PF1E="pf1",e.PF2E="pf2e",e.WarhammerFantasy4E="wfrp4e",e.Other="other"}(g||(g={})),function(e){e.DateTimeChange="simple-calendar-date-time-change",e.ClockStartStop="simple-calendar-clock-start-stop",e.PrimaryGM="simple-calendar-primary-gm",e.Ready="simple-calendar-ready"}(p||(p={})),function(e){e.Started="started",e.Stopped="stopped",e.Paused="paused"}(f||(f={}));var C=a(983),D=a(395),b=a(764),w=a(705),v=a(726),S=a(634),M=a(693),N=a(559);class T{static generateUniqueId(){return window.crypto.getRandomValues(new Uint32Array(1))[0].toString(16)}static randomHash(e){let t=0;if(0==e.length)return t;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a),t&=t;return t}static ordinalSuffix(e){return[void 0,$.Localize("FSC.OrdinalSuffix.st"),$.Localize("FSC.OrdinalSuffix.nd"),$.Localize("FSC.OrdinalSuffix.rd")][e%100>>3^1&&e%10]||$.Localize("FSC.OrdinalSuffix.th")}static compareSemanticVersions(e,t){const a=e.split("."),n=t.split("."),s=Math.max(a.length,n.length);for(let e=0;e<s;e++){if(a[e]&&!n[e]&&parseInt(a[e])>0||parseInt(a[e])>parseInt(n[e]))return 1;if(n[e]&&!a[e]&&parseInt(n[e])>0||parseInt(a[e])<parseInt(n[e]))return-1}return 0}static GetContrastColor(e){let t="#000000";return 0===e.indexOf("#")&&(e=e.slice(1)),(3===e.length||6===e.length)&&(3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),t=.299*parseInt(e.slice(0,2),16)+.587*parseInt(e.slice(2,4),16)+.114*parseInt(e.slice(4,6),16)>186?"#000000":"#FFFFFF"),t}static GetMoonPhaseIcon(e,t){let a="";switch(e){case m.FirstQuarter:a=C;break;case m.Full:a=D;break;case m.LastQuarter:a=b;break;case m.NewMoon:a=w;break;case m.WaningCrescent:a=v;break;case m.WaningGibbous:a=S;break;case m.WaxingCrescent:a=M;break;case m.WaxingGibbous:a=N}return a.replace('fill="#ffffff"',`fill="${t}"`)}static PadNumber(e,t=1){if(e<Math.pow(10,t)){const a=t-(Math.log(e)*Math.LOG10E|0);return`${"0".repeat(a)}${e}`}return`${e}`}static FormatDateTime(e,t){const a={D:e=>String(e.day),DD:e=>T.PadNumber(e.day),DO:e=>`${e.day}${T.ordinalSuffix(e.day)}`,d:e=>String(ee.instance.activeCalendar.year.weekdays[ee.instance.activeCalendar.year.dayOfTheWeek(e.year,e.month,e.day)].numericRepresentation),dd:e=>T.PadNumber(ee.instance.activeCalendar.year.weekdays[ee.instance.activeCalendar.year.dayOfTheWeek(e.year,e.month,e.day)].numericRepresentation),ddd:e=>`${ee.instance.activeCalendar.year.weekdays[ee.instance.activeCalendar.year.dayOfTheWeek(e.year,e.month,e.day)].name.substring(0,3)}`,dddd:e=>`${ee.instance.activeCalendar.year.weekdays[ee.instance.activeCalendar.year.dayOfTheWeek(e.year,e.month,e.day)].name}`,M:e=>String(e.month),MM:e=>T.PadNumber(e.month),MMM:e=>{const t=ee.instance.activeCalendar.year.months.find((t=>t.numericRepresentation===e.month));return t?t.abbreviation:""},MMMM:e=>{const t=ee.instance.activeCalendar.year.months.find((t=>t.numericRepresentation===e.month));return t?t.name:""},YN:e=>ee.instance.activeCalendar.year.getYearName(e.year),YA:e=>ee.instance.activeCalendar.year.prefix,YZ:e=>ee.instance.activeCalendar.year.postfix,YY:e=>T.PadNumber(e.year,2).substring(2),YYYY:e=>String(e.year),H:e=>String(e.hour),HH:e=>T.PadNumber(e.hour),h:e=>{const t=Math.floor(ee.instance.activeCalendar.year.time.hoursInDay/2),a=e.hour%t||t;return String(a)},hh:e=>{const t=Math.floor(ee.instance.activeCalendar.year.time.hoursInDay/2),a=e.hour%t||t;return T.PadNumber(a)},m:e=>String(e.minute),mm:e=>T.PadNumber(e.minute),s:e=>String(e.seconds),ss:e=>T.PadNumber(e.seconds),A:e=>{const t=Math.floor(ee.instance.activeCalendar.year.time.hoursInDay/2);return e.hour>=t?"PM":"AM"},a:e=>{const t=Math.floor(ee.instance.activeCalendar.year.time.hoursInDay/2);return e.hour>=t?"pm":"am"}},n=[];return(t=(t=t.replace(/\[([^]*?)\]/gm,(function(e,t){return n.push(t),"@@@"}))).replace(/DO|d{1,4}|M{1,4}|YN|YA|YZ|YY(?:YY)?|ZZ|Z|([HhMmsD])\1?|[aA]/g,(t=>a[t](e)))).replace(/@@@/g,(()=>n.shift()))}static ToSeconds(e,t,a,n=!0,s=ee.instance.activeCalendar.year){let i=s.dateToDays(e,t,a,!0,!0),r=s.time.getTotalSeconds(i,n);if(ee.instance.activeCalendar.gameSystem===g.PF2E&&ee.instance.activeCalendar.generalSettings.pf2eSync){const o=k.newYearZero();void 0!==o&&(ee.instance.activeCalendar.year.yearZero=o,i=s.dateToDays(e,t,a,!0,!0)),i++,r=s.time.getTotalSeconds(i,n)-k.getWorldCreateSeconds(!1)}return r}static GetDisplayDate(e,t,a=!1,n=!0,s="-"){const i=ee.instance.activeCalendar.generalSettings.dateFormat.time.replace(/:?[s]/g,"");let r=ee.instance.activeCalendar.generalSettings.dateFormat.date;n||(r=r.replace(/[,.\/\\\s]*?(YN|YA|YZ|YY(?:YY)?)/g,""));let o="",c="";return T.DateTheSame(e,t)||0===t.month||0===t.day?a||(o=`${r}`):(o=`${r}`,c=`${r}`),e.allDay||(o+=` ${i}`),t.allDay||e.hour===t.hour&&e.minute===t.minute||(c+=` ${i}`),""!==c&&(c=` ${s} ${c}`),`${T.FormatDateTime({year:e.year,month:e.month,day:e.day,hour:e.hour,minute:e.minute,seconds:0},o)}${T.FormatDateTime({year:t.year,month:t.month,day:t.day,hour:t.hour,minute:t.minute,seconds:0},c)}`}static DateTheSame(e,t){return e.year===t.year&&e.month==t.month&&e.day===t.day}static DaysBetweenDates(e,t){const a=ee.instance.activeCalendar.year.dateToDays(e.year,e.month,e.day);return ee.instance.activeCalendar.year.dateToDays(t.year,t.month,t.day)-a}static IsDayBetweenDates(e,t,a){let n=o.None,s=0,i=0,r=0;const c=ee.instance.activeCalendar.year.months.findIndex((e=>e.numericRepresentation===t.month)),l=ee.instance.activeCalendar.year.months.findIndex((t=>t.numericRepresentation===e.month)),h=ee.instance.activeCalendar.year.months.findIndex((e=>e.numericRepresentation===a.month));return c>-1&&(i=T.ToSeconds(t.year,t.month,t.day,!1)),l>-1&&(s=T.ToSeconds(e.year,e.month,e.day,!1)),h>-1&&(r=T.ToSeconds(a.year,a.month,a.day,!1)),-1===l||-1===c||-1===h?n=o.None:s===i&&s===r?n=o.Exact:s===i?n=o.Start:s===r?n=o.End:s<r&&s>i&&(n=o.Middle),n}}class k{static getWorldCreateSeconds(e=!0){let t=0;if(game.hasOwnProperty("pf2e")){let a=Math.floor(game.pf2e.worldClock.worldCreatedOn/1e3);"AR"!==game.pf2e.worldClock.dateTheme&&"IC"!==game.pf2e.worldClock.dateTheme||(a+=62167219200),t+=a,ee.instance&&(!e&&T.compareSemanticVersions(game.system.data.version,k.worldClockCodeChangeVersion)>0?t+=ee.instance.activeCalendar.year.time.secondsPerDay:e&&T.compareSemanticVersions(game.system.data.version,k.worldClockCodeChangeVersion)<=0&&(t-=ee.instance.activeCalendar.year.time.secondsPerDay))}return t}static newYearZero(){let e;return game.hasOwnProperty("pf2e")&&("AD"===game.pf2e.worldClock.dateTheme?e=T.compareSemanticVersions(game.system.data.version,k.worldClockCodeChangeVersion)>0?1970:1875:"CE"===game.pf2e.worldClock.dateTheme?e=1970:"AR"===game.pf2e.worldClock.dateTheme&&(e=T.compareSemanticVersions(game.system.data.version,k.worldClockCodeChangeVersion)>0?0:2700)),e}static checkLeapYearRules(e){ee.instance.activeCalendar.gameSystem===g.PF2E&&ee.instance.activeCalendar.generalSettings.pf2eSync&&("AD"!==game.pf2e.worldClock.dateTheme&&"CE"!==game.pf2e.worldClock.dateTheme&&"AR"!==game.pf2e.worldClock.dateTheme||(e.rule=c.Gregorian))}static weekdayAdjust(){let e;return ee.instance.activeCalendar.gameSystem===g.PF2E&&ee.instance.activeCalendar.generalSettings.pf2eSync&&("CE"===game.pf2e.worldClock.dateTheme||"AD"===game.pf2e.worldClock.dateTheme?e=4:"AR"===game.pf2e.worldClock.dateTheme&&(e=5)),e}}k.worldClockCodeChangeVersion="2.14.4.8167";class R{constructor(e,t){this.showYear=!0,this.addTime=!1,this.setInputWidth=!0,this.placeHolderText="",this.timeDelimiter="-",this.dateRange=!1,this.timeRange=!0,this.showTimeLabel=!0,this.secondDaySelect=!1,this.onDateSelect=null,this.id=e,this.showDate=t.showDate,this.showTime=t.showTime,this.selectedDate={visibleDate:{year:0,month:0,day:0,allDay:!0,hour:0,minute:0},startDate:{year:0,month:0,day:0,allDay:!0,hour:0,minute:0},endDate:{year:0,month:0,day:0,allDay:!0,hour:0,minute:0}},void 0!==t.showYear&&(this.showYear=t.showYear),void 0!==t.inputMatchCalendarWidth&&(this.setInputWidth=t.inputMatchCalendarWidth),t.placeHolderText&&(this.placeHolderText=t.placeHolderText),t.onDateSelect&&(this.onDateSelect=t.onDateSelect),void 0!==t.dateRangeSelect&&(this.dateRange=t.dateRangeSelect),void 0!==t.timeRangeSelect&&(this.timeRange=t.timeRangeSelect),void 0!==t.showTimeLabel&&(this.showTimeLabel=t.showTimeLabel),void 0!==t.timeDelimiter&&(this.timeDelimiter=t.timeDelimiter),void 0!==t.startDate?this.selectedDate.startDate={year:t.startDate.year,month:t.startDate.month,day:t.startDate.day,allDay:!this.showTime,hour:t.startDate.hour,minute:t.startDate.minute}:this.selectedDate.startDate={year:0,month:1,day:1,allDay:!0,hour:0,minute:0},this.selectedDate.visibleDate={year:this.selectedDate.startDate.year,month:this.selectedDate.startDate.month,day:this.selectedDate.startDate.day,allDay:!this.selectedDate.startDate.allDay,hour:this.selectedDate.startDate.hour,minute:this.selectedDate.startDate.minute},this.selectedDate.endDate=this.selectedDate.startDate,void 0!==t.endDate&&(this.selectedDate.endDate={year:t.endDate.year,month:t.endDate.month,day:t.endDate.day,allDay:!this.showTime,hour:t.endDate.hour,minute:t.endDate.minute}),void 0!==t.allDay&&(this.selectedDate.startDate.allDay=t.allDay,this.selectedDate.endDate.allDay=t.allDay,this.selectedDate.visibleDate.allDay=t.allDay),this.selectedDate.startDate.allDay||(this.addTime=!0)}static GetSelector(e,t){if(R.Selectors.hasOwnProperty(e))return this.Selectors[e];{const a=new R(e,t);return this.Selectors[e]=a,a}}static RemoveSelector(e){R.Selectors.hasOwnProperty(e)&&delete this.Selectors[e]}build(e=!1){let t="",a=`<div id="${this.id}" class="sc-date-selector">`,n=0,s="";const i=ee.instance.activeCalendar.generalSettings.dateFormat.time.replace(/:?[s]/g,"");if(this.showDate){let e=[[!1]],t=1,a=ee.instance.activeCalendar.year.showWeekdayHeadings?ee.instance.activeCalendar.year.weekdays:[];const i=ee.instance.activeCalendar.year.months.find((e=>e.numericRepresentation===this.selectedDate.visibleDate.month));if(i&&(e=ee.instance.activeCalendar.year.daysIntoWeeks(i,this.selectedDate.startDate.year,ee.instance.activeCalendar.year.weekdays.length),t=i.numericRepresentation),!e.length)return"";const r=this.showYear?T.FormatDateTime({year:this.selectedDate.visibleDate.year,month:t,day:1,hour:0,minute:0,seconds:0},ee.instance.activeCalendar.generalSettings.dateFormat.monthYear):T.FormatDateTime({year:this.selectedDate.visibleDate.year,month:t,day:1,hour:0,minute:0,seconds:0},ee.instance.activeCalendar.generalSettings.dateFormat.monthYear.replace(/YN|YA|YZ|YY(?:YY)?/g,""));if(n=10+40*e[0].length,s=`<div class="header"><div class="current"><a class="prev fa fa-chevron-left"></a><span class="month-year" data-visible="${this.selectedDate.visibleDate.month}/${this.selectedDate.visibleDate.year}">${r}</span><a class="next fa fa-chevron-right"></a></div>`,a.length){let e='<div class="weekdays">';for(let t=0;t<a.length;t++){const n=a[t].toTemplate();e+=`<div class="weekday" title="${n.name}">${n.abbreviation}</div>`}e+="</div>",s+=e}s+="</div>";let c='<div class="days">';for(let t=0;t<e.length;t++){c+='<div class="week">';for(let a=0;a<e[t].length;a++)if(!1===e[t][a])c+='<div class="empty-day"></div>';else{let n="";const s={year:this.selectedDate.visibleDate.year,month:this.selectedDate.visibleDate.month,day:e[t][a].numericRepresentation,allDay:!0,hour:0,minute:0};switch(T.IsDayBetweenDates(s,this.selectedDate.startDate,this.selectedDate.endDate)){case o.Exact:n="selected";break;case o.Start:n="selected selected-range-start";break;case o.Middle:n="selected selected-range-mid";break;case o.End:n="selected selected-range-end"}c+=`<div class='day ${n}' data-day='${e[t][a].numericRepresentation}'>${e[t][a].name}</div>`}c+="</div>"}c+="</div>",s+=`${c}`}if(this.showTime){let e="00:00",t="00:00";this.selectedDate.startDate.allDay||(e=" "+T.FormatDateTime({year:0,month:1,day:1,hour:this.selectedDate.startDate.hour,minute:this.selectedDate.startDate.minute,seconds:0},i)),this.selectedDate.endDate.allDay||(t=" "+T.FormatDateTime({year:0,month:1,day:1,hour:this.selectedDate.endDate.hour,minute:this.selectedDate.endDate.minute,seconds:0},i));let a="<div class='time-container'>";if(this.addTime){let n="",s="";const r=Math.floor(ee.instance.activeCalendar.year.time.minutesInHour/2);for(let e=0;e<ee.instance.activeCalendar.year.time.hoursInDay;e++){let t="",a="",o="",c="";this.selectedDate.startDate.hour!==e&&this.selectedDate.endDate.hour!==e||(this.selectedDate.startDate.hour===e&&0===this.selectedDate.startDate.minute?t="selected":this.selectedDate.startDate.hour===e&&this.selectedDate.startDate.minute===r?a="selected":0===this.selectedDate.endDate.minute?o="selected":this.selectedDate.endDate.minute===r&&(c="selected"));const l=T.FormatDateTime({year:0,month:0,day:0,hour:e,minute:0,seconds:0},i),h=T.FormatDateTime({year:0,month:0,day:0,hour:e,minute:r,seconds:0},i);n+=`<div class="time-option ${t}" data-hour="${e}" data-minute="0">${l}</div>`,n+=`<div class="time-option ${a}" data-hour="${e}" data-minute="${r}">${h}</div>`,s+=`<div class="time-option ${o}" data-hour="${e}" data-minute="0">${l}</div>`,s+=`<div class="time-option ${c}" data-hour="${e}" data-minute="${r}">${h}</div>`}if(this.showDate||this.timeRange){const i=`<div class="time-selector"><input class="start-time" type="text" value="${e}" /><div class="time-dropdown hide">${n}</div></div>`,r=`<div class="time-selector"><input class="end-time" type="text" value="${t}" /><div class="time-dropdown hide">${s}</div></div>`;this.showTimeLabel&&(a+=`<h3>${$.Localize("FSC.Notes.Time")}</h3>`),this.timeRange?a+=`<div class="time-selectors">${i}<span>${this.timeDelimiter}</span>${r}</div>`:a+=`<div class="time-selectors">${i}</div>`,this.showDate&&(a+=`<button class="control delete"><i class="fa fa-times"></i> ${$.Localize("FSC.Clear")}</button>`)}else a=`<div class='time-container just-time'><input class="start-time" type="hidden" value="${e}" /><div class="time-dropdown">${n}</div>`}else a+=`<div class="add-time"><button class="control"><i class="fa fa-clock"></i> ${$.Localize("FSC.Notes.DateTime.AllDay")}</button></div>`;s+=`${a}</div>`}const r=T.GetDisplayDate(this.selectedDate.startDate,this.selectedDate.endDate,this.showTime&&!this.showDate,this.showYear,this.timeDelimiter);if(e){t=s;const e=document.querySelector(`#${this.id} .display-input`);e&&(e.value=r)}else t=`${a}<input class="display-input" style="${n&&this.setInputWidth?"width:"+n+"px;":""}" value="${r}" placeholder="${this.placeHolderText}" tabindex="0" type="text" readonly="readonly"><div class="sc-date-selector-calendar${this.showTime&&!this.showDate?" just-time":""}" style="display:none;${n?"width:"+n+"px;":""}">${s}</div></div>`;return t}update(){const e=this.build(!0),t=document.querySelector(`#${this.id} .sc-date-selector-calendar`);t&&(t.innerHTML=e,this.activateListeners(t.parentElement,!0),t.style.display="block")}activateListeners(e=null,t=!1){if(e||(e=document.querySelector(`#${this.id}`)),e){const a=e;if(!t){document.addEventListener("click",this.hideCalendar.bind(this,e));const t=e.querySelector(".display-input");t&&t.addEventListener("click",this.toggleCalendar.bind(this,a))}if(this.showDate){const t=e.querySelector(".sc-date-selector-calendar");t&&t.addEventListener("click",this.calendarClick.bind(this));const n=e.querySelector(".header .current .prev");n&&n.addEventListener("click",this.prevClick.bind(this));const s=e.querySelector(".header .current .next");s&&s.addEventListener("click",this.nextClick.bind(this)),e.querySelectorAll(".days .day").forEach((e=>{e.addEventListener("click",this.dayClick.bind(this,a))}))}if(this.showTime){const t=e.querySelector(".add-time button");t&&t.addEventListener("click",this.addTimeClick.bind(this));const a=e.querySelector(".time-container button.control.delete");a&&a.addEventListener("click",this.removeTimeClick.bind(this)),e.querySelectorAll(".time-container input").forEach((e=>{e.addEventListener("click",this.timeClick.bind(this))})),e.querySelectorAll(".time-container .time-dropdown .time-option").forEach((e=>{e.addEventListener("click",this.timeDropdownClick.bind(this))})),e.querySelectorAll(".time-container input").forEach((e=>{e.addEventListener("change",this.timeUpdate.bind(this))}))}}}toggleCalendar(e,t){t.stopPropagation();const a=e.querySelector(".sc-date-selector-calendar");a&&("none"===a.style.display?a.style.display="block":a.style.display="none")}hideCalendar(e){this.secondDaySelect=!1;const t=e.querySelector(".sc-date-selector-calendar");t&&(t.offsetWidth||t.offsetHeight||t.getClientRects().length)&&(t.style.display="none",this.onDateSelect&&this.onDateSelect(this.selectedDate))}calendarClick(e){e.stopPropagation();const t=document.getElementById(this.id);if(t){const e=t.getElementsByClassName("time-dropdown");for(let t=0;t<e.length;t++)e[t].classList.add("hide")}}dayClick(e,t){t.stopPropagation();const a=t.target.getAttribute("data-day"),n=e.querySelector(".month-year");if(n&&a){const t=n.getAttribute("data-visible");if(t){const n=t.split("/");if(2===n.length){const t=parseInt(a),s=parseInt(n[0]),i=parseInt(n[1]);if(!isNaN(i)&&!isNaN(s)&&!isNaN(t)){let a=!0;if(this.dateRange)if(this.secondDaySelect){let e=this.selectedDate.startDate.month,a=s;const n=ee.instance.activeCalendar.year.months.findIndex((e=>e.numericRepresentation===this.selectedDate.startDate.month)),r=ee.instance.activeCalendar.year.months.findIndex((e=>e.numericRepresentation===s));if(n>-1&&(e=n),r>-1&&(a=r),this.selectedDate.startDate.day>t&&e===a&&this.selectedDate.startDate.year===i||e>a&&this.selectedDate.startDate.year===i||this.selectedDate.startDate.year>i){const e={year:i,month:s,day:t,allDay:this.selectedDate.endDate.allDay,hour:this.selectedDate.endDate.hour,minute:this.selectedDate.endDate.minute};this.selectedDate.endDate={year:this.selectedDate.startDate.year,month:this.selectedDate.startDate.month,day:this.selectedDate.startDate.day,allDay:this.selectedDate.startDate.allDay,hour:this.selectedDate.startDate.hour,minute:this.selectedDate.startDate.minute},this.selectedDate.startDate=e}else this.selectedDate.endDate.year=i,this.selectedDate.endDate.month=s,this.selectedDate.endDate.day=t;this.secondDaySelect=!1}else this.selectedDate.startDate.year=i,this.selectedDate.startDate.month=s,this.selectedDate.startDate.day=t,this.selectedDate.endDate.year=i,this.selectedDate.endDate.month=s,this.selectedDate.endDate.day=t,this.secondDaySelect=!0,a=!1;else this.selectedDate.startDate.year=i,this.selectedDate.startDate.month=s,this.selectedDate.startDate.day=t,this.selectedDate.endDate.year=i,this.selectedDate.endDate.month=s,this.selectedDate.endDate.day=t;a?(this.update(),this.hideCalendar(e)):this.update()}}}}}nextClick(e){e.stopPropagation(),this.changeMonth(!0)}prevClick(e){e.stopPropagation(),this.changeMonth(!1)}changeMonth(e){let t=0;for(let a=0;a<ee.instance.activeCalendar.year.months.length;a++)if(ee.instance.activeCalendar.year.months[a].numericRepresentation===this.selectedDate.visibleDate.month){t=a,e?a===ee.instance.activeCalendar.year.months.length-1?(t=0,this.selectedDate.visibleDate.month=ee.instance.activeCalendar.year.months[t].numericRepresentation,this.selectedDate.visibleDate.year++):(t=a+1,this.selectedDate.visibleDate.month=ee.instance.activeCalendar.year.months[t].numericRepresentation):e||0!==a?(t=a-1,this.selectedDate.visibleDate.month=ee.instance.activeCalendar.year.months[t].numericRepresentation):(t=ee.instance.activeCalendar.year.months.length-1,this.selectedDate.visibleDate.month=ee.instance.activeCalendar.year.months[t].numericRepresentation,this.selectedDate.visibleDate.year--);const n=ee.instance.activeCalendar.year.leapYearRule.isLeapYear(this.selectedDate.visibleDate.year);if(n&&0===ee.instance.activeCalendar.year.months[t].numberOfLeapYearDays||!n&&0===ee.instance.activeCalendar.year.months[t].numberOfDays)return void this.changeMonth(e);break}this.update()}addTimeClick(e){e.stopPropagation(),this.addTime=!0,this.selectedDate.startDate.allDay=!1,this.selectedDate.startDate.hour=0,this.selectedDate.startDate.minute=0,this.selectedDate.endDate.allDay=!1,this.selectedDate.endDate.hour=0,this.selectedDate.endDate.minute=0,this.update()}removeTimeClick(e){e.stopPropagation(),this.addTime=!1,this.selectedDate.startDate.allDay=!0,this.selectedDate.startDate.hour=0,this.selectedDate.startDate.minute=0,this.selectedDate.endDate.allDay=!0,this.selectedDate.endDate.hour=0,this.selectedDate.endDate.minute=0,this.update()}timeClick(e){e.stopPropagation(),this.calendarClick(e);const t=e.currentTarget.parentElement;if(null!==t){const e=t.getElementsByClassName("time-dropdown");e.length&&e[0].classList.remove("hide")}}timeDropdownClick(e){var t,a;e.stopPropagation();const n=e.currentTarget.getAttribute("data-hour"),s=e.currentTarget.getAttribute("data-minute");let i=0,r=0;if(n&&s){const e=parseInt(n),t=parseInt(s);isNaN(e)||(i=e),isNaN(t)||(r=t)}const o=null===(a=null===(t=e.currentTarget.parentElement)||void 0===t?void 0:t.parentElement)||void 0===a?void 0:a.getElementsByTagName("input");if(o&&o.length){o[0].value=`${i}:${r}`;const e=new Event("change");o[0].dispatchEvent(e)}}timeUpdate(e){e.stopPropagation();const t=e.currentTarget.getAttribute("class");let a,n=0;const s=e.currentTarget.value.split(":");2===s.length?(a=parseInt(s[0]),n=parseInt(s[1])):a=parseInt(s[0]),isNaN(a)&&(a=0),isNaN(n)&&(n=0),a>ee.instance.activeCalendar.year.time.hoursInDay-1?a=ee.instance.activeCalendar.year.time.hoursInDay-1:a<0&&(a=0),n>ee.instance.activeCalendar.year.time.minutesInHour-1?n=ee.instance.activeCalendar.year.time.minutesInHour-1:n<0&&(n=0),"start-time"===t?(a>=this.selectedDate.endDate.hour&&(this.selectedDate.endDate.hour=a,this.selectedDate.endDate.hour=a+1,this.selectedDate.endDate.hour>ee.instance.activeCalendar.year.time.hoursInDay-1&&(this.selectedDate.endDate.hour=ee.instance.activeCalendar.year.time.hoursInDay-1),n>this.selectedDate.endDate.minute&&(this.selectedDate.endDate.minute=n)),this.selectedDate.startDate.hour=a,this.selectedDate.startDate.minute=n):"end-time"===t&&(T.DateTheSame(this.selectedDate.startDate,this.selectedDate.endDate)&&a<=this.selectedDate.startDate.hour&&(a=this.selectedDate.startDate.hour,n<this.selectedDate.startDate.minute&&(n=this.selectedDate.startDate.minute)),this.selectedDate.endDate.hour=a,this.selectedDate.endDate.minute=n),this.update(),this.showTime&&!this.showDate&&this.onDateSelect&&this.onDateSelect(this.selectedDate)}}R.Selectors={};class L{constructor(e="",t=NaN){this.id=T.generateUniqueId(),this.name=e,this.numericRepresentation=t}clone(){const e=new L(this.name,this.numericRepresentation);return e.id=this.id,e}toConfig(){return{id:this.id,name:this.name,numericRepresentation:this.numericRepresentation}}toTemplate(e=null){return{id:this.id,name:this.name,numericRepresentation:this.numericRepresentation}}loadFromSettings(e){this.id=e.id,e.hasOwnProperty("name")&&e.name&&(this.name=e.name),e.hasOwnProperty("numericRepresentation")&&e.numericRepresentation&&(this.numericRepresentation=e.numericRepresentation)}}class F extends L{constructor(e,t=""){super(t,e),this.current=!1,this.selected=!1,""===this.name&&this.numericRepresentation&&(this.name=this.numericRepresentation.toString())}toTemplate(){return{...super.toTemplate(),name:this.name,numericRepresentation:this.numericRepresentation,current:this.current,selected:this.selected}}clone(){const e=new F(this.numericRepresentation,this.name);return e.id=this.id,e.current=this.current,e.selected=this.selected,e}}class I extends L{constructor(e="",t=NaN,a=0,n=0,s=null){super(e,t),this.days=[],this.numberOfDays=0,this.numberOfLeapYearDays=0,this.numericRepresentationOffset=0,this.intercalary=!1,this.intercalaryInclude=!1,this.current=!1,this.visible=!1,this.selected=!1,this.showAdvanced=!1,this.startingWeekday=null,this.abbreviation="",this.numericRepresentationOffset=a,""===this.name&&(this.name=t.toString()),this.abbreviation=this.name.substring(0,3),this.numberOfLeapYearDays=null===s?n:s,this.numberOfDays=n,this.populateDays(this.numberOfLeapYearDays>this.numberOfDays?this.numberOfLeapYearDays:this.numberOfDays)}populateDays(e,t=null){for(let a=1;a<=e;a++){const e=new F(a+this.numericRepresentationOffset);a===t&&(e.current=!0),this.days.push(e)}}getDisplayName(){return this.numericRepresentation.toString()===this.name?this.name:`${this.name} (${this.numericRepresentation})`}toConfig(){return{id:this.id,name:this.name,abbreviation:this.abbreviation,numericRepresentation:this.numericRepresentation,numericRepresentationOffset:this.numericRepresentationOffset,numberOfDays:this.numberOfDays,numberOfLeapYearDays:this.numberOfLeapYearDays,intercalary:this.intercalary,intercalaryInclude:this.intercalaryInclude,startingWeekday:this.startingWeekday}}toTemplate(e=null){let t=!1;return e&&(t=e.leapYearRule.isLeapYear(e.visibleYear)),{...super.toTemplate(),abbreviation:this.abbreviation,display:this.getDisplayName(),name:this.name,numericRepresentation:this.numericRepresentation,numericRepresentationOffset:this.numericRepresentationOffset,current:this.current,visible:this.visible,selected:this.selected,days:this.getDaysForTemplate(t),numberOfDays:this.numberOfDays,numberOfLeapYearDays:this.numberOfLeapYearDays,intercalary:this.intercalary,intercalaryInclude:this.intercalaryInclude,showAdvanced:this.showAdvanced,startingWeekday:this.startingWeekday}}clone(){const e=new I(this.name,this.numericRepresentation,this.numericRepresentationOffset);return e.id=this.id,e.name=this.name,e.abbreviation=this.abbreviation,e.current=this.current,e.selected=this.selected,e.visible=this.visible,e.days=this.days.map((e=>e.clone())),e.numberOfDays=this.numberOfDays,e.numberOfLeapYearDays=this.numberOfLeapYearDays,e.intercalary=this.intercalary,e.intercalaryInclude=this.intercalaryInclude,e.showAdvanced=this.showAdvanced,e.startingWeekday=this.startingWeekday,e}loadFromSettings(e){if(e&&Object.keys(e).length){e.hasOwnProperty("id")&&(this.id=e.id),this.name=e.name,this.numericRepresentation=e.numericRepresentation,this.numericRepresentationOffset=e.numericRepresentationOffset;let t=parseInt(e.numberOfDays.toString()),a=void 0===e.numberOfLeapYearDays?0:parseInt(e.numberOfLeapYearDays.toString());isNaN(t)&&(t=1),isNaN(a)&&(a=1),this.numberOfDays=t,this.numberOfLeapYearDays=a,this.intercalary=e.intercalary,this.intercalaryInclude=e.intercalaryInclude,e.hasOwnProperty("startingWeekday")&&(this.startingWeekday=e.startingWeekday),e.hasOwnProperty("abbreviation")?this.abbreviation=e.abbreviation:this.abbreviation=this.name.substring(0,3),this.days=[],this.populateDays(this.numberOfLeapYearDays>this.numberOfDays?this.numberOfLeapYearDays:this.numberOfDays)}}getDay(e="current"){const t=e.toLowerCase();return this.days.find((e=>e[t]))}getDaysForTemplate(t=!1){let a=this.days.map((e=>e.toTemplate()));if(e.debug(`Getting Day Templates for ${this.name}, there are a max of ${a.length} days`),this.numberOfDays!==this.numberOfLeapYearDays){const n=this.numberOfLeapYearDays-this.numberOfDays;if(e.debug(`There is a difference of "${n}" between the normal number of days and number of days in a leap year.`),n>0&&!t)return e.debug(`It is not a leap year so trim off the extra leap days to get ${a.length-n} days`),a.slice(0,a.length-n);if(n<0&&t)return e.debug(`It is a leap year so trim off the extra normal days to get ${a.length+n} days`),a.slice(0,a.length-Math.abs(n))}return a}changeDay(t,a=!1,n="current"){const s=this.getDay(n);let i=0;const r=a?this.numberOfLeapYearDays:this.numberOfDays;if(s){let o=this.days.findIndex((e=>e.numericRepresentation===s.numericRepresentation))+t;t>0&&o>=r||t<0&&o<0||o<0?(e.debug(`On ${t>0?"last":"first"} day of the month, changing to ${t>0?"next":"previous"} month`),this.resetDays(n),i=t>0?1:-1):(e.debug(`New Day: ${this.days[o].numericRepresentation}`),this.updateDay(o,a,n))}return i}resetDays(e="current"){const t=e.toLowerCase();this.days.forEach((e=>{e[t]=!1}))}updateDay(e,t=!1,a="current"){const n=a.toLowerCase(),s=t?this.numberOfLeapYearDays:this.numberOfDays;this.resetDays(a),e<0||e>=s?this.days[s-1][n]=!0:this.days[e]&&(this.days[e][n]=!0)}}class P extends L{constructor(e=NaN,t=""){super(t,e),this.abbreviation="",this.abbreviation=t.substring(0,2)}toConfig(){return{abbreviation:this.abbreviation,id:this.id,name:this.name,numericRepresentation:this.numericRepresentation}}toTemplate(){return{...super.toTemplate(),abbreviation:this.abbreviation,name:this.name,numericRepresentation:this.numericRepresentation}}clone(){const e=new P(this.numericRepresentation,this.name);return e.id=this.id,e.abbreviation=this.abbreviation,e}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("id")&&(this.id=e.id),this.name=e.name,this.numericRepresentation=e.numericRepresentation,e.hasOwnProperty("abbreviation")?this.abbreviation=e.abbreviation:this.abbreviation=this.name.substring(0,2))}}class x extends L{constructor(e="",t=0,a=0){super(e),this.color="#ffffff",this.startingMonth=-1,this.startingDay=-1,this.sunriseTime=0,this.sunsetTime=0,this.startingMonth=t,this.startingDay=a}clone(){const e=new x(this.name,this.startingMonth,this.startingDay);return e.id=this.id,e.color=this.color,e.sunriseTime=this.sunriseTime,e.sunsetTime=this.sunsetTime,e}toConfig(){return{id:this.id,name:this.name,startingMonth:this.startingMonth,startingDay:this.startingDay,color:this.color,sunriseTime:this.sunriseTime,sunsetTime:this.sunsetTime}}toTemplate(e){const t=`sc_season_start_date_${this.id}`,a=`sc_season_sunrise_time_${this.id}`,n={...super.toTemplate(),name:this.name,startingMonth:this.startingMonth,startingDay:this.startingDay,color:this.color,startDateSelectorId:t,sunriseSelectorId:a};R.GetSelector(t,{showDate:!0,showYear:!1,showTime:!1,dateRangeSelect:!1,inputMatchCalendarWidth:!1,startDate:{year:0,month:this.startingMonth,day:this.startingDay,hour:0,minute:0,seconds:0},allDay:!0,onDateSelect:this.startDateChange.bind(this)});let s=0,i=0,r=0,o=0;return ee.instance&&(i=Math.floor(this.sunriseTime/ee.instance.activeCalendar.year.time.secondsInMinute),o=Math.floor(this.sunsetTime/ee.instance.activeCalendar.year.time.secondsInMinute),i>=ee.instance.activeCalendar.year.time.minutesInHour&&(s=Math.floor(i/ee.instance.activeCalendar.year.time.minutesInHour),i-=s*ee.instance.activeCalendar.year.time.minutesInHour),o>=ee.instance.activeCalendar.year.time.minutesInHour&&(r=Math.floor(o/ee.instance.activeCalendar.year.time.minutesInHour),o-=r*ee.instance.activeCalendar.year.time.minutesInHour)),R.GetSelector(a,{showDate:!1,showTime:!0,dateRangeSelect:!1,timeRangeSelect:!0,showTimeLabel:!1,timeDelimiter:"/",inputMatchCalendarWidth:!1,startDate:{year:0,month:1,day:1,hour:s,minute:i,seconds:0},endDate:{year:0,month:1,day:1,hour:r,minute:o,seconds:0},allDay:!1,onDateSelect:this.sunriseSunsetChange.bind(this)}),n}loadFromSettings(e){if(e&&Object.keys(e).length){e.hasOwnProperty("id")&&(this.id=e.id),this.name=e.name,this.startingMonth=e.startingMonth,this.startingDay=e.startingDay;const t=e.customColor;this.color="custom"===e.color&&t?t:e.color,e.hasOwnProperty("sunriseTime")&&(this.sunriseTime=e.sunriseTime),e.hasOwnProperty("sunsetTime")&&(this.sunsetTime=e.sunsetTime)}}startDateChange(e){this.startingMonth=e.startDate.month,this.startingDay=e.startDate.day}sunriseSunsetChange(e){ee.instance&&(this.sunriseTime=e.startDate.hour*ee.instance.activeCalendar.year.time.minutesInHour*ee.instance.activeCalendar.year.time.secondsInMinute+e.startDate.minute*ee.instance.activeCalendar.year.time.secondsInMinute,this.sunsetTime=e.endDate.hour*ee.instance.activeCalendar.year.time.minutesInHour*ee.instance.activeCalendar.year.time.secondsInMinute+e.endDate.minute*ee.instance.activeCalendar.year.time.secondsInMinute)}activateDateSelectors(){R.GetSelector(`sc_season_start_date_${this.id}`,{showDate:!0,showTime:!1}).activateListeners(),R.GetSelector(`sc_season_sunrise_time_${this.id}`,{showDate:!1,showTime:!0}).activateListeners()}}class W extends L{constructor(e="",t=0){super(e),this.phases=[],this.firstNewMoon={yearReset:u.None,yearX:0,year:0,month:1,day:1},this.color="#ffffff",this.cycleDayAdjust=0,this.cycleLength=t,this.phases.push({name:$.Localize("FSC.Moon.Phase.New"),length:3.69,icon:m.NewMoon,singleDay:!0})}clone(){const e=new W(this.name,this.cycleLength);return e.id=this.id,e.phases=this.phases.map((e=>({name:e.name,length:e.length,icon:e.icon,singleDay:e.singleDay}))),e.firstNewMoon.yearReset=this.firstNewMoon.yearReset,e.firstNewMoon.yearX=this.firstNewMoon.yearX,e.firstNewMoon.year=this.firstNewMoon.year,e.firstNewMoon.month=this.firstNewMoon.month,e.firstNewMoon.day=this.firstNewMoon.day,e.color=this.color,e.cycleDayAdjust=this.cycleDayAdjust,e}toConfig(){return{id:this.id,name:this.name,cycleLength:this.cycleLength,firstNewMoon:{yearReset:this.firstNewMoon.yearReset,yearX:this.firstNewMoon.yearX,year:this.firstNewMoon.year,month:this.firstNewMoon.month,day:this.firstNewMoon.day},phases:this.phases.map((e=>({name:e.name,length:e.length,icon:e.icon,singleDay:e.singleDay}))),color:this.color,cycleDayAdjust:this.cycleDayAdjust}}toTemplate(e){const t={...super.toTemplate(),name:this.name,cycleLength:this.cycleLength,firstNewMoon:this.firstNewMoon,phases:this.phases,color:this.color,cycleDayAdjust:this.cycleDayAdjust,dayList:[]},a=e.months.find((e=>e.numericRepresentation===t.firstNewMoon.month));return a&&(t.dayList=a.days.map((e=>e.toTemplate()))),t}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("id")&&(this.id=e.id),this.name=e.name,this.cycleLength=e.cycleLength,this.phases=e.phases,this.firstNewMoon={yearReset:e.firstNewMoon.yearReset,yearX:e.firstNewMoon.yearX,year:e.firstNewMoon.year,month:e.firstNewMoon.month,day:e.firstNewMoon.day},this.color=e.color,this.cycleDayAdjust=e.cycleDayAdjust)}updatePhaseLength(){let e=0,t=0;for(let a=0;a<this.phases.length;a++)this.phases[a].singleDay?t++:e++;const a=Number(((this.cycleLength-t)/e).toPrecision(6));this.phases.forEach((e=>{e.singleDay?e.length=1:e.length=a}))}getMoonPhase(t,a="current",n=null){let s="current"===(a=a.toLowerCase())?t.numericRepresentation:"selected"===a?t.selectedYear:t.visibleYear,i=t.dateToDays(this.firstNewMoon.year,this.firstNewMoon.month,this.firstNewMoon.day,!0,!0);const r=t.getMonth(a);if(r){const o="visible"!==a?r.getDay(a):n;let c=r.numericRepresentation,l=o?o.numericRepresentation:1,h=0;if(this.firstNewMoon.yearReset===u.LeapYear){let a=t.leapYearRule.previousLeapYear(s);null!==a&&(e.debug(`Resetting moon calculation first day to year: ${a}`),i=t.dateToDays(a,this.firstNewMoon.month,this.firstNewMoon.day,!0,!0),s!==a&&(h+=t.leapYearRule.fraction(s)))}else if(this.firstNewMoon.yearReset===u.XYears){const e=s%this.firstNewMoon.yearX;if(0!==e){let a=s-e;i=t.dateToDays(a,this.firstNewMoon.month,this.firstNewMoon.day,!0,!0),h+=e/this.firstNewMoon.yearX}}const d=(t.dateToDays(s,c,l,!0,!0)-i+h)/this.cycleLength;let m=(d-Math.floor(d))*this.cycleLength+this.cycleDayAdjust,y=0,g=null;for(let e=0;e<this.phases.length;e++){const t=y+this.phases[e].length;if(m>=y&&m<t){g=this.phases[e];break}y=t}if(null!==g)return g}return this.phases[0]}}class Y{static setToPredefined(e,t){let a=0,n=!1;switch(t){case i.Gregorian:const t=new Date;e.numericRepresentation=t.getFullYear(),e.prefix="",e.postfix="",e.yearZero=1970,e.months=[new I($.Localize("FSC.Date.January"),1,0,31),new I($.Localize("FSC.Date.February"),2,0,28,29),new I($.Localize("FSC.Date.March"),3,0,31),new I($.Localize("FSC.Date.April"),4,0,30),new I($.Localize("FSC.Date.May"),5,0,31),new I($.Localize("FSC.Date.June"),6,0,30),new I($.Localize("FSC.Date.July"),7,0,31),new I($.Localize("FSC.Date.August"),8,0,31),new I($.Localize("FSC.Date.September"),9,0,30),new I($.Localize("FSC.Date.October"),10,0,31),new I($.Localize("FSC.Date.November"),11,0,30),new I($.Localize("FSC.Date.December"),12,0,31)],e.showWeekdayHeadings=!0,e.firstWeekday=4,e.weekdays=[new P(1,$.Localize("FSC.Date.Sunday")),new P(2,$.Localize("FSC.Date.Monday")),new P(3,$.Localize("FSC.Date.Tuesday")),new P(4,$.Localize("FSC.Date.Wednesday")),new P(5,$.Localize("FSC.Date.Thursday")),new P(6,$.Localize("FSC.Date.Friday")),new P(7,$.Localize("FSC.Date.Saturday"))],e.seasons=[new x("Spring",3,20),new x("Summer",6,20),new x("Fall",9,22),new x("Winter",12,21)],e.time.hoursInDay=24,e.time.minutesInHour=60,e.time.secondsInMinute=60,e.time.gameTimeRatio=1,e.leapYearRule.rule=c.Gregorian,e.leapYearRule.customMod=0,e.months[t.getMonth()].current=!0,e.months[t.getMonth()].days[t.getDate()-1].current=!0,e.seasons[0].color="#fffce8",e.seasons[1].color="#f3fff3",e.seasons[2].color="#fff7f2",e.seasons[3].color="#f2f8ff",e.seasons[0].sunriseTime=21600,e.seasons[1].sunriseTime=21600,e.seasons[2].sunriseTime=21600,e.seasons[3].sunriseTime=21600,e.seasons[0].sunsetTime=64800,e.seasons[1].sunsetTime=64800,e.seasons[2].sunsetTime=64800,e.seasons[3].sunsetTime=64800,e.moons=[new W("Moon",29.53059)],e.moons[0].firstNewMoon.yearReset=u.None,e.moons[0].firstNewMoon.year=2e3,e.moons[0].firstNewMoon.month=1,e.moons[0].firstNewMoon.day=6,e.moons[0].cycleDayAdjust=.5,a=Number(((e.moons[0].cycleLength-4)/4).toPrecision(5)),e.moons[0].phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:a,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:a,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:a,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:a,icon:m.WaningCrescent,singleDay:!1}],e.yearNamesStart=0,e.yearNamingRule=l.Default,e.yearNames=[],n=!0;break;case i.DarkSun:e.numericRepresentation=1,e.prefix="",e.postfix="",e.yearZero=0,e.months=[new I("Scorch",1,0,30),new I("Morrow",2,0,30),new I("Rest",3,0,30),new I("Gather",4,0,30),new I("Cooling Sun",-1,0,5),new I("Breeze",5,0,30),new I("Mist",6,0,30),new I("Bloom",7,0,30),new I("Haze",8,0,30),new I("Soaring Sun",-2,0,5),new I("Hoard",9,0,30),new I("Wind",10,0,30),new I("Sorrow",11,0,30),new I("Smolder",12,0,30),new I("Highest Sun",-3,0,5)],e.months[4].intercalary=!0,e.months[9].intercalary=!0,e.months[14].intercalary=!0,e.showWeekdayHeadings=!1,e.firstWeekday=0,e.weekdays=[new P(1,"1 Day"),new P(2,"2 Day"),new P(3,"3 Day"),new P(4,"4 Day"),new P(5,"5 Day"),new P(6,"6 Day")],e.seasons=[new x("Sun Descending",3,1),new x("Sun Ascending",7,1),new x("High Sun",9,1)],e.seasons[2].color="#fff2da",e.seasons[0].color="#dececc",e.seasons[1].color="#fff1e7",e.seasons[0].sunriseTime=21600,e.seasons[1].sunriseTime=21600,e.seasons[2].sunriseTime=21600,e.seasons[0].sunsetTime=64800,e.seasons[1].sunsetTime=64800,e.seasons[2].sunsetTime=64800,e.time.hoursInDay=24,e.time.minutesInHour=60,e.time.secondsInMinute=60,e.time.gameTimeRatio=1,e.leapYearRule.rule=c.None,e.leapYearRule.customMod=0,e.months[0].current=!0,e.months[0].days[0].current=!0,e.moons=[new W("Ral",34),new W("Guthay",125)],e.moons[0].color="#7ace57",e.moons[0].firstNewMoon.yearReset=u.None,e.moons[0].firstNewMoon.year=1,e.moons[0].firstNewMoon.month=1,e.moons[0].firstNewMoon.day=14,a=Number(((e.moons[0].cycleLength-4)/4).toPrecision(5)),e.moons[0].phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:a,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:a,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:a,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:a,icon:m.WaningCrescent,singleDay:!1}],e.moons[1].color="#ffd920",e.moons[1].firstNewMoon.yearReset=u.None,e.moons[1].firstNewMoon.year=1,e.moons[1].firstNewMoon.month=3,e.moons[1].firstNewMoon.day=3,a=Number(((e.moons[1].cycleLength-4)/4).toPrecision(5)),e.moons[1].phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:a,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:a,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:a,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:a,icon:m.WaningCrescent,singleDay:!1}],e.yearNamesStart=-101,e.yearNamingRule=l.Repeat,e.yearNames=["Ral's Fury","Friend's Contemplation","Desert's Vengeance","Priest's Slumber","Wind's Defiance","Dragon's Reverance","Mountain's Agitation","King's Fury","Silt's Contemplation","Enemy's Vengeance","Guthay's Slumber","Ral's Defiance","Friend's Reverance","Desert's Agitation","Priest's Fury","Wind's Contemplation","Dragon's Vengeance","Mountain's Slumber","King's Defiance","Silt's Reverance","Enemy's Agitation","Guthay's Fury","Ral's Contemplation","Friend's Vengeance","Desert's Slumber","Priest's Defiance","Wind's Reverance","Dragon's Agitation","Mountain's Fury","King's Contemplation","Silt's Vengeance","Enemy's Slumber","Guthay's Defiance","Ral's Reverance","Friend's Agitation","Desert's Fury","Priest's Contemplation","Wind's Vengeance","Dragon's Slumber","Mountain's Defiance","King's Reverance","Silt's Agitation","Enemy's Fury","Guthay's Contemplation","Ral's Vengeance","Friend's Slumber","Desert's Defiance","Priest's Reverance","Wind's Agitation","Dragon's Fury","Mountain's Contemplation","King's Vengeance","Silt's Slumber","Enemy's Defiance","Guthay's Reverance","Ral's Agitation","Friend's Fury","Desert's Contemplation","Priest's Vengeance","Wind's Slumber","Dragon's Defiance","Mountain's Reverance","King's Agitation","Silt's Fury","Enemy's Contemplation","Guthay's Vengeance","Ral's Slumber","Friend's Defiance","Desert's Reverance","Priest's Agitation","Wind's Fury","Dragon's Contemplation","Mountain's Vengeance","King's Slumber","Silt's Defiance","Enemy's Reverance","Guthay's Agitation"],n=!0;break;case i.Eberron:e.numericRepresentation=998,e.prefix="",e.postfix=" YK",e.yearZero=0,e.months=[new I("Zarantyr",1,0,28),new I("Olarune",2,0,28),new I("Therendor",3,0,28),new I("Eyre",4,0,28),new I("Dravago",5,0,28),new I("Nymm",6,0,28),new I("Lharvion",7,0,28),new I("Barrakas",8,0,28),new I("Rhaan",9,0,28),new I("Sypheros",10,0,28),new I("Aryth",11,0,28),new I("Vult",12,0,28)],e.showWeekdayHeadings=!0,e.firstWeekday=0,e.weekdays=[new P(1,"Sul"),new P(2,"Mol"),new P(3,"Zol"),new P(4,"Wir"),new P(5,"Zor"),new P(6,"Far"),new P(7,"Sar")],e.seasons=[],e.time.hoursInDay=24,e.time.minutesInHour=60,e.time.secondsInMinute=60,e.time.gameTimeRatio=1,e.leapYearRule.rule=c.None,e.leapYearRule.customMod=0,e.months[0].current=!0,e.months[0].days[0].current=!0,e.moons=[],e.yearNamesStart=0,e.yearNamingRule=l.Default,e.yearNames=[],n=!0;break;case i.Exandrian:e.numericRepresentation=812,e.prefix="",e.postfix=" P.D.",e.yearZero=0,e.months=[new I("Horisal",1,0,29),new I("Misuthar",2,0,30),new I("Dualahei",3,0,30),new I("Thunsheer",4,0,31),new I("Unndilar",5,0,28),new I("Brussendar",6,0,31),new I("Sydenstar",7,0,32),new I("Fessuran",8,0,29),new I("Quen'pillar",9,0,27),new I("Cuersaar",10,0,29),new I("Duscar",11,0,32)],e.showWeekdayHeadings=!0,e.firstWeekday=3,e.weekdays=[new P(1,"Miresen"),new P(2,"Grissen"),new P(3,"Whelsen"),new P(4,"Conthsen"),new P(5,"Folsen"),new P(6,"Yulisen"),new P(7,"Da'leysen")],e.seasons=[new x("Spring",3,13),new x("Summer",5,26),new x("Autumn",8,3),new x("Winter",11,2)],e.time.hoursInDay=24,e.time.minutesInHour=60,e.time.secondsInMinute=60,e.time.gameTimeRatio=1,e.leapYearRule.rule=c.None,e.leapYearRule.customMod=0,e.months[0].current=!0,e.months[0].days[0].current=!0,e.seasons[0].color="#fffce8",e.seasons[1].color="#f3fff3",e.seasons[2].color="#fff7f2",e.seasons[3].color="#f2f8ff",e.seasons[0].sunriseTime=27e3,e.seasons[1].sunriseTime=21600,e.seasons[2].sunriseTime=27e3,e.seasons[3].sunriseTime=32400,e.seasons[0].sunsetTime=64800,e.seasons[1].sunsetTime=75600,e.seasons[2].sunsetTime=64800,e.seasons[3].sunsetTime=54e3,e.moons=[new W("Catha",33),new W("Ruidus",328)],e.moons[0].firstNewMoon.yearReset=u.None,e.moons[0].firstNewMoon.year=810,e.moons[0].firstNewMoon.month=1,e.moons[0].firstNewMoon.day=9,a=Number(((e.moons[0].cycleLength-4)/4).toPrecision(5)),e.moons[0].phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:a,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:a,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:a,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:a,icon:m.WaningCrescent,singleDay:!1}],e.moons[1].color="#ab82f3",e.moons[1].firstNewMoon.yearReset=u.None,e.moons[1].firstNewMoon.year=810,e.moons[1].firstNewMoon.month=3,e.moons[1].firstNewMoon.day=22,a=Number(((e.moons[1].cycleLength-4)/4).toPrecision(5)),e.moons[1].phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:a,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:a,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:a,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:a,icon:m.WaningCrescent,singleDay:!1}],e.yearNamesStart=0,e.yearNamingRule=l.Default,e.yearNames=[],n=!0;break;case i.ForbiddenLands:e.numericRepresentation=1165,e.prefix="",e.postfix=" AS",e.yearZero=0,e.showWeekdayHeadings=!0,e.firstWeekday=0,e.yearNames=[],e.yearNamesStart=0,e.yearNamingRule=l.Default,e.months=[new I("Winterwane",1,0,46),new I("Springrise",2,0,45),new I("Springwane",3,0,46),new I("Sumerrise",4,0,45),new I("Summerwane",5,0,46),new I("Fallrise",6,0,45),new I("Fallwane",7,0,46),new I("Winterrise",8,0,45)],e.weekdays=[new P(1,"Sunday"),new P(2,"Moonday"),new P(3,"Bloodday"),new P(4,"Earthday"),new P(5,"Growthday"),new P(6,"Feastday"),new P(7,"Stillday")],e.seasons=[new x("Spring",2,1),new x("Summer",4,1),new x("Fall",6,1),new x("Winter",8,1)],e.seasons[0].color="#acffac",e.seasons[1].color="#ff9393",e.seasons[2].color="#ffdf99",e.seasons[3].color="#a8a8ff",e.seasons[0].sunriseTime=21600,e.seasons[1].sunriseTime=21600,e.seasons[2].sunriseTime=21600,e.seasons[3].sunriseTime=21600,e.seasons[0].sunsetTime=64800,e.seasons[1].sunsetTime=64800,e.seasons[2].sunsetTime=64800,e.seasons[3].sunsetTime=64800,e.time.hoursInDay=24,e.time.minutesInHour=60,e.time.secondsInMinute=60,e.time.gameTimeRatio=1,e.leapYearRule.rule=c.None,e.leapYearRule.customMod=0,e.months[1].current=!0,e.months[1].days[0].current=!0,e.moons=[new W("Moon",30)],e.moons[0].firstNewMoon.yearReset=u.None,e.moons[0].firstNewMoon.year=0,e.moons[0].firstNewMoon.month=1,e.moons[0].firstNewMoon.day=1,e.moons[0].cycleDayAdjust=0,a=Number(((e.moons[0].cycleLength-4)/4).toPrecision(5)),e.moons[0].phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:a,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:a,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:a,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:a,icon:m.WaningCrescent,singleDay:!1}],n=!0;break;case i.GolarianPF1E:e.numericRepresentation=4710,e.prefix="",e.postfix=" AR",e.yearZero=0,e.months=[new I("Abadius",1,0,31),new I("Calistril",2,0,28,29),new I("Pharast",3,0,31),new I("Gozran",4,0,30),new I("Desnus",5,0,31),new I("Sarenith",6,0,30),new I("Erastus",7,0,31),new I("Arodus",8,0,31),new I("Rova",9,0,30),new I("Lamashan",10,0,31),new I("Neth",11,0,30),new I("Kuthona",12,0,31)],e.showWeekdayHeadings=!0,e.firstWeekday=6,e.weekdays=[new P(1,"Moonday"),new P(2,"Toilday"),new P(3,"Wealday"),new P(4,"Oathday"),new P(5,"Fireday"),new P(6,"Starday"),new P(7,"Sunday")],e.seasons=[new x("Spring",3,1),new x("Summer",6,1),new x("Fall",9,1),new x("Winter",12,1)],e.time.hoursInDay=24,e.time.minutesInHour=60,e.time.secondsInMinute=60,e.time.gameTimeRatio=1,e.leapYearRule.rule=c.Custom,e.leapYearRule.customMod=8,e.months[0].current=!0,e.months[0].days[0].current=!0,e.seasons[0].color="#fffce8",e.seasons[1].color="#f3fff3",e.seasons[2].color="#fff7f2",e.seasons[3].color="#f2f8ff",e.seasons[0].sunriseTime=21600,e.seasons[1].sunriseTime=21600,e.seasons[2].sunriseTime=21600,e.seasons[3].sunriseTime=21600,e.seasons[0].sunsetTime=64800,e.seasons[1].sunsetTime=64800,e.seasons[2].sunsetTime=64800,e.seasons[3].sunsetTime=64800,e.moons=[new W("Somal",29.5)],e.moons[0].firstNewMoon.yearReset=u.XYears,e.moons[0].firstNewMoon.yearX=4,e.moons[0].firstNewMoon.year=4700,e.moons[0].firstNewMoon.month=1,e.moons[0].firstNewMoon.day=8,a=Number(((e.moons[0].cycleLength-4)/4).toPrecision(5)),e.moons[0].phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:a,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:a,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:a,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:a,icon:m.WaningCrescent,singleDay:!1}],e.yearNamesStart=0,e.yearNamingRule=l.Default,e.yearNames=[],n=!0;break;case i.GolarianPF2E:e.numericRepresentation=4710,e.prefix="",e.postfix=" AR",e.yearZero=2700,e.months=[new I("Abadius",1,0,31),new I("Calistril",2,0,28,29),new I("Pharast",3,0,31),new I("Gozran",4,0,30),new I("Desnus",5,0,31),new I("Sarenith",6,0,30),new I("Erastus",7,0,31),new I("Arodus",8,0,31),new I("Rova",9,0,30),new I("Lamashan",10,0,31),new I("Neth",11,0,30),new I("Kuthona",12,0,31)],e.showWeekdayHeadings=!0,e.firstWeekday=6,e.weekdays=[new P(1,"Moonday"),new P(2,"Toilday"),new P(3,"Wealday"),new P(4,"Oathday"),new P(5,"Fireday"),new P(6,"Starday"),new P(7,"Sunday")],e.seasons=[new x("Spring",3,1),new x("Summer",6,1),new x("Fall",9,1),new x("Winter",12,1)],e.time.hoursInDay=24,e.time.minutesInHour=60,e.time.secondsInMinute=60,e.time.gameTimeRatio=1,e.leapYearRule.rule=c.Custom,e.leapYearRule.customMod=4,e.months[0].current=!0,e.months[0].days[0].current=!0,e.seasons[0].color="#fffce8",e.seasons[1].color="#f3fff3",e.seasons[2].color="#fff7f2",e.seasons[3].color="#f2f8ff",e.seasons[0].sunriseTime=21600,e.seasons[1].sunriseTime=21600,e.seasons[2].sunriseTime=21600,e.seasons[3].sunriseTime=21600,e.seasons[0].sunsetTime=64800,e.seasons[1].sunsetTime=64800,e.seasons[2].sunsetTime=64800,e.seasons[3].sunsetTime=64800,e.moons=[new W("Somal",29.5)],e.moons[0].firstNewMoon.yearReset=u.XYears,e.moons[0].firstNewMoon.yearX=4,e.moons[0].firstNewMoon.year=4700,e.moons[0].firstNewMoon.month=1,e.moons[0].firstNewMoon.day=8,a=Number(((e.moons[0].cycleLength-4)/4).toPrecision(5)),e.moons[0].phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:a,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:a,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:a,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:a,icon:m.WaningCrescent,singleDay:!1}],e.yearNamesStart=0,e.yearNamingRule=l.Default,e.yearNames=[],n=!0;break;case i.Greyhawk:e.numericRepresentation=591,e.prefix="",e.postfix=" cy",e.yearZero=0,e.months=[new I("Needfest",-1,0,7),new I("Fireseek",1,0,28),new I("Readying",2,0,28),new I("Coldeven",3,0,28),new I("Growfest",-2,0,7),new I("Planting",4,0,28),new I("Flocktime",5,0,28),new I("Wealsun",6,0,28),new I("Richfest",-3,0,7),new I("Reaping",7,0,28),new I("Goodmonth",8,0,28),new I("Harvester",9,0,28),new I("Brewfest",-4,0,7),new I("Patchwall",10,0,28),new I("Ready'reat",11,0,28),new I("Sunsebb",12,0,28)],e.months[0].intercalary=!0,e.months[4].intercalary=!0,e.months[8].intercalary=!0,e.months[12].intercalary=!0,e.showWeekdayHeadings=!0,e.firstWeekday=0,e.weekdays=[new P(1,"Starday"),new P(2,"Sunday"),new P(3,"Moonday"),new P(4,"Godsday"),new P(5,"Waterday"),new P(6,"Earthday"),new P(7,"Freeday")],e.seasons=[new x("Spring",2,1),new x("Low Summer",4,1),new x("High Summer",7,1),new x("Fall",10,1),new x("Winter",12,1)],e.seasons[0].color="#fffce8",e.seasons[1].color="#f3fff3",e.seasons[2].color="#f3fff3",e.seasons[3].color="#fff7f2",e.seasons[4].color="#f2f8ff",e.seasons[0].sunriseTime=24300,e.seasons[1].sunriseTime=18840,e.seasons[2].sunriseTime=16500,e.seasons[3].sunriseTime=20400,e.seasons[4].sunriseTime=25740,e.seasons[0].sunsetTime=48360,e.seasons[1].sunsetTime=66540,e.seasons[2].sunsetTime=69540,e.seasons[3].sunsetTime=64140,e.seasons[4].sunsetTime=59160,e.time.hoursInDay=24,e.time.minutesInHour=60,e.time.secondsInMinute=60,e.time.gameTimeRatio=1,e.leapYearRule.rule=c.None,e.leapYearRule.customMod=0,e.months[0].current=!0,e.months[0].days[0].current=!0,e.moons=[new W("Luna",28),new W("Celene",91)],e.moons[0].firstNewMoon.yearReset=u.None,e.moons[0].firstNewMoon.year=590,e.moons[0].firstNewMoon.month=1,e.moons[0].firstNewMoon.day=25,a=Number(((e.moons[0].cycleLength-4)/4).toPrecision(5)),e.moons[0].phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:a,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:a,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:a,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:a,icon:m.WaningCrescent,singleDay:!1}],e.moons[1].color="#7FFFD4",e.moons[1].firstNewMoon.yearReset=u.None,e.moons[1].firstNewMoon.year=590,e.moons[1].firstNewMoon.month=2,e.moons[1].firstNewMoon.day=12,a=Number(((e.moons[1].cycleLength-4)/4).toPrecision(5)),e.moons[1].phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:a,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:a,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:a,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:a,icon:m.WaningCrescent,singleDay:!1}],e.yearNamesStart=0,e.yearNamingRule=l.Default,e.yearNames=[],n=!0;break;case i.Harptos:e.numericRepresentation=1495,e.prefix="",e.postfix=" DR",e.yearZero=0,e.months=[new I("Hammer",1,0,30),new I("Midwinter",-1,0,1),new I("Alturiak",2,0,30),new I("Ches",3,0,30),new I("Tarsakh",4,0,30),new I("Greengrass",-2,0,1),new I("Mirtul",5,0,30),new I("Kythorn",6,0,30),new I("Flamerule",7,0,30),new I("Midsummer",-3,0,1),new I("Shieldmeet",-4,0,0,1),new I("Eleasis",8,0,30),new I("Eleint",9,0,30),new I("Higharvestide",-5,0,1),new I("Marpenoth",10,0,30),new I("Uktar",11,0,30),new I("Feast Of the Moon",-6,0,1),new I("Nightal",12,0,30)],e.months[1].intercalary=!0,e.months[5].intercalary=!0,e.months[9].intercalary=!0,e.months[10].intercalary=!0,e.months[13].intercalary=!0,e.months[16].intercalary=!0,e.showWeekdayHeadings=!1,e.firstWeekday=0,e.weekdays=[new P(1,"1st"),new P(2,"2nd"),new P(3,"3rd"),new P(4,"4th"),new P(5,"5th"),new P(6,"6th"),new P(7,"7th"),new P(8,"8th"),new P(9,"9th"),new P(10,"10th")],e.seasons=[new x("Spring",3,19),new x("Summer",6,20),new x("Fall",9,21),new x("Winter",12,20)],e.seasons[0].color="#fffce8",e.seasons[1].color="#f3fff3",e.seasons[2].color="#fff7f2",e.seasons[3].color="#f2f8ff",e.seasons[0].sunriseTime=21600,e.seasons[1].sunriseTime=21600,e.seasons[2].sunriseTime=21600,e.seasons[3].sunriseTime=21600,e.seasons[0].sunsetTime=64800,e.seasons[1].sunsetTime=64800,e.seasons[2].sunsetTime=64800,e.seasons[3].sunsetTime=64800,e.time.hoursInDay=24,e.time.minutesInHour=60,e.time.secondsInMinute=60,e.time.gameTimeRatio=1,e.leapYearRule.rule=c.Custom,e.leapYearRule.customMod=4,e.months[0].current=!0,e.months[0].days[0].current=!0,e.moons=[new W("Selne",30.45)],e.moons[0].firstNewMoon.yearReset=u.LeapYear,e.moons[0].firstNewMoon.year=1372,e.moons[0].firstNewMoon.month=1,e.moons[0].firstNewMoon.day=16,e.moons[0].cycleDayAdjust=.5,a=Number(((e.moons[0].cycleLength-4)/4).toPrecision(5)),e.moons[0].phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:a,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:a,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:a,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:a,icon:m.WaningCrescent,singleDay:!1}],e.yearNamesStart=0,e.yearNamingRule=l.Default,e.yearNames=[],n=!0;break;case i.TravellerImperialCalendar:e.numericRepresentation=1e3,e.prefix="",e.postfix="",e.yearZero=0,e.months=[new I("Holiday",-1,0,1),new I("Year",1,1,364)],e.months[0].intercalary=!0,e.showWeekdayHeadings=!0,e.firstWeekday=0,e.weekdays=[new P(1,"Wonday"),new P(2,"Tuday"),new P(3,"Thirday"),new P(4,"Forday"),new P(5,"Fiday"),new P(6,"Sixday"),new P(7,"Senday")],e.seasons=[],e.time.hoursInDay=24,e.time.minutesInHour=60,e.time.secondsInMinute=60,e.time.gameTimeRatio=1,e.leapYearRule.rule=c.None,e.leapYearRule.customMod=0,e.months[0].current=!0,e.months[0].days[0].current=!0,e.moons=[],e.yearNamesStart=0,e.yearNamingRule=l.Default,e.yearNames=[],n=!0;break;case i.WarhammerImperialCalendar:e.numericRepresentation=2522,e.prefix="",e.postfix="",e.yearZero=0,e.months=[new I("Hexenstag",-1,0,1),new I("Nachexen",1,0,32),new I("Jahrdrung",2,0,33),new I("Mitterfruhl",-2,0,1),new I("Pflugzeit",3,0,33),new I("Sigmarzeit",4,0,33),new I("Sommerzeit",5,0,33),new I("Sonnstill",-3,0,1),new I("Vorgeheim",6,0,33),new I("Geheimnistag",-4,0,1),new I("Nachgeheim",7,0,32),new I("Erntezeit",8,0,33),new I("Mittherbst",-5,0,1),new I("Brauzeit",9,0,33),new I("Kaldezeit",10,0,33),new I("Ulriczeit",11,0,33),new I("Mondstille",-6,0,1),new I("Vorhexen",12,0,33)],e.months[0].intercalary=!0,e.months[3].intercalary=!0,e.months[7].intercalary=!0,e.months[9].intercalary=!0,e.months[12].intercalary=!0,e.months[16].intercalary=!0,e.showWeekdayHeadings=!0,e.firstWeekday=0,e.weekdays=[new P(1,"Wellentag"),new P(2,"Aubentag"),new P(3,"Marktag"),new P(4,"Backertag"),new P(5,"Bezahltag"),new P(6,"Konistag"),new P(7,"Angestag"),new P(8,"Festag")],e.seasons=[new x("Spring",3,20),new x("Summer",6,20),new x("Fall",9,22),new x("Winter",12,21)],e.seasons[0].color="#fffce8",e.seasons[1].color="#f3fff3",e.seasons[2].color="#fff7f2",e.seasons[3].color="#f2f8ff",e.seasons[0].sunriseTime=21600,e.seasons[1].sunriseTime=21600,e.seasons[2].sunriseTime=21600,e.seasons[3].sunriseTime=21600,e.seasons[0].sunsetTime=64800,e.seasons[1].sunsetTime=64800,e.seasons[2].sunsetTime=64800,e.seasons[3].sunsetTime=64800,e.time.hoursInDay=24,e.time.minutesInHour=60,e.time.secondsInMinute=60,e.time.gameTimeRatio=1,e.leapYearRule.rule=c.None,e.leapYearRule.customMod=0,e.months[0].current=!0,e.months[0].days[0].current=!0,e.moons=[new W("Luna",25)],e.moons[0].firstNewMoon.yearReset=u.None,e.moons[0].firstNewMoon.year=2522,e.moons[0].firstNewMoon.month=1,e.moons[0].firstNewMoon.day=13,a=Number(((e.moons[0].cycleLength-4)/4).toPrecision(5)),e.moons[0].phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:a,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:a,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:a,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:a,icon:m.WaningCrescent,singleDay:!1}],e.yearNamesStart=0,e.yearNamingRule=l.Default,e.yearNames=[],n=!0}return n}}class O{static timestamp(){return ee.instance.activeCalendar.year.toSeconds()}static timestampPlusInterval(e,t){const a=ee.instance.activeCalendar.year.clone();ee.instance.activeCalendar.gameSystem===g.PF2E&&ee.instance.activeCalendar.generalSettings.pf2eSync&&(e+=k.getWorldCreateSeconds());const n=a.secondsToDate(e);if(a.updateTime(n),t.year&&a.changeYear(t.year,!1,"current"),t.month){if(t.month>a.months.length){let e=Math.floor(t.month/a.months.length);t.month=t.month-e*a.months.length,a.changeYear(e,!1,"current")}a.changeMonth(t.month,"current")}if(t.day&&a.changeDayBulk(t.day),t.hour&&t.hour>a.time.hoursInDay){const e=Math.floor(t.hour/a.time.hoursInDay);t.hour=t.hour-e*a.time.hoursInDay,a.changeDayBulk(e)}if(t.minute&&t.minute>a.time.hoursInDay*a.time.minutesInHour){const e=Math.floor(t.minute/(a.time.hoursInDay*a.time.minutesInHour));t.minute=t.minute-e*(a.time.hoursInDay*a.time.minutesInHour),a.changeDayBulk(e)}if(t.second&&t.second>a.time.secondsPerDay){const e=Math.floor(t.second/a.time.secondsPerDay);t.second=t.second-e*a.time.secondsPerDay,a.changeDayBulk(e)}const s=a.time.changeTime(t.hour,t.minute,t.second);return 0!==s&&a.changeDay(s),a.toSeconds()}static timestampToDate(e){const t={year:0,month:0,dayOffset:0,day:0,dayOfTheWeek:0,hour:0,minute:0,second:0,yearZero:0,sunrise:0,sunset:0,midday:0,weekdays:[],showWeekdayHeadings:!0,currentSeason:{},isLeapYear:!1,monthName:"",dayDisplay:"",yearName:"",yearPrefix:"",yearPostfix:"",display:{date:"",day:"",daySuffix:"",weekday:"",monthName:"",month:"",year:"",yearName:"",yearPrefix:"",yearPostfix:"",time:""}};ee.instance.activeCalendar.gameSystem===g.PF2E&&ee.instance.activeCalendar.generalSettings.pf2eSync&&(e+=k.getWorldCreateSeconds());const a=ee.instance.activeCalendar.year.secondsToDate(e);t.year=a.year,t.month=a.month,t.day=a.day,t.hour=a.hour,t.minute=a.minute,t.second=a.seconds;const n=ee.instance.activeCalendar.year.months[a.month],s=n.days[a.day];return t.dayOffset=n.numericRepresentationOffset,t.yearZero=ee.instance.activeCalendar.year.yearZero,t.dayOfTheWeek=ee.instance.activeCalendar.year.dayOfTheWeek(t.year,n.numericRepresentation,s.numericRepresentation),t.currentSeason=ee.instance.activeCalendar.year.getSeason(a.month,a.day+1),t.weekdays=ee.instance.activeCalendar.year.weekdays.map((e=>e.name)),t.showWeekdayHeadings=ee.instance.activeCalendar.year.showWeekdayHeadings,t.isLeapYear=ee.instance.activeCalendar.year.leapYearRule.isLeapYear(t.year),t.sunrise=ee.instance.activeCalendar.year.getSunriseSunsetTime(t.year,n,s,!0),t.sunset=ee.instance.activeCalendar.year.getSunriseSunsetTime(t.year,n,s,!1),t.midday=this.dateToTimestamp({year:t.year,month:t.month,day:t.day,hour:0,minute:0,second:0})+Math.floor(ee.instance.activeCalendar.year.time.secondsPerDay/2),t.monthName=n.name,t.yearName=ee.instance.activeCalendar.year.getYearName(t.year),t.yearPrefix=ee.instance.activeCalendar.year.prefix,t.yearPostfix=ee.instance.activeCalendar.year.postfix,t.dayDisplay=s.numericRepresentation.toString(),t.display.year=a.year.toString(),t.display.yearName=ee.instance.activeCalendar.year.getYearName(t.year),t.display.yearPrefix=ee.instance.activeCalendar.year.prefix,t.display.yearPostfix=ee.instance.activeCalendar.year.postfix,t.display.month=n.numericRepresentation.toString(),t.display.monthName=n.name,ee.instance.activeCalendar.year.weekdays.length>t.dayOfTheWeek&&(t.display.weekday=ee.instance.activeCalendar.year.weekdays[t.dayOfTheWeek].name),t.display.day=s.numericRepresentation.toString(),t.display.daySuffix=T.ordinalSuffix(s.numericRepresentation),t.display.time=T.FormatDateTime({year:0,month:0,day:0,hour:t.hour,minute:t.minute,seconds:t.second},ee.instance.activeCalendar.generalSettings.dateFormat.time),t.display.date=T.FormatDateTime({year:t.year,month:n.numericRepresentation,day:s.numericRepresentation,hour:0,minute:0,seconds:0},ee.instance.activeCalendar.generalSettings.dateFormat.date),t}static dateToTimestamp(e){let t=0;const a=ee.instance.activeCalendar.year.clone(),n=a.getMonth(),s=a.time.getCurrentTime();if(void 0===e.second&&(e.second=s.seconds),void 0===e.minute&&(e.minute=s.minute),void 0===e.hour&&(e.hour=s.hour),void 0===e.year&&(e.year=a.numericRepresentation),void 0===e.month&&(e.month=n?a.months.findIndex((e=>e.numericRepresentation===n.numericRepresentation)):0),void 0===e.day&&(e.day=0,n)){const t=n.getDay();t&&(e.day=n.days.findIndex((e=>e.numericRepresentation===t.numericRepresentation)))}return a.updateMonth(e.month,"current",!0,e.day),a.numericRepresentation=e.year,a.time.setTime(e.hour,e.minute,e.second),t=a.toSeconds(),t}static secondsToInterval(e){return ee.instance.activeCalendar.year.secondsToInterval(e)}static clockStatus(){const e=ee.instance.activeCalendar.year.time.timeKeeper.getStatus();return{started:e===f.Started,stopped:e===f.Stopped,paused:e===f.Paused}}static showCalendar(t=null,a=!1){if(null!==t){if(t.year||(t.year=ee.instance.activeCalendar.year.numericRepresentation),!t.month||!t.day){const e=ee.instance.activeCalendar.year.getMonth();if(t.month||(t.month=e?ee.instance.activeCalendar.year.months.findIndex((t=>t.numericRepresentation===e.numericRepresentation)):0),!t.day)if(e){const a=e.getDay();t.day=a?e.days.findIndex((e=>e.numericRepresentation===a.numericRepresentation)):0}else t.day=0}if(Number.isInteger(t.year)&&Number.isInteger(t.month)&&Number.isInteger(t.day)){const e=ee.instance.activeCalendar.year.leapYearRule.isLeapYear(t.year);ee.instance.activeCalendar.year.visibleYear=t.year,(-1===t.month||t.month>ee.instance.activeCalendar.year.months.length)&&(t.month=ee.instance.activeCalendar.year.months.length-1),ee.instance.activeCalendar.year.resetMonths("visible"),ee.instance.activeCalendar.year.months[t.month].visible=!0;const a=e?ee.instance.activeCalendar.year.months[t.month].numberOfLeapYearDays:ee.instance.activeCalendar.year.months[t.month].numberOfDays;t.day>0&&(t.day=t.day-1),(-1==t.day||t.day>a)&&(t.day=a-1),ee.instance.activeCalendar.year.resetMonths("selected"),ee.instance.activeCalendar.year.months[t.month].days[t.day].selected=!0,ee.instance.activeCalendar.year.months[t.month].selected=!0,ee.instance.activeCalendar.year.selectedYear=ee.instance.activeCalendar.year.visibleYear}else e.error("SimpleCalendar.api.showCalendar: Invalid date passed in.")}ee.instance.compactView=a,ee.instance.showApp()}static changeDate(t){if(ee.instance.activeCalendar.canUser(game.user,ee.instance.activeCalendar.generalSettings.permissions.changeDateTime)){let a=!1;if(t.year&&(ee.instance.activeCalendar.year.changeYear(t.year,!0,"current"),a=!0),t.month&&(ee.instance.activeCalendar.year.changeMonth(t.month,"current"),a=!0),t.day&&(ee.instance.activeCalendar.year.changeDay(t.day),a=!0),t.hour||t.minute||t.second){const e=ee.instance.activeCalendar.year.time.changeTime(t.hour,t.minute,t.second);0!==e&&ee.instance.activeCalendar.year.changeDay(e),a=!0}return a&&($.SaveCurrentDate(ee.instance.activeCalendar.year).catch(e.error),ee.instance.activeCalendar.syncTime().catch(e.error),ee.instance.updateApp()),!0}return $.UiNotification($.Localize("FSC.Warn.Macros.GMUpdate"),"warn"),!1}static setDate(t){if(ee.instance.activeCalendar.canUser(game.user,ee.instance.activeCalendar.generalSettings.permissions.changeDateTime)){const a=this.dateToTimestamp(t);return ee.instance.activeCalendar.year.updateTime(ee.instance.activeCalendar.year.secondsToDate(a)),$.SaveCurrentDate(ee.instance.activeCalendar.year).catch(e.error),ee.instance.activeCalendar.syncTime().catch(e.error),ee.instance.updateApp(),!0}return $.UiNotification($.Localize("FSC.Warn.Macros.GMUpdate"),"warn"),!1}static advanceTimeToPreset(t){if(ee.instance.activeCalendar.canUser(game.user,ee.instance.activeCalendar.generalSettings.permissions.changeDateTime)){let a=0;if(t===y.Sunrise||t===y.Sunset){let e=ee.instance.activeCalendar.year.getMonth();if(e){let n=e.getDay();n&&(a=ee.instance.activeCalendar.year.getSunriseSunsetTime(ee.instance.activeCalendar.year.numericRepresentation,e,n,t===y.Sunrise,!1),ee.instance.activeCalendar.year.time.seconds>=a&&(ee.instance.activeCalendar.year.changeDay(1,"current"),e=ee.instance.activeCalendar.year.getMonth(),e&&(n=e.getDay(),n&&(a=ee.instance.activeCalendar.year.getSunriseSunsetTime(ee.instance.activeCalendar.year.numericRepresentation,e,n,t===y.Sunrise,!1)))))}}else t===y.Midday?(a=Math.floor(ee.instance.activeCalendar.year.time.secondsPerDay/2),ee.instance.activeCalendar.year.time.seconds>=a&&ee.instance.activeCalendar.year.changeDay(1,"current")):t===y.Midnight&&ee.instance.activeCalendar.year.changeDay(1,"current");return ee.instance.activeCalendar.year.time.seconds=a,$.SaveCurrentDate(ee.instance.activeCalendar.year).catch(e.error),ee.instance.activeCalendar.syncTime(!0).catch(e.error),!0}return!1}static chooseRandomDate(e={},t={}){let a=0,n=0,s=0,i=0,r=0,o=0;a=void 0!==e.year&&void 0!==t.year?e.year===t.year?e.year:Math.floor(Math.random()*(t.year-e.year+1))+e.year:Math.floor(1e4*Math.random()),n=void 0!==e.month&&void 0!==t.month?e.month===t.month?e.month:Math.floor(Math.random()*(t.month-e.month+1))+e.month:Math.floor(Math.random()*ee.instance.activeCalendar.year.months.length),(n<0||n>=ee.instance.activeCalendar.year.months.length)&&(n=ee.instance.activeCalendar.year.months.length-1);let c=ee.instance.activeCalendar.year.months[n];return s=void 0!==e.day&&void 0!==t.day?e.day===t.day?e.day:Math.floor(Math.random()*(t.day-e.day+1))+e.day:Math.floor(Math.random()*c.days.length),(s<0||s>=c.days.length)&&(s=c.days.length-1),i=void 0!==e.hour&&void 0!==t.hour?e.hour===t.hour?e.hour:Math.floor(Math.random()*(t.hour-e.hour+1))+e.hour:Math.floor(Math.random()*ee.instance.activeCalendar.year.time.hoursInDay),r=void 0!==e.minute&&void 0!==t.minute?e.minute===t.minute?e.minute:Math.floor(Math.random()*(t.minute-e.minute+1))+e.minute:Math.floor(Math.random()*ee.instance.activeCalendar.year.time.minutesInHour),o=void 0!==e.second&&void 0!==t.second?e.second===t.second?e.second:Math.floor(Math.random()*(t.second-e.second+1))+e.second:Math.floor(Math.random()*ee.instance.activeCalendar.year.time.secondsInMinute),{year:a,month:n,day:s,hour:i,minute:r,second:o}}static isPrimaryGM(){return!!ee.instance&&ee.instance.primary}static startClock(){return!!ee.instance.primary&&(ee.instance.activeCalendar.year.time.timeKeeper.start(),!0)}static stopClock(){return ee.instance.activeCalendar.year.time.timeKeeper.stop(),!0}static formatDateTime(e){const t=e.year?e.year:0;let a=e.month&&e.month>=0?e.month:0;a>=ee.instance.activeCalendar.year.months.length&&(a=ee.instance.activeCalendar.year.months.length-1);const n=ee.instance.activeCalendar.year.months[a];let s=e.day&&e.day>=0?e.day:0;s>=n.days.length&&(s=n.days.length-1);const i=n.days[s];let r=e.hour&&e.hour>=0?e.hour:0;r>=ee.instance.activeCalendar.year.time.hoursInDay&&(r=ee.instance.activeCalendar.year.time.hoursInDay-1);let o=e.minute&&e.minute>=0?e.minute:0;o>=ee.instance.activeCalendar.year.time.minutesInHour&&(o=ee.instance.activeCalendar.year.time.minutesInHour-1);let c=e.second&&e.second>=0?e.second:0;return c>=ee.instance.activeCalendar.year.time.secondsInMinute&&(c=ee.instance.activeCalendar.year.time.secondsInMinute-1),{date:T.FormatDateTime({year:t,month:n.numericRepresentation,day:i.numericRepresentation,hour:0,minute:0,seconds:0},ee.instance.activeCalendar.generalSettings.dateFormat.date),time:T.FormatDateTime({year:0,month:0,day:0,hour:r,minute:o,seconds:c},ee.instance.activeCalendar.generalSettings.dateFormat.time)}}static getCurrentDay(){const e=ee.instance.activeCalendar.year.getMonth();if(e){const t=e.getDay();if(t)return t.toConfig()}return null}static getLeapYearConfiguration(){return ee.instance.activeCalendar.year.leapYearRule.toConfig()}static getCurrentMonth(){const e=ee.instance.activeCalendar.year.getMonth();return e?e.toConfig():null}static getAllMonths(){return ee.instance.activeCalendar.year.months.map((e=>e.toConfig()))}static getAllMoons(){return ee.instance.activeCalendar.year.moons.map((e=>{const t=e.toConfig();return t.currentPhase=e.getMoonPhase(ee.instance.activeCalendar.year),t}))}static getCurrentSeason(){const e=ee.instance.activeCalendar.year.clone(),t=e.getMonth("current");if(t){const a=e.months.findIndex((e=>e.numericRepresentation==t.numericRepresentation)),n=t.getDay();if(n)return e.getSeason(a,n.numericRepresentation).toConfig()}return{name:"",color:""}}static getAllSeasons(){return ee.instance.activeCalendar.year.seasons.map((e=>e.toConfig()))}static getTimeConfiguration(){return ee.instance.activeCalendar.year.time.toConfig()}static getCurrentWeekday(){const e=ee.instance.activeCalendar.year.getMonth();if(e){const t=e.getDay();if(t){const a=ee.instance.activeCalendar.year.dayOfTheWeek(ee.instance.activeCalendar.year.numericRepresentation,e.numericRepresentation,t.numericRepresentation);return ee.instance.activeCalendar.year.weekdays[a].toConfig()}}return null}static getAllWeekdays(){return ee.instance.activeCalendar.year.weekdays.map((e=>e.toConfig()))}static getCurrentYear(){return ee.instance.activeCalendar.year.toConfig()}static async configureCalendar(e){if($.IsGm()){if("string"==typeof e){const t=ee.instance.activeCalendar.year.clone(),a=Y.setToPredefined(t,e);return await $.SaveYearConfiguration(t),await $.SaveMonthConfiguration(t.months),await $.SaveWeekdayConfiguration(t.weekdays),await $.SaveLeapYearRules(t.leapYearRule),await $.SaveTimeConfiguration(t.time),await $.SaveSeasonConfiguration(t.seasons),await $.SaveMoonConfiguration(t.moons),await $.SaveCurrentDate(t),a}if(Object.keys(e).length)return e.hasOwnProperty("yearSettings")&&await game.settings.set(t,s.YearConfiguration,e.yearSettings),e.hasOwnProperty("monthSettings")&&await game.settings.set(t,s.MonthConfiguration,e.monthSettings),e.hasOwnProperty("weekdaySettings")&&await game.settings.set(t,s.WeekdayConfiguration,e.weekdaySettings),e.hasOwnProperty("leapYearSettings")&&await game.settings.set(t,s.LeapYearRule,e.leapYearSettings),e.hasOwnProperty("timeSettings")&&await game.settings.set(t,s.TimeConfiguration,e.timeSettings),e.hasOwnProperty("seasonSettings")&&await game.settings.set(t,s.SeasonConfiguration,e.seasonSettings),e.hasOwnProperty("moonSettings")&&await game.settings.set(t,s.MoonConfiguration,e.moonSettings),e.hasOwnProperty("generalSettings")&&await game.settings.set(t,s.GeneralConfiguration,e.generalSettings),e.hasOwnProperty("noteCategories")&&await game.settings.set(t,s.NoteCategories,e.noteCategories),e.hasOwnProperty("currentDate")&&await game.settings.set(t,s.CurrentDate,e.currentDate),!0}return!1}static async calendarWeatherImport(){return!0}}O.DateSelector=R,O.Calendars=i,O.LeapYearRules=c,O.MoonIcons=m,O.MoonYearResetOptions=u,O.YearNamingRules=l,O.PresetTimeOfDay=y;class j{static emit(t,a){let n={};if(ee.instance){if(t===p.DateTimeChange){n.date=O.timestampToDate(ee.instance.activeCalendar.year.toSeconds()),n.diff=a,n.moons=[],n.season={},n.month={},n.day={},n.time={},n.year={number:ee.instance.activeCalendar.year.numericRepresentation,prefix:ee.instance.activeCalendar.year.prefix,postfix:ee.instance.activeCalendar.year.postfix,isLeapYear:ee.instance.activeCalendar.year.leapYearRule.isLeapYear(ee.instance.activeCalendar.year.numericRepresentation)};const e=ee.instance.activeCalendar.year.getMonth();if(e){n.month={name:e.name,number:e.numericRepresentation,intercalary:e.intercalary,numberOfDays:e.numberOfDays,numberOfLeapYearDays:e.numberOfLeapYearDays};const t=e.getDay();t&&(n.day={number:t.numericRepresentation})}n.time=ee.instance.activeCalendar.year.time.getCurrentTime(),n.season=ee.instance.activeCalendar.year.getCurrentSeason();for(let e=0;e<ee.instance.activeCalendar.year.moons.length;e++){const t=ee.instance.activeCalendar.year.moons[e].getMoonPhase(ee.instance.activeCalendar.year);n.moons.push({name:ee.instance.activeCalendar.year.moons[e].name,color:ee.instance.activeCalendar.year.moons[e].color,cycleLength:ee.instance.activeCalendar.year.moons[e].cycleLength,cycleDayAdjust:ee.instance.activeCalendar.year.moons[e].cycleDayAdjust,currentPhase:t})}}else t===p.ClockStartStop?n=O.clockStatus():t===p.PrimaryGM&&(n.isPrimaryGM=O.isPrimaryGM());Hooks.callAll(t,n)}else e.error("Simple Calendar instance is not defined.")}}class G{static aboutTimeV1(){let e=!1;const t=game.modules.get("about-time");if(t&&t.active){const a=t.data.version.split("."),n=parseInt(a[0]);!isNaN(n)&&n>=1&&(e=!0)}return e}static async importAboutTime(e){const t=game.settings.get("about-time","savedCalendar");if(t){e.time.hoursInDay=t.hours_per_day,e.time.minutesInHour=t.minutes_per_hour,e.time.secondsInMinute=t.seconds_per_minute,e.weekdays=[];for(let a=0;a<t.weekdays.length;a++)e.weekdays.push(new P(a+1,t.weekdays[a]));e.months=[];let a=1,n=1;for(let s in t.month_len)if(t.month_len.hasOwnProperty(s)){const i=new I(s,a,0,t.month_len[s].days[0],t.month_len[s].days[1]);t.month_len[s].intercalary?(i.numericRepresentation=-1*n,i.intercalary=!0,i.intercalaryInclude=!1,n++):a++,e.months.push(i)}if(e.leapYearRule.rule=c.None,"(year) => Math.floor(year / 4) - Math.floor(year / 100) + Math.floor(year / 400)"===t.leap_year_rule)e.leapYearRule.rule=c.Gregorian;else{const a=t.leap_year_rule.match(/(\d)/g);a&&a.length&&"0"!==a[0]&&(e.leapYearRule.rule=c.Custom,e.leapYearRule.customMod=parseInt(a[0]))}const s=e.secondsToDate(game.time.worldTime);e.updateTime(s),await $.SaveYearConfiguration(e),await $.SaveMonthConfiguration(e.months),await $.SaveWeekdayConfiguration(e.weekdays),await $.SaveLeapYearRules(e.leapYearRule),await $.SaveTimeConfiguration(e.time),await $.SaveCurrentDate(e)}}static async exportToAboutTime(e,t=!1){if(G.aboutTimeV1()&&!t)return;const a={};for(let t=0;t<e.months.length;t++){let n=e.months[t].numberOfLeapYearDays;e.leapYearRule.rule===c.None&&(n=e.months[t].numberOfDays),a[e.months[t].name]={days:[e.months[t].numberOfDays,n],intercalary:e.months[t].intercalary}}const n={first_day:0,clock_start_year:e.yearZero,has_year_0:0===e.yearZero,notes:{},hours_per_day:e.time.hoursInDay,minutes_per_hour:e.time.minutesInHour,seconds_per_minute:e.time.secondsInMinute,weekdays:e.weekdays.map((e=>e.name)),leap_year_rule:"(year) => 0",month_len:a,_month_len:{}};e.leapYearRule.rule===c.Gregorian?n.leap_year_rule="(year) => Math.floor(year / 4) - Math.floor(year / 100) + Math.floor(year / 400)":e.leapYearRule.rule===c.Custom&&(n.leap_year_rule=`(year) => Math.floor(year / ${e.leapYearRule.customMod} ) + 1`),game.settings.set("about-time","savedCalendar",n),ee.instance.activeCalendar.gameSystem!==g.PF2E&&await game.settings.set("about-time","timeZeroOffset",""),0!==game.settings.get("about-time","calendar")&&await game.settings.set("about-time","calendar",0)}static async importCalendarWeather(e){const t=game.settings.get("calendar-weather","dateTime");if(t){e.weekdays=[];for(let a=0;a<t.daysOfTheWeek.length;a++)e.weekdays.push(new P(a+1,t.daysOfTheWeek[a]));e.months=[];let a=1,n=1;for(let s=0;s<t.months.length;s++){let i=parseInt(t.months[s].length.toString()),r=parseInt(t.months[s].leapLength.toString());isNaN(i)&&(i=1),isNaN(r)&&(r=1);const o=new I(t.months[s].name,a,0,i,r);t.months[s].isNumbered?a++:(o.numericRepresentation=-1*n,o.intercalary=!0,o.intercalaryInclude=!1,n++),e.months.push(o)}e.leapYearRule.rule=c.None,e.numericRepresentation=parseInt(t.year.toString()),e.postfix=t.era,e.yearZero=0;const s=e.secondsToDate(game.time.worldTime);e.updateTime(s),e.seasons=[];for(let a=0;a<t.seasons.length;a++){let n=parseInt(t.seasons[a].date.month.toString());isNaN(n)&&(n=1);const s=new x(t.seasons[a].name,n,t.seasons[a].date.day);switch(t.seasons[a].color){case"red":s.color="#b12e2e";break;case"orange":s.color="#b1692e";break;case"yellow":s.color="#b99946";break;case"green":s.color="#258e25";break;case"blue":s.color="#5b80a5"}e.seasons.push(s)}e.moons=[];for(let a=0;a<t.moons.length;a++){const n=new W(t.moons[a].name,t.moons[a].cycleLength);let s=t.moons[a].cyclePercent/100;t.moons[a].isWaxing||(s=.5);const i=e.time.secondsPerDay*(n.cycleLength*s),r=e.secondsToDate(t.moons[a].referenceTime+i);n.firstNewMoon.year=r.year,n.firstNewMoon.month=e.months[r.month].numericRepresentation,n.firstNewMoon.day=e.months[r.month].days[r.day].numericRepresentation;const o=Number(((n.cycleLength-4)/4).toPrecision(5));n.phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:o,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:o,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:o,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:o,icon:m.WaningCrescent,singleDay:!1}],e.moons.push(n)}if(ee.instance){for(let a=0;a<t.events.length;a++){const n=t.events[a],s=new E;s.title=n.name,s.content=n.text,s.allDay=n.allDay,s.year=parseInt(n.date.year.toString()),s.endDate.year=s.year;let i=e.months.findIndex((e=>e.numericRepresentation===parseInt(n.date.month)||e.name===n.date.month));i<0&&(i=0),s.month=e.months[i].numericRepresentation,s.endDate.month=s.month,s.day=n.date.day,s.endDate.day=s.day,s.hour=n.date.hours,s.minute=n.date.minutes,s.endDate.hour=s.hour,s.endDate.minute=s.minute,ee.instance.activeCalendar.notes.push(s)}for(let a=0;a<t.reEvents.length;a++){const n=t.reEvents[a],s=new E;s.title=n.name,s.content=n.text,s.year=0,s.endDate.year=s.year;let i=e.months.findIndex((e=>e.numericRepresentation===parseInt(n.date.month)||e.name===n.date.month));i<0&&(i=0),s.month=e.months[i].numericRepresentation,s.endDate.month=s.month,s.day=n.date.day,s.endDate.day=s.day,s.hour=0,s.minute=0,s.endDate.hour=s.hour,s.endDate.minute=s.minute,s.repeats=r.Yearly,ee.instance.activeCalendar.notes.push(s)}await $.SaveNotes(ee.instance.activeCalendar.notes)}await $.SaveYearConfiguration(e),await $.SaveMonthConfiguration(e.months),await $.SaveWeekdayConfiguration(e.weekdays),await $.SaveLeapYearRules(e.leapYearRule),await $.SaveTimeConfiguration(e.time),await $.SaveSeasonConfiguration(e.seasons),await $.SaveMoonConfiguration(e.moons),await $.SaveCurrentDate(e)}}static async exportCalendarWeather(e){const t=game.settings.get("calendar-weather","dateTime");if(t){const a=[];for(let t=0;t<e.months.length;t++)a.push({name:e.months[t].name,length:e.months[t].numberOfDays,leapLength:e.months[t].numberOfLeapYearDays,isNumbered:!e.months[t].intercalary,abbrev:e.months[t].intercalary?e.months[t].name.substring(0,2):""});const n=[];for(let t=0;t<e.seasons.length;t++)n.push({name:e.seasons[t].name,color:"",dawn:6,dusk:19,humidity:"=",rolltable:"",temp:"=",date:{day:e.seasons[t].startingDay-1,month:"",combined:"-"+(e.seasons[t].startingDay-1),year:e.numericRepresentation.toString(),hours:0,minutes:0,seconds:0}});const s=[];for(let t=0;t<e.moons.length;t++)s.push({isWaxing:!1,name:e.moons[t].name,cycleLength:e.moons[t].cycleLength,cyclePercent:0,lunarEclipseChange:0,solarEclipseChange:0,referencePercent:0,referenceTime:e.time.getTotalSeconds(e.dateToDays(e.moons[t].firstNewMoon.year,e.moons[t].firstNewMoon.month,e.moons[t].firstNewMoon.day,!0,!0))});const i=e.getMonth(),r=null==i?void 0:i.getDay(),o=e.weekdays.map((e=>e.name)),c=e.dayOfTheWeek(e.numericRepresentation,i?i.numericRepresentation:1,r?r.numericRepresentation:1);t.months=a,t.daysOfTheWeek=o,t.year=e.numericRepresentation,t.currentMonth=i?i.numericRepresentation-1:0,t.day=r?r.numericRepresentation-1:0,t.numDayOfTheWeek=c,t.currentWeekday=o[c],t.era="",t.dayLength=e.time.hoursInDay,t.first_day=0,t.seasons=n,t.moons=s,await game.settings.set("calendar-weather","dateTime",t),await G.exportToAboutTime(e),window.location.reload()}}}var A=a(162);class z extends FormApplication{constructor(e){super(e||ee.instance.activeCalendar.clone()),this.noteCategories=[],this.yearChanged=!1,this.generalSettings={defaultPlayerNoteVisibility:!0},this.dateFormatTableExpanded=!1,this.calendar=e||ee.instance.activeCalendar,this._tabs[0].active="generalSettings",this.generalSettings.defaultPlayerNoteVisibility=$.GetDefaultNoteVisibility(),this.noteCategories=ee.instance.activeCalendar.noteCategories.map((e=>({name:e.name,color:e.color,textColor:e.textColor})))}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/foundryvtt-simple-calendar/templates/calendar-config.html",e.title="FSC.Configuration.Title",e.classes=["simple-calendar-configuration"],e.resizable=!0,e.tabs=[{navSelector:".tabs",contentSelector:"form",initial:"yearSettings"}],e.height=700,e.width=1005,e}showApp(){this.render(!0)}closeApp(){this.close().catch(e.error)}updateApp(){this.render(!1)}getData(e){let t={...super.getData(e),showDateFormatTokens:this.dateFormatTableExpanded,defaultPlayerNoteVisibility:this.generalSettings.defaultPlayerNoteVisibility,gameSystem:this.object.gameSystem,currentYear:this.object.year,generalSettings:this.object.generalSettings,months:this.object.year.months.map((e=>e.toTemplate())),weekdays:this.object.year.weekdays.map((e=>e.toTemplate())),leapYearRules:{none:"FSC.Configuration.LeapYear.Rules.None",gregorian:"FSC.Configuration.LeapYear.Rules.Gregorian",custom:"FSC.Configuration.LeapYear.Rules.Custom"},leapYearRule:this.object.year.leapYearRule,showLeapYearCustomMod:this.object.year.leapYearRule.rule===c.Custom,showLeapYearMonths:this.object.year.leapYearRule.rule!==c.None,predefined:{gregorian:"FSC.Configuration.LeapYear.Rules.Gregorian",darksun:"Dark Sun",eberron:"Eberron",exandrian:"Exandrian","forbidden-lands":"Forbidden Lands",harptos:"Forgotten Realms: Harptos",golarianpf1e:"Golarian: Pathfinder 1E",golarianpf2e:"Golarian: Pathfinder 2E",greyhawk:"Greyhawk","traveller-ic":"Traveller: Imperial Calendar",warhammer:"Warhammer: Imperial Calendar"},timeTrackers:{none:"FSC.Configuration.General.None",self:"FSC.Configuration.General.Self","third-party":"FSC.Configuration.General.ThirdParty",mixed:"FSC.Configuration.General.Mixed"},importing:{showAboutTime:!1,aboutTimeV1:G.aboutTimeV1(),showCalendarWeather:!1},monthStartingWeekdays:{},seasons:this.object.year.seasons.map((e=>e.toTemplate(this.object.year))),seasonColors:[{value:"#ffffff",display:$.Localize("FSC.Configuration.Season.ColorWhite")},{value:"#fffce8",display:$.Localize("FSC.Configuration.Season.ColorSpring")},{value:"#f3fff3",display:$.Localize("FSC.Configuration.Season.ColorSummer")},{value:"#fff7f2",display:$.Localize("FSC.Configuration.Season.ColorFall")},{value:"#f2f8ff",display:$.Localize("FSC.Configuration.Season.ColorWinter")}],moons:this.object.year.moons.map((e=>e.toTemplate(this.object.year))),moonIcons:{},moonYearReset:{none:"FSC.Configuration.Moon.YearResetNo","leap-year":"FSC.Configuration.Moon.YearResetLeap","x-years":"FSC.Configuration.Moon.YearResetX"},yearNameBehaviourOptions:{default:"Default",repeat:"PLAYLIST.SoundRepeat",random:"FSC.Random"},users:{},noteCategories:[]};const a=game.modules.get("calendar-weather"),n=game.modules.get("about-time");t.importing.showCalendarWeather=void 0!==a&&a.active,t.importing.showAboutTime=void 0!==n&&n.active,t.moonIcons[m.NewMoon]=$.Localize("FSC.Moon.Phase.New"),t.moonIcons[m.WaxingCrescent]=$.Localize("FSC.Moon.Phase.WaxingCrescent"),t.moonIcons[m.FirstQuarter]=$.Localize("FSC.Moon.Phase.FirstQuarter"),t.moonIcons[m.WaxingGibbous]=$.Localize("FSC.Moon.Phase.WaxingGibbous"),t.moonIcons[m.Full]=$.Localize("FSC.Moon.Phase.Full"),t.moonIcons[m.WaningGibbous]=$.Localize("FSC.Moon.Phase.WaningGibbous"),t.moonIcons[m.LastQuarter]=$.Localize("FSC.Moon.Phase.LastQuarter"),t.moonIcons[m.WaningCrescent]=$.Localize("FSC.Moon.Phase.WaningCrescent"),t.monthStartingWeekdays.null=$.Localize("Default");for(let e=0;e<this.object.year.weekdays.length;e++)t.monthStartingWeekdays[this.object.year.weekdays[e].numericRepresentation.toString()]=this.object.year.weekdays[e].name;const s=game.users;return s&&s.forEach((e=>{e.isGM||null===e.id||(t.users[e.id]=e.name?e.name:"")})),ee.instance&&(t.noteCategories=this.noteCategories),t}_updateObject(e,t){return Promise.resolve(void 0)}activateListeners(e){super.activateListeners(e),this.object.year.seasons.forEach((e=>e.activateDateSelectors())),e.hasOwnProperty("length")&&(e.find(".date-format-token-show").on("click",this.dateFormatTableClick.bind(this)),e.find(".month-show-advanced").on("click",this.inputChange.bind(this)),e.find("#scSubmit").on("click",this.saveClick.bind(this)),e.find("#scApplyPredefined").on("click",this.overwriteConfirmationDialog.bind(this,"predefined","")),e.find(".remove-month").on("click",this.removeFromTable.bind(this,"month")),e.find(".remove-weekday").on("click",this.removeFromTable.bind(this,"weekday")),e.find(".remove-season").on("click",this.removeFromTable.bind(this,"season")),e.find(".remove-moon").on("click",this.removeFromTable.bind(this,"moon")),e.find(".remove-moon-phase").on("click",this.removeFromTable.bind(this,"moon-phase")),e.find(".remove-year-name").on("click",this.removeFromTable.bind(this,"year-name")),e.find(".remove-note-category").on("click",this.removeFromTable.bind(this,"note-category")),e.find(".month-add").on("click",this.addToTable.bind(this,"month")),e.find(".weekday-add").on("click",this.addToTable.bind(this,"weekday")),e.find(".season-add").on("click",this.addToTable.bind(this,"season")),e.find(".moon-add").on("click",this.addToTable.bind(this,"moon")),e.find(".moon-phase-add").on("click",this.addToTable.bind(this,"moon-phase")),e.find(".year-name-add").on("click",this.addToTable.bind(this,"year-name")),e.find(".note-category-add").on("click",this.addToTable.bind(this,"note-category")),e.find("#scAboutTimeImport").on("click",this.overwriteConfirmationDialog.bind(this,"tp-import","about-time")),e.find("#scAboutTimeExport").on("click",this.overwriteConfirmationDialog.bind(this,"tp-export","about-time")),e.find("#scCalendarWeatherImport").on("click",this.overwriteConfirmationDialog.bind(this,"tp-import","calendar-weather")),e.find("#scCalendarWeatherExport").on("click",this.overwriteConfirmationDialog.bind(this,"tp-export","calendar-weather")),e.find("#exportCalendar").on("click",this.exportCalendar.bind(this)),e.find("#importCalendar").on("click",this.importCalendar.bind(this)),e.find(".general-settings input").on("change",this.inputChange.bind(this)),e.find(".note-settings input").on("change",this.inputChange.bind(this)),e.find(".year-settings input").on("change",this.inputChange.bind(this)),e.find(".year-settings select").on("change",this.inputChange.bind(this)),e.find(".month-settings input").on("change",this.inputChange.bind(this)),e.find(".month-settings select").on("change",this.inputChange.bind(this)),e.find(".weekday-settings input").on("change",this.inputChange.bind(this)),e.find(".weekday-settings select").on("change",this.inputChange.bind(this)),e.find(".leapyear-settings input").on("change",this.inputChange.bind(this)),e.find(".leapyear-settings select").on("change",this.inputChange.bind(this)),e.find(".time-settings input").on("change",this.inputChange.bind(this)),e.find(".moon-settings input").on("change",this.inputChange.bind(this)),e.find(".moon-settings select").on("change",this.inputChange.bind(this)))}dateFormatTableClick(){this.dateFormatTableExpanded=!this.dateFormatTableExpanded,this.updateApp()}rebaseMonthNumbers(){let e=0,t=0;for(let a=0;a<this.object.year.months.length;a++){const n=this.object.year.months[a];n.intercalary?(t++,n.numericRepresentation=-1*t):(n.numericRepresentation=e+1,e=n.numericRepresentation)}}addToTable(e,t){switch(t.preventDefault(),e.toLowerCase()){case"month":const e=this.object.year.months.length+1;this.object.year.months.push(new I("New Month",e,0,30)),this.rebaseMonthNumbers();break;case"weekday":const a=this.object.year.weekdays.length+1;this.object.year.weekdays.push(new P(a,"New Weekday"));break;case"season":this.object.year.seasons.push(new x("New Season",1,1));break;case"moon":const n=new W("Moon",29.53059);n.firstNewMoon={yearReset:u.None,yearX:0,year:0,month:1,day:1};const s=Number(((n.cycleLength-4)/4).toPrecision(5));n.phases=[{name:$.Localize("FSC.Moon.Phase.New"),length:1,icon:m.NewMoon,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingCrescent"),length:s,icon:m.WaxingCrescent,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.FirstQuarter"),length:1,icon:m.FirstQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaxingGibbous"),length:s,icon:m.WaxingGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.Full"),length:1,icon:m.Full,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningGibbous"),length:s,icon:m.WaningGibbous,singleDay:!1},{name:$.Localize("FSC.Moon.Phase.LastQuarter"),length:1,icon:m.LastQuarter,singleDay:!0},{name:$.Localize("FSC.Moon.Phase.WaningCrescent"),length:s,icon:m.WaningCrescent,singleDay:!1}],this.object.year.moons.push(n);break;case"moon-phase":const i=t.currentTarget.getAttribute("data-moon-index");if(i){const e=parseInt(i);!isNaN(e)&&e<this.object.year.moons.length&&(this.object.year.moons[e].phases.push({name:"Phase",length:1,icon:m.NewMoon,singleDay:!1}),this.object.year.moons[e].updatePhaseLength())}break;case"year-name":this.object.year.yearNames.push("New Named Year");break;case"note-category":this.noteCategories.push({name:"New Category",color:"#b13737 ",textColor:"#ffffff"})}this.updateApp()}removeFromTable(e,t){t.preventDefault();const a=e.toLowerCase(),n=t.currentTarget.getAttribute("data-index");if(n&&"all"!==n){const e=parseInt(n);if(!isNaN(e)){switch(a){case"month":if(e<this.object.year.months.length){this.object.year.months.splice(e,1);for(let e=0;e<this.object.year.months.length;e++)this.object.year.months[e].numericRepresentation=e+1;this.rebaseMonthNumbers()}break;case"weekday":if(e<this.object.year.weekdays.length){this.object.year.weekdays.splice(e,1);for(let e=0;e<this.object.year.weekdays.length;e++)this.object.year.weekdays[e].numericRepresentation=e+1}break;case"season":e<this.object.year.seasons.length&&this.object.year.seasons.splice(e,1);break;case"moon":e<this.object.year.moons.length&&this.object.year.moons.splice(e,1);break;case"moon-phase":const a=t.currentTarget.getAttribute("data-moon-index");if(a){const t=parseInt(a);!isNaN(t)&&t<this.object.year.moons.length&&e<this.object.year.moons[t].phases.length&&(this.object.year.moons[t].phases.splice(e,1),this.object.year.moons[t].updatePhaseLength())}break;case"year-name":e<this.object.year.yearNames.length&&this.object.year.yearNames.splice(e,1);break;case"note-category":e<this.noteCategories.length&&this.noteCategories.splice(e,1)}this.updateApp()}}else if(n&&"all"===n){switch(a){case"month":this.object.year.months=[];break;case"weekday":this.object.year.weekdays=[];break;case"season":this.object.year.seasons=[];break;case"moon":this.object.year.moons=[];break;case"moon-phase":const e=t.currentTarget.getAttribute("data-moon-index");if(e){const t=parseInt(e);!isNaN(t)&&t<this.object.year.moons.length&&(this.object.year.moons[t].phases=[])}break;case"year-name":this.object.year.yearNames=[];break;case"note-category":this.noteCategories=[]}this.updateApp()}}predefinedApplyConfirm(){const t=document.getElementById("scPreDefined").value;e.debug(`Overwriting the existing calendar configuration with the "${t}" configuration`),Y.setToPredefined(this.object.year,t),this.yearChanged=!0,this.updateApp()}inputChange(t){e.debug("Input has changed, updating configuration object");const a=t.currentTarget.id,n=t.currentTarget.getAttribute("class"),s=t.currentTarget.getAttribute("data-index");let i=t.currentTarget.value;const r=t.currentTarget.checked;if(i&&(i=i.trim()),a&&"-"!==a[0]){if(e.debug(`ID "${a}" change found`),"scDefaultPlayerVisibility"===a)this.generalSettings.defaultPlayerNoteVisibility=r;else if("scGameWorldTime"===a)this.object.generalSettings.gameWorldTimeIntegration=i;else if("scShowClock"===a)this.object.generalSettings.showClock=r;else if("scPF2ESync"===a)this.object.generalSettings.pf2eSync=r;else if("scDateFormatsDate"===a)this.object.generalSettings.dateFormat.date=i;else if("scDateFormatsTime"===a)this.object.generalSettings.dateFormat.time=i;else if("scDateFormatsMonthYear"===a)this.object.generalSettings.dateFormat.monthYear=i;else if("scCalendarVisibleP"===a)this.object.generalSettings.permissions.viewCalendar.player=r;else if("scCalendarVisibleTP"===a)this.object.generalSettings.permissions.viewCalendar.trustedPlayer=r;else if("scCalendarVisibleAGM"===a)this.object.generalSettings.permissions.viewCalendar.assistantGameMaster=r;else if("scAddNotesP"===a)this.object.generalSettings.permissions.addNotes.player=r;else if("scAddNotesTP"===a)this.object.generalSettings.permissions.addNotes.trustedPlayer=r;else if("scAddNotesAGM"===a)this.object.generalSettings.permissions.addNotes.assistantGameMaster=r;else if("scChangeDateTimeP"===a)this.object.generalSettings.permissions.changeDateTime.player=r;else if("scChangeDateTimeTP"===a)this.object.generalSettings.permissions.changeDateTime.trustedPlayer=r;else if("scChangeDateTimeAGM"===a)this.object.generalSettings.permissions.changeDateTime.assistantGameMaster=r;else if("scReorderNotesP"===a)this.object.generalSettings.permissions.reorderNotes.player=r;else if("scReorderNotesTP"===a)this.object.generalSettings.permissions.reorderNotes.trustedPlayer=r;else if("scReorderNotesAGM"===a)this.object.generalSettings.permissions.reorderNotes.assistantGameMaster=r;else if("scCurrentYear"===a){const e=parseInt(i);isNaN(e)||(this.object.year.numericRepresentation=e,this.yearChanged=!0)}else if("scYearPreFix"===a)this.object.year.prefix=i;else if("scYearPostFix"===a)this.object.year.postfix=i;else if("scYearZero"===a){const e=parseInt(i);isNaN(e)||(this.object.year.yearZero=e)}else if("scYearNameBehaviour"===a)this.object.year.yearNamingRule=i;else if("scYearNamesStart"===a){const e=parseInt(i);isNaN(e)||(this.object.year.yearNamesStart=e)}else if("scShowWeekdayHeaders"===a)this.object.year.showWeekdayHeadings=r;else if("scWeekdayFirstDay"===a){const e=parseInt(i);isNaN(e)||(this.object.year.firstWeekday=e)}else if("scLeapYearRule"===a)this.object.year.leapYearRule.rule=i;else if("scLeapYearCustomMod"===a){const e=parseInt(i);isNaN(e)||(this.object.year.leapYearRule.customMod=e)}else if("scHoursInDay"===a){const e=parseInt(i);isNaN(e)||(this.object.year.time.hoursInDay=e)}else if("scMinutesInHour"===a){const e=parseInt(i);isNaN(e)||(this.object.year.time.minutesInHour=e)}else if("scSecondsInMinute"===a){const e=parseInt(i);isNaN(e)||(this.object.year.time.secondsInMinute=e)}else if("scSecondsInCombatRound"===a){const e=parseInt(i);isNaN(e)||(this.object.year.time.secondsInCombatRound=e)}else if("scGameTimeRatio"===a){const e=parseFloat(i);isNaN(e)||(this.object.year.time.gameTimeRatio=e)}else if("scUnifyClockWithFoundryPause"===a)this.object.year.time.unifyGameAndClockPause=r;else if("scTimeUpdateFrequency"===a){const e=parseInt(i);isNaN(e)||(this.object.year.time.updateFrequency=e)}this.updateApp()}else if(n){if(e.debug(`CSS Class "${n}" change found`),s){const a=parseInt(s);if(e.debug(`Indexed item (${a}) changed.`),!isNaN(a))if("year-name"===n&&this.object.year.yearNames.length>a)this.object.year.yearNames[a]=i;else if("season-name"===n&&this.object.year.seasons.length>a)this.object.year.seasons[a].name=i;else if("season-color"===n&&this.object.year.seasons.length>a)this.object.year.seasons[a].color=i;else if("month-show-advanced"===n&&this.object.year.months.length>a)this.object.year.months[a].showAdvanced=!this.object.year.months[a].showAdvanced;else if("month-name"===n&&this.object.year.months.length>a)this.object.year.months[a].name=i,this.object.year.months[a].abbreviation=i.substring(0,3);else if("month-abbreviation"===n)this.object.year.months[a].abbreviation=i;else if("month-days"===n&&this.object.year.months.length>a){let e=parseInt(i);isNaN(e)||e===this.object.year.months[a].days.length||(this.object.year.months[a].numberOfDays=e,this.object.year.leapYearRule.rule===c.None&&(this.object.year.months[a].numberOfLeapYearDays=e),this.updateMonthDays(this.object.year.months[a]))}else if("month-intercalary"===n&&this.object.year.months.length>a){this.object.year.months[a].intercalary=r;const e=this.element.find(`.month-intercalary-include[data-index='${s}']`).parent().parent().parent();this.object.year.months[a].intercalary?e.removeClass("hidden"):e.addClass("hidden"),this.rebaseMonthNumbers()}else if("month-intercalary-include"===n&&this.object.year.months.length>a)this.object.year.months[a].intercalaryInclude=r,this.rebaseMonthNumbers();else if("month-numeric-representation-offset"===n&&this.object.year.months.length>a){let e=parseInt(i);isNaN(e)||(this.object.year.months[a].numericRepresentationOffset=e)}else if("month-starting-weekday"===n&&this.object.year.months.length>a){let e=parseInt(i);isNaN(e)?this.object.year.months[a].startingWeekday=null:this.object.year.months[a].startingWeekday=e}else if("weekday-name"===n&&this.object.year.weekdays.length>a)this.object.year.weekdays[a].name=i,this.object.year.weekdays[a].abbreviation=i.substring(0,2);else if("weekday-abbreviation"===n&&this.object.year.weekdays.length>a)this.object.year.weekdays[a].abbreviation=i;else if("month-leap-days"===n&&this.object.year.months.length>a){const e=parseInt(i);isNaN(e)||e===this.object.year.months[a].numberOfLeapYearDays||(this.object.year.months[a].numberOfLeapYearDays=e,this.updateMonthDays(this.object.year.months[a]))}else if("moon-name"===n&&this.object.year.moons.length>a)this.object.year.moons[a].name=i;else if("moon-cycle-length"===n&&this.object.year.moons.length>a){const e=parseFloat(i);isNaN(e)||(this.object.year.moons[a].cycleLength=e,this.object.year.moons[a].updatePhaseLength())}else if("moon-cycle-adjustment"===n&&this.object.year.moons.length>a){const e=parseFloat(i);isNaN(e)||(this.object.year.moons[a].cycleDayAdjust=e)}else if("moon-year-reset"===n&&this.object.year.moons.length>a)this.object.year.moons[a].firstNewMoon.yearReset=i;else if("moon-year-x"===n&&this.object.year.moons.length>a){const e=parseInt(i);isNaN(e)||(this.object.year.moons[a].firstNewMoon.yearX=e)}else if("moon-year"===n&&this.object.year.moons.length>a){const e=parseInt(i);isNaN(e)||(this.object.year.moons[a].firstNewMoon.year=e)}else if("moon-month"===n&&this.object.year.moons.length>a){const e=parseInt(i);isNaN(e)||(this.object.year.moons[a].firstNewMoon.month=e,this.object.year.moons[a].firstNewMoon.day=1)}else if("moon-day"===n&&this.object.year.moons.length>a){const e=parseInt(i);isNaN(e)||(this.object.year.moons[a].firstNewMoon.day=e)}else if("moon-color"===n&&this.object.year.moons.length>a)"#"!==i[0]&&(i="#"+i),this.object.year.moons[a].color=i;else if("moon-phase-name"===n||"moon-phase-single-day"===n||"moon-phase-icon"===n){const e=t.currentTarget.getAttribute("data-moon-index");if(e){const t=parseInt(e);!isNaN(t)&&this.object.year.moons.length>t&&this.object.year.moons[t].phases.length>a&&("moon-phase-name"===n?this.object.year.moons[t].phases[a].name=i:"moon-phase-single-day"===n?(this.object.year.moons[t].phases[a].singleDay=r,this.object.year.moons[t].updatePhaseLength()):"moon-phase-icon"===n&&(this.object.year.moons[t].phases[a].icon=i))}}else if("note-category-name"===n&&this.noteCategories.length>a){const e=this.noteCategories[a].name;this.noteCategories[a].name=i,a<ee.instance.activeCalendar.noteCategories.length&&ee.instance.activeCalendar.notes.forEach((t=>{const a=t.categories.indexOf(e);a>-1&&(t.categories[a]=i)}))}else"note-category-color"===n&&this.noteCategories.length>a&&(this.noteCategories[a].color=i,this.noteCategories[a].textColor=T.GetContrastColor(i))}this.updateApp()}}updateMonthDays(t){t.numberOfDays<0&&(t.numberOfDays=0),t.numberOfLeapYearDays<0&&(t.numberOfLeapYearDays=t.numberOfDays);const a=t.numberOfLeapYearDays>t.numberOfDays?t.numberOfLeapYearDays:t.numberOfDays,n=t.getDay();let s=null;n&&(n.numericRepresentation>=t.numberOfDays?(e.debug("The current day falls outside of the months new days, setting to first day of the month."),s=0):s=n.numericRepresentation),t.days=[],t.populateDays(a,s)}overwriteConfirmationDialog(e,t,a){a.preventDefault(),new Dialog({title:$.Localize("FSC.OverwriteConfirm"),content:$.Localize("FSC.OverwriteConfirmText"),buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:$.Localize("FSC.Apply"),callback:this.overwriteConfirmationYes.bind(this,e,t)},no:{icon:'<i class="fas fa-times"></i>',label:$.Localize("FSC.Cancel")}},default:"no"}).render(!0)}async overwriteConfirmationYes(e,t){"predefined"===e?this.predefinedApplyConfirm():"tp-import"===e?"about-time"===t?(await G.importAboutTime(this.object.year),this.updateApp()):"calendar-weather"===t&&(await G.importCalendarWeather(this.object.year),this.updateApp()):"tp-export"===e&&("about-time"===t?await G.exportToAboutTime(this.object.year):"calendar-weather"===t&&await G.exportCalendarWeather(this.object.year))}async saveClick(t){t.preventDefault();try{if(this.object.year.leapYearRule.rule===c.None)for(let e=0;e<this.object.year.months.length;e++)this.object.year.months[e].numberOfLeapYearDays=this.object.year.months[e].numberOfDays;this.object.generalSettings.gameWorldTimeIntegration=document.getElementById("scGameWorldTime").value,await $.SaveGeneralSettings(this.object.generalSettings);const e=parseInt(document.getElementById("scCurrentYear").value);isNaN(e)||(this.object.year.numericRepresentation=e,this.object.year.selectedYear=e,this.object.year.visibleYear=e),await $.SaveYearConfiguration(this.object.year),await $.SaveMonthConfiguration(this.object.year.months),await $.SaveWeekdayConfiguration(this.object.year.weekdays),await $.SaveLeapYearRules(this.object.year.leapYearRule),await $.SaveTimeConfiguration(this.object.year.time),await $.SaveSeasonConfiguration(this.object.year.seasons),await $.SaveMoonConfiguration(this.object.year.moons),this.yearChanged&&await $.SaveCurrentDate(this.object.year);const t=document.getElementById("scDefaultPlayerVisibility").checked;await $.SetDefaultNoteVisibility(t),await $.SaveNoteCategories(this.noteCategories),await ee.instance.activeCalendar.syncTime(!0),this.closeApp()}catch(t){e.error(t)}}exportCalendar(e){e.preventDefault();const t={currentDate:$.LoadCurrentDate(),generalSettings:$.LoadGeneralSettings(),leapYearSettings:$.LoadLeapYearRules(),monthSettings:$.LoadMonthData(),moonSettings:$.LoadMoonData(),noteCategories:$.LoadNoteCategories(),seasonSettings:$.LoadSeasonData(),timeSettings:$.LoadTimeData(),weekdaySettings:$.LoadWeekdayData(),yearSettings:$.LoadYearData()};(0,A.saveAs)(new Blob([JSON.stringify(t)],{type:"application/json"}),"simple-calendar-export.json")}importCalendar(e){e.preventDefault();const t=document.getElementById("-scImportCalendarPicker");if(t&&t.files&&t.files.length){const e=new FileReader;e.onload=this.importOnLoad.bind(this,e),e.readAsText(t.files[0])}else $.UiNotification($.Localize("FSC.Importer.NoFile"),"warn")}async importOnLoad(e,a){try{if(e.result){const a=JSON.parse(e.result.toString());a.hasOwnProperty("yearSettings")&&await game.settings.set(t,s.YearConfiguration,a.yearSettings),a.hasOwnProperty("monthSettings")&&await game.settings.set(t,s.MonthConfiguration,a.monthSettings),a.hasOwnProperty("weekdaySettings")&&await game.settings.set(t,s.WeekdayConfiguration,a.weekdaySettings),a.hasOwnProperty("leapYearSettings")&&await game.settings.set(t,s.LeapYearRule,a.leapYearSettings),a.hasOwnProperty("timeSettings")&&await game.settings.set(t,s.TimeConfiguration,a.timeSettings),a.hasOwnProperty("seasonSettings")&&await game.settings.set(t,s.SeasonConfiguration,a.seasonSettings),a.hasOwnProperty("moonSettings")&&await game.settings.set(t,s.MoonConfiguration,a.moonSettings),a.hasOwnProperty("generalSettings")&&await game.settings.set(t,s.GeneralConfiguration,a.generalSettings),a.hasOwnProperty("noteCategories")&&await game.settings.set(t,s.NoteCategories,a.noteCategories),a.hasOwnProperty("currentDate")&&await game.settings.set(t,s.CurrentDate,a.currentDate),this.closeApp()}}catch(e){$.UiNotification($.Localize("FSC.Importer.InvalidSCConfig"),"error")}}}class H{static on(e){const t=game.socket;t&&t.on(n,e)}static async emit(e){const t=game.socket;return!!t&&(await t.emit(n,e),!0)}}class ${static IsGm(){const e=game.user;return!!e&&e.isGM}static UserName(){const e=game.user;return e&&e.name?e.name:""}static UserID(){const e=game.user;return e&&e.id?e.id:""}static GetUser(e){const t=game.users;if(t)return t.find((t=>t.id===e))}static Localize(e){if(game.i18n)return game.i18n.localize(e);{const t=e.split(".");return t[t.length-1]}}static RegisterSettings(){game.settings.registerMenu(t,s.CalendarConfigurationMenu,{name:"",label:"FSC.Configuration.Title",hint:"",icon:"fa fa-cog",type:z,restricted:!0}),game.settings.register(t,s.GeneralConfiguration,{name:"General Configuration",scope:"world",config:!1,type:Object,onChange:ee.instance.settingUpdate.bind(ee.instance,!0,"general")}),game.settings.register(t,s.YearConfiguration,{name:"Year Configuration",scope:"world",config:!1,type:Object,onChange:ee.instance.settingUpdate.bind(ee.instance,!0,"year")}),game.settings.register(t,s.WeekdayConfiguration,{name:"Weekday Configuration",scope:"world",config:!1,type:Array,default:[],onChange:ee.instance.settingUpdate.bind(ee.instance,!0,"weekday")}),game.settings.register(t,s.MonthConfiguration,{name:"Month Configuration",scope:"world",config:!1,type:Array,default:[],onChange:ee.instance.settingUpdate.bind(ee.instance,!0,"month")}),game.settings.register(t,s.CurrentDate,{name:"Current Date",scope:"world",config:!1,type:Object,onChange:ee.instance.settingUpdate.bind(ee.instance,!0,"current")}),game.settings.register(t,s.LeapYearRule,{name:"Leap Year Rule",scope:"world",config:!1,type:Object,onChange:ee.instance.settingUpdate.bind(ee.instance,!0,"leapyear")}),game.settings.register(t,s.DefaultNoteVisibility,{name:"FSC.Configuration.DefaultNoteVisibility",hint:"FSC.Configuration.DefaultNoteVisibilityHint",scope:"world",type:Boolean,default:!1}),game.settings.register(t,s.Notes,{name:"Notes",scope:"world",config:!1,type:Array,default:[],onChange:ee.instance.settingUpdate.bind(ee.instance,!0,"notes")}),game.settings.register(t,s.TimeConfiguration,{name:"Time",scope:"world",config:!1,type:Object,default:{},onChange:ee.instance.settingUpdate.bind(ee.instance,!0,"time")}),game.settings.register(t,s.SeasonConfiguration,{name:"Season Configuration",scope:"world",config:!1,type:Array,default:[],onChange:ee.instance.settingUpdate.bind(ee.instance,!0,"season")}),game.settings.register(t,s.MoonConfiguration,{name:"Moon Configuration",scope:"world",config:!1,type:Array,default:[],onChange:ee.instance.settingUpdate.bind(ee.instance,!0,"moon")}),game.settings.register(t,s.NoteCategories,{name:"Note Categories",scope:"world",config:!1,type:Array,default:[{name:"Holiday",color:"#148e94",textColor:"#FFFFFF"}],onChange:ee.instance.settingUpdate.bind(ee.instance,!0,"note-categories")}),game.settings.register("about-time","savedCalendar",{name:"Hidden",hint:"Don't touch this",default:{},type:Object,scope:"world",config:!1})}static GetDefaultNoteVisibility(){return game.settings.get(t,s.DefaultNoteVisibility)}static LoadGeneralSettings(){return game.settings.get(t,s.GeneralConfiguration)}static LoadYearData(){return game.settings.get(t,s.YearConfiguration)}static LoadCurrentDate(){return game.settings.get(t,s.CurrentDate)}static LoadMonthData(){let e=[],a=game.settings.get(t,s.MonthConfiguration);return a&&a.length&&(e=Array.isArray(a[0])?a[0]:a),e}static LoadWeekdayData(){let e=[],a=game.settings.get(t,s.WeekdayConfiguration);return a&&a.length&&(e=Array.isArray(a[0])?a[0]:a),e}static LoadSeasonData(){let e=[],a=game.settings.get(t,s.SeasonConfiguration);return a&&a.length&&(e=Array.isArray(a[0])?a[0]:a),e}static LoadMoonData(){let e=[],a=game.settings.get(t,s.MoonConfiguration);return a&&a.length&&(e=Array.isArray(a[0])?a[0]:a),e}static LoadLeapYearRules(){return game.settings.get(t,s.LeapYearRule)}static LoadTimeData(){return game.settings.get(t,s.TimeConfiguration)}static LoadNotes(){let e=[],a=game.settings.get(t,s.Notes);return a&&a.length&&(e=Array.isArray(a[0])?a[0]:a),e}static LoadNoteCategories(){let e=[],a=game.settings.get(t,s.NoteCategories);return a&&a.length&&(e=Array.isArray(a[0])?a[0]:a),e}static async SaveGeneralSettings(a){if($.IsGm()){e.debug("Saving General Settings.");const n=$.LoadGeneralSettings();if(JSON.stringify(a)!==JSON.stringify(n))return game.settings.set(t,s.GeneralConfiguration,a).then((()=>!0));e.debug("General Settings have not changed, not updating.")}return!1}static async SaveCurrentDate(a,n=!0){if($.IsGm()){e.debug("Saving current date.");const i=a.getMonth();if(i){const r=i.getDay();if(r){const o=game.settings.get(t,s.CurrentDate),c={year:a.numericRepresentation,month:i.numericRepresentation,day:r.numericRepresentation,seconds:a.time.seconds};if(o.year!==c.year||o.month!==c.month||o.day!==c.day||o.seconds!==c.seconds){if(await game.settings.set(t,s.CurrentDate,c),n&&ee.instance){const e=a.toSeconds()-(T.ToSeconds(o.year,o.month,o.day,!1)+o.seconds);await H.emit({type:h.emitHook,data:{hook:p.DateTimeChange,param:e}}),j.emit(p.DateTimeChange,e)}return await H.emit({type:h.noteReminders,data:{justTimeChange:o.seconds!==c.seconds&&o.day===c.day}}),ee.instance&&ee.instance.checkNoteReminders(o.seconds!==c.seconds&&o.day===c.day),!0}e.debug("Current Date data has not changed, not updating settings")}else e.error("Unable to save current date, no current day found.")}else e.error("Unable to save current date, no current month found.")}else e.error("Unable to save current date, no current year found.");return!1}static async SaveYearConfiguration(a){if($.IsGm()){e.debug("Saving year configuration.");const n=game.settings.get(t,s.YearConfiguration);n.hasOwnProperty("showWeekdayHeadings")||(n.showWeekdayHeadings=!0);const i=a.toConfig();if(JSON.stringify(n)!==JSON.stringify(i))return game.settings.set(t,s.YearConfiguration,i).then((()=>!0));e.debug("Year configuration has not changed, not updating settings")}return!1}static async SaveMonthConfiguration(a){if($.IsGm()){e.debug("Saving month configuration.");const n=JSON.stringify($.LoadMonthData()),i=a.map((e=>e.toConfig()));if(n!==JSON.stringify(i))return game.settings.set(t,s.MonthConfiguration,i).then((()=>!0));e.debug("Month configuration has not changed, not updating settings")}return!1}static async SaveWeekdayConfiguration(a){if($.IsGm()){e.debug("Saving weekday configuration.");const n=JSON.stringify($.LoadWeekdayData()),i=a.map((e=>e.toConfig()));if(n!==JSON.stringify(i))return game.settings.set(t,s.WeekdayConfiguration,i).then((()=>!0));e.debug("Weekday configuration has not changed, not updating settings")}return!1}static async SaveSeasonConfiguration(a){if($.IsGm()){e.debug("Saving season configuration.");const n=JSON.stringify($.LoadSeasonData()),i=a.map((e=>e.toConfig()));if(n!==JSON.stringify(i))return game.settings.set(t,s.SeasonConfiguration,i).then((()=>!0));e.debug("Season configuration has not changed, not updating.")}return!1}static async SaveMoonConfiguration(a){if($.IsGm()){e.debug("Saving moon configuration.");const n=JSON.stringify($.LoadMoonData()),i=a.map((e=>e.toConfig()));if(n!==JSON.stringify(i))return game.settings.set(t,s.MoonConfiguration,i).then((()=>!0));e.debug("Moon configuration has not changed, not updating.")}return!1}static async SaveLeapYearRules(a){if($.IsGm()){e.debug("Saving leap year configuration.");const n=$.LoadLeapYearRules(),i=a.toConfig();if(n.rule!==i.rule||n.customMod!==i.customMod)return game.settings.set(t,s.LeapYearRule,i);e.debug("Leap Year configuration has not changed, not updating settings")}return!1}static async SaveTimeConfiguration(a){if($.IsGm()){e.debug("Saving time configuration.");const n=$.LoadTimeData(),i=a.toConfig();if(JSON.stringify(n)!==JSON.stringify(i))return game.settings.set(t,s.TimeConfiguration,i).then((()=>!0));e.debug("Time configuration has not changed, not updating settings")}return!1}static async SaveNoteCategories(a){if(e.debug("Saving Note Categories."),$.IsGm()){const n=$.LoadNoteCategories();if(JSON.stringify(n)!==JSON.stringify(a))return game.settings.set(t,s.NoteCategories,a).then((()=>!0));e.debug("Note Categories have not changed, not updating")}return!1}static async SaveNotes(a){e.debug("Saving notes.");const n=a.map((e=>({title:e.title,content:e.content,author:e.author,year:e.year,month:e.month,day:e.day,monthDisplay:e.monthDisplay,playerVisible:e.playerVisible,id:e.id,repeats:e.repeats,allDay:e.allDay,hour:e.hour,minute:e.minute,endDate:e.endDate,order:e.order,categories:e.categories,remindUsers:e.remindUsers})));if($.IsGm())return game.settings.set(t,s.Notes,n).then((()=>!0));{const t={type:h.journal,data:{notes:a}};return e.debug("User saving notes..."),void await H.emit(t)}}static async SetDefaultNoteVisibility(e){return!!$.IsGm()&&await game.settings.set(t,s.DefaultNoteVisibility,e).then((()=>!0))}static UiNotification(t,a="info"){ui.notifications?"info"===a?ui.notifications.info(t):"warn"===a?ui.notifications.warn(t):"error"===a&&ui.notifications.error(t):e.error("The UI class is not initialized.")}}class E extends L{constructor(){super(),this.year=0,this.month=0,this.monthDisplay="",this.day=0,this.hour=0,this.minute=0,this.allDay=!0,this.endDate={year:0,month:0,day:0,hour:0,minute:0,seconds:0},this.title="",this.content="",this.author="",this.playerVisible=!1,this.repeats=r.Never,this.order=0,this.categories=[],this.remindUsers=[],this.reminderSent=!1}initialize(e,t,a,n){this.year=e,this.month=t,this.day=a,this.endDate.year=e,this.endDate.month=t,this.endDate.day=a,this.monthDisplay=n,this.author=$.UserID(),this.playerVisible=$.GetDefaultNoteVisibility()}toTemplate(){const e=$.GetUser(this.author);let t;t=e?{name:e.name,color:e.data.color?e.data.color:"",textColor:T.GetContrastColor(e.data.color?e.data.color:"")}:null;let a=!1;return this.remindUsers.indexOf($.UserID())>-1&&(a=!0),{...super.toTemplate(),title:this.title,content:this.content,playerVisible:this.playerVisible,author:this.author,authorDisplay:t,monthDisplay:this.monthDisplay,allDay:this.allDay,displayDate:T.GetDisplayDate({year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,allDay:this.allDay},{year:this.endDate.year,month:this.endDate.month,day:this.endDate.day,hour:this.endDate.hour?this.endDate.hour:0,minute:this.endDate.minute?this.endDate.minute:0,allDay:this.allDay},!0),hour:this.hour,minute:this.minute,endDate:this.endDate,order:this.order,categories:ee.instance.activeCalendar.noteCategories.filter((e=>this.categories.includes(e.name))),reminder:a}}loadFromSettings(e){e&&Object.keys(e).length&&(this.id=e.id,this.year=e.year,this.month=e.month,this.day=e.day,this.monthDisplay=e.monthDisplay,this.title=e.title,this.content=e.content,this.author=e.author,this.playerVisible=e.playerVisible,this.repeats=e.repeats,e.hasOwnProperty("allDay")&&(this.allDay=e.allDay),e.hasOwnProperty("hour")&&(this.hour=e.hour),e.hasOwnProperty("minute")&&(this.minute=e.minute),e.hasOwnProperty("endDate")?this.endDate={year:e.endDate.year,month:e.endDate.month,day:e.endDate.day,hour:e.endDate.hour,minute:e.endDate.minute,seconds:0}:this.endDate={year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,seconds:0},e.hasOwnProperty("order")&&(this.order=e.order),e.hasOwnProperty("categories")&&(this.categories=e.categories),e.hasOwnProperty("remindUsers")&&(this.remindUsers=e.remindUsers))}clone(){const e=new E;return e.id=this.id,e.year=this.year,e.month=this.month,e.day=this.day,e.monthDisplay=this.monthDisplay,e.allDay=this.allDay,e.hour=this.hour,e.minute=this.minute,e.title=this.title,e.content=this.content,e.author=this.author,e.playerVisible=this.playerVisible,e.repeats=this.repeats,e.endDate={year:this.endDate.year,month:this.endDate.month,day:this.endDate.day,hour:this.endDate.hour,minute:this.endDate.minute,seconds:this.endDate.seconds},e.order=this.order,e.categories=[...this.categories],e.remindUsers=[...this.remindUsers],e}isVisible(e,t,a){const n=$.IsGm()||!$.IsGm()&&this.playerVisible;let s=!1;if(n){let n=o.None;if(this.repeats===r.Weekly){let s=0,i=0,r=1;s=ee.instance.activeCalendar.year.dayOfTheWeek(this.year,this.month,this.day),r=ee.instance.activeCalendar.year.dayOfTheWeek(e,t,a),i=ee.instance.activeCalendar.year.dayOfTheWeek(this.endDate.year,this.endDate.month,this.endDate.day),s===r?n=o.Start:i===r?n=o.End:(s<i&&s<r&&i>r||s>i&&(s<r&&i<r||s>r&&i>r))&&(n=o.Middle)}else if(this.repeats===r.Monthly){let s=t,i=t,r=e,c=e;if(this.month!==this.endDate.month){let l=ee.instance.activeCalendar.year.months.findIndex((e=>e.numericRepresentation===this.month)),h=ee.instance.activeCalendar.year.months.findIndex((e=>e.numericRepresentation===this.endDate.month)),d=ee.instance.activeCalendar.year.months.findIndex((e=>e.numericRepresentation===t)),m=h-l;if(l=d-m,l<0&&(l=ee.instance.activeCalendar.year.months.length-1,r--),h=d+m,h>=ee.instance.activeCalendar.year.months.length&&(h=0,c++),l>-1&&l<ee.instance.activeCalendar.year.months.length&&h>-1&&h<ee.instance.activeCalendar.year.months.length){s=ee.instance.activeCalendar.year.months[l].numericRepresentation,i=ee.instance.activeCalendar.year.months[h].numericRepresentation;const d=T.IsDayBetweenDates({year:e,month:t,day:a,allDay:!0,hour:0,minute:0},{year:e,month:t,day:this.day,allDay:!0,hour:0,minute:0},{year:c,month:i,day:this.endDate.day,allDay:!0,hour:0,minute:0}),m=T.IsDayBetweenDates({year:e,month:t,day:a,allDay:!0,hour:0,minute:0},{year:r,month:s,day:this.day,allDay:!0,hour:0,minute:0},{year:e,month:t,day:this.endDate.day,allDay:!0,hour:0,minute:0});d===o.None&&m===o.None||(n=o.Middle)}}else n=T.IsDayBetweenDates({year:e,month:t,day:a,allDay:!0,hour:0,minute:0},{year:e,month:s,day:this.day,allDay:!0,hour:0,minute:0},{year:e,month:i,day:this.endDate.day,allDay:!0,hour:0,minute:0})}else if(this.repeats===r.Yearly){let s=e,i=e;if(this.year!==this.endDate.year){const r=this.endDate.year-this.year;s=e-r,i=e+r;const c=T.IsDayBetweenDates({year:e,month:t,day:a,allDay:!0,hour:0,minute:0},{year:e,month:this.month,day:this.day,allDay:!0,hour:0,minute:0},{year:i,month:this.endDate.month,day:this.endDate.day,allDay:!0,hour:0,minute:0}),l=T.IsDayBetweenDates({year:e,month:t,day:a,allDay:!0,hour:0,minute:0},{year:s,month:this.month,day:this.day,allDay:!0,hour:0,minute:0},{year:e,month:this.endDate.month,day:this.endDate.day,allDay:!0,hour:0,minute:0});c===o.None&&l===o.None||(n=o.Middle)}else n=T.IsDayBetweenDates({year:e,month:t,day:a,allDay:!0,hour:0,minute:0},{year:e,month:this.month,day:this.day,allDay:!0,hour:0,minute:0},{year:e,month:this.endDate.month,day:this.endDate.day,allDay:!0,hour:0,minute:0})}else n=T.IsDayBetweenDates({year:e,month:t,day:a,allDay:!0,hour:0,minute:0},{year:this.year,month:this.month,day:this.day,allDay:!0,hour:0,minute:0},{year:this.endDate.year,month:this.endDate.month,day:this.endDate.day,allDay:!0,hour:0,minute:0});s=n!==o.None}return n&&s}display(){let e="",t=ee.instance.activeCalendar.year.visibleYear,a=ee.instance.activeCalendar.year.months.findIndex((e=>e.selected));-1===a&&(a=ee.instance.activeCalendar.year.months.findIndex((e=>e.current)));let n=ee.instance.activeCalendar.year.months[a].days.findIndex((e=>e.selected));-1===n&&(n=ee.instance.activeCalendar.year.months[a].days.findIndex((e=>e.current)));let s=ee.instance.activeCalendar.year.months.findIndex((e=>e.numericRepresentation===this.month)),i=ee.instance.activeCalendar.year.months.findIndex((e=>e.numericRepresentation===this.endDate.month));-1===s&&(s=0),-1===i&&(i=0);let o=ee.instance.activeCalendar.year.months[s].days.findIndex((e=>e.numericRepresentation===this.day)),c=ee.instance.activeCalendar.year.months[i].days.findIndex((e=>e.numericRepresentation===this.endDate.day)),l=this.year,h=this.month,d=this.day,m=this.endDate.year,u=this.endDate.month,y=this.endDate.day;if(this.repeats===r.Weekly){l=t,m=t;let e=a,s=a,i=this.day,r=this.endDate.day;const o=ee.instance.activeCalendar.year.months[a].days[n].numericRepresentation;let c=ee.instance.activeCalendar.year.dayOfTheWeek(this.year,this.month,d),g=ee.instance.activeCalendar.year.dayOfTheWeek(this.endDate.year,this.endDate.month,y),p=ee.instance.activeCalendar.year.dayOfTheWeek(ee.instance.activeCalendar.year.visibleYear,ee.instance.activeCalendar.year.months[a].numericRepresentation,o),f=ee.instance.activeCalendar.year.daysIntoWeeks(ee.instance.activeCalendar.year.months[a],t,ee.instance.activeCalendar.year.weekdays.length);for(let e=0;e<f.length;e++){const t=f[e].find((e=>!1!==e&&!0!==e&&e.numericRepresentation===o));!1!==t&&!0!==t&&void 0!==t&&(g<c?p<=g?(r=f[e][g].numericRepresentation,i=e>0?f[e-1][c].numericRepresentation:void 0):(i=f[e][c].numericRepresentation,r=e<f.length-1?f[e+1][g].numericRepresentation:void 0):(i=f[e][c].numericRepresentation,r=f[e][g].numericRepresentation))}if(void 0===i){e>0?e--:(l--,e=ee.instance.activeCalendar.year.months.length-1),f=ee.instance.activeCalendar.year.daysIntoWeeks(ee.instance.activeCalendar.year.months[e],l,ee.instance.activeCalendar.year.weekdays.length);let t=f.length-1;for(;t>=0&&(!1!==f[t][c]&&(i=f[t][c].numericRepresentation),t--,void 0===i););}if(void 0===r){s<ee.instance.activeCalendar.year.months.length-1?s++:(m++,s=0),f=ee.instance.activeCalendar.year.daysIntoWeeks(ee.instance.activeCalendar.year.months[s],m,ee.instance.activeCalendar.year.weekdays.length);let e=0;for(;e<f.length&&(!1!==f[e][g]&&(r=f[e][g].numericRepresentation),e++,void 0===r););}h=ee.instance.activeCalendar.year.months[e].numericRepresentation,u=ee.instance.activeCalendar.year.months[s].numericRepresentation,d=i||1,y=r||1}else if(this.repeats===r.Monthly){l=t,m=t;let e=a,r=a;if(this.month!==this.endDate.month){const d=i-s;o<=n?(r=a+d,r>=ee.instance.activeCalendar.year.months.length&&(r=0,m=t+1)):c>=n&&(e=a-d,e<0&&(e=ee.instance.activeCalendar.year.months.length-1,l=t-1)),h=ee.instance.activeCalendar.year.months[e].numericRepresentation,u=ee.instance.activeCalendar.year.months[r].numericRepresentation}else h=ee.instance.activeCalendar.year.months[a].numericRepresentation,u=ee.instance.activeCalendar.year.months[a].numericRepresentation;o>=ee.instance.activeCalendar.year.months[e].days.length&&(d=ee.instance.activeCalendar.year.leapYearRule.isLeapYear(l)?ee.instance.activeCalendar.year.months[e].numberOfLeapYearDays:ee.instance.activeCalendar.year.months[e].numberOfDays),c>=ee.instance.activeCalendar.year.months[r].days.length&&(y=ee.instance.activeCalendar.year.leapYearRule.isLeapYear(m)?ee.instance.activeCalendar.year.months[r].numberOfLeapYearDays:ee.instance.activeCalendar.year.months[r].numberOfDays)}else if(this.repeats===r.Yearly)if(this.year!==this.endDate.year){const e=this.endDate.year-this.year;s===a&&o<=n?(l=t,m=t+e):i===a&&c>=n&&(l=t-e,m=t)}else l=t,m=t;return e=T.GetDisplayDate({year:l,month:h,day:d,hour:this.hour,minute:this.minute,allDay:this.allDay},{year:m,month:u,day:y,hour:this.endDate.hour,minute:this.endDate.minute,allDay:this.allDay}),e}}class U extends FormApplication{constructor(e,t=!1){super(e),this.hasBeenResized=!1,this.dateSelectorId="",this.dateSelector=null,this.initialLoad=!0,this.viewMode=t,this.updateNote=!1,$.IsGm()||(this.object.playerVisible=!0),this.dateSelectorId=`scNoteDate_${e.id}`,this.dateSelector=R.GetSelector(this.dateSelectorId,{onDateSelect:this.dateSelectorClick.bind(this),placeHolderText:"",dateRangeSelect:!0,showDate:!0,showTime:!0,startDate:{year:e.year,month:e.month,day:e.day,hour:e.hour,minute:e.minute,seconds:0},endDate:e.endDate,allDay:e.allDay})}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/foundryvtt-simple-calendar/templates/calendar-notes.html",e.title="FSC.Notes.DialogTitle",e.classes=["form","simple-calendar-note"],e.resizable=!0,e.closeOnSubmit=!1,e.width=500,e}checkForThirdPartyMarkdownEditors(){const e=game.modules.get("markdown-editor");return void 0!==e&&e.active}getData(t){let a={...super.getData(t),isGM:$.IsGm(),viewMode:this.viewMode,canEdit:$.IsGm()||$.UserID()===this.object.author,enableRichTextEditButton:this.checkForThirdPartyMarkdownEditors(),enrichedContent:TextEditor.enrichHTML(this.object.content),displayDate:"",repeatOptions:{0:"FSC.Notes.Repeat.Never",1:"FSC.Notes.Repeat.Weekly",2:"FSC.Notes.Repeat.Monthly",3:"FSC.Notes.Repeat.Yearly"},repeats:this.object.repeats,repeatsText:"",reminder:this.object.remindUsers.indexOf($.UserID())>-1,authDisplay:{name:"",color:"",textColor:""},dateSelectorId:this.dateSelectorId,categories:ee.instance.activeCalendar.noteCategories.filter((e=>this.object.categories.includes(e.name))),allCategories:ee.instance.activeCalendar.noteCategories.map((e=>({name:e.name,color:e.color,textColor:e.textColor,selected:void 0!==this.object.categories.find((t=>t===e.name))})))};const n=T.DaysBetweenDates({year:this.object.year,month:this.object.month,day:this.object.day,hour:0,minute:0,seconds:0},{year:this.object.endDate.year,month:this.object.endDate.month,day:this.object.endDate.day,hour:0,minute:0,seconds:0});n>=ee.instance.activeCalendar.year.totalNumberOfDays(!1,!0)?a.repeatOptions={0:"FSC.Notes.Repeat.Never"}:n>=ee.instance.activeCalendar.year.months[0].days.length?a.repeatOptions={0:"FSC.Notes.Repeat.Never",3:"FSC.Notes.Repeat.Yearly"}:n>=ee.instance.activeCalendar.year.weekdays.length&&(a.repeatOptions={0:"FSC.Notes.Repeat.Never",2:"FSC.Notes.Repeat.Monthly",3:"FSC.Notes.Repeat.Yearly"}),a.displayDate=this.object.display();const s=a.repeatOptions[a.repeats];s&&(a.repeatsText=`${$.Localize("FSC.Notes.Repeats")} ${$.Localize(s)}`);const i=game.users;if(i){e.debug(`Looking for users with the id "${this.object.author}"`);const t=i.get(this.object.author);t&&(a.authDisplay={name:t.name?t.name:"",color:t.data.color?t.data.color:"",textColor:T.GetContrastColor(t.data.color?t.data.color:"")})}return a}_onResize(e){super._onResize(e),this.hasBeenResized=!0}setWidthHeight(e){if(this.hasBeenResized)return;let t=window.innerWidth/2,a=0,n=16;const s=e.find("form");if(s){a+=s.outerHeight(!0)||0,n+=s.outerWidth(!0)||0}n>t&&(n=t),n<440&&(n=440),a+=46,a<250&&(a=250),this.setPosition({width:n,height:a})}activateListeners(e){var t;super.activateListeners(e),this.setWidthHeight(e),e.hasOwnProperty("length")&&(null===(t=this.dateSelector)||void 0===t||t.activateListeners(),this.element.find("#scNoteTitle").on("change",this.inputChanged.bind(this)),this.element.find("#scNoteRepeats").on("change",this.inputChanged.bind(this)),this.element.find("#scNoteVisibility").on("change",this.inputChanged.bind(this)),this.element.find("#scNoteDateAllDay").on("change",this.inputChanged.bind(this)),this.element.find('input[name="scNoteCategories"]').on("change",this.inputChanged.bind(this)),this.element.find("h1 .reminder input").on("change",this.reminderChange.bind(this)),e.find("#scSubmit").on("click",this.saveButtonClick.bind(this)),e.find("#scNoteEdit").on("click",this.editButtonClick.bind(this)),e.find("#scNoteDelete").on("click",this.deleteButtonClick.bind(this)),this.initialLoad&&(this.initialLoad=!1,setTimeout(this.focusTitleInput.bind(this),1e3)))}focusTitleInput(){this.element.find("#scNoteTitle").focus()}inputChanged(t){e.debug("Input has changed, updating note object");const a=t.currentTarget.id,n=t.currentTarget.name;let s=t.currentTarget.value;const i=t.currentTarget.checked;if(s&&(s=s.trim()),a&&"-"!==a[0])if(e.debug(`ID "${a}" change found`),"scNoteTitle"===a)this.object.title=s;else if("scNoteRepeats"===a){const e=parseInt(s);isNaN(e)?this.object.repeats=0:this.object.repeats=e}else"scNoteVisibility"===a?this.object.playerVisible=i:"scNoteDateAllDay"===a&&(this.object.allDay=!i);else if(n&&(e.debug(`Input Name "${n}" change found`),"scNoteCategories"===n))if(i){const e=ee.instance.activeCalendar.noteCategories.findIndex((e=>e.name===s));this.object.categories.push(ee.instance.activeCalendar.noteCategories[e].name)}else{const e=this.object.categories.findIndex((e=>e===s));this.object.categories.splice(e,1)}this.updateApp()}reminderChange(t){const a=$.UserID(),n=this.object.remindUsers.indexOf(a);if(""!==a&&-1===n?this.object.remindUsers.push(a):""!==a&&-1!==n&&this.object.remindUsers.splice(n,1),this.viewMode){let t=$.LoadNotes().map((e=>{const t=new E;return t.loadFromSettings(e),t}));t=t.map((e=>e.id===this.object.id?this.object:e)),$.SaveNotes(t).catch(e.error)}this.updateApp()}dateSelectorClick(e){this.object.year=e.startDate.year,this.object.month=e.startDate.month,this.object.day=e.startDate.day,this.object.allDay=e.startDate.allDay,this.object.hour=e.startDate.hour,this.object.minute=e.startDate.minute,this.object.endDate={year:e.endDate.year,month:e.endDate.month,day:e.endDate.day,hour:e.endDate.hour,minute:e.endDate.minute,seconds:0};const t=ee.instance.activeCalendar.year.months.find((t=>t.numericRepresentation===e.startDate.month));t&&(this.object.monthDisplay=t.name),this.updateApp()}_updateObject(t,a){return this.object.content=a.content,e.debug("Update Object Called"),this.updateApp(),Promise.resolve(!1)}close(e){return R.RemoveSelector(this.dateSelectorId),super.close(e)}showApp(){this.hasBeenResized=!1,this.render(!0)}closeApp(){this.close().catch((t=>e.error(t)))}updateApp(){this.render(!0)}editButtonClick(e){e.preventDefault(),this.viewMode=!1,this.updateNote=!0,this.updateApp()}async deleteButtonClick(e){e.preventDefault(),new Dialog({title:$.Localize("FSC.DeleteConfirm"),content:$.Localize("FSC.DeleteConfirmText"),buttons:{yes:{icon:'<i class="fas fa-trash"></i>',label:$.Localize("FSC.Delete"),callback:this.deleteConfirm.bind(this)},no:{icon:'<i class="fas fa-times"></i>',label:$.Localize("FSC.Cancel")}},default:"no"}).render(!0)}async deleteConfirm(){const t=$.LoadNotes().map((e=>{const t=new E;return t.loadFromSettings(e),t})),a=t.map((e=>e.id)).indexOf(this.object.id);a>-1&&a<t.length&&(t.splice(a,1),await $.SaveNotes(t).catch(e.error),this.closeApp())}async saveButtonClick(t){if(e.debug("Saving New Note"),t.preventDefault(),this.editors.content&&this.editors.content.mce&&""!==this.editors.content.mce.getContent().trim()&&(this.object.content=this.editors.content.mce.getContent().trim()),this.object.title){let t=$.LoadNotes().map((e=>{const t=new E;return t.loadFromSettings(e),t}));this.updateNote?t=t.map((e=>e.id===this.object.id?this.object:e)):t.push(this.object),await $.SaveNotes(t).catch(e.error),this.closeApp()}else $.UiNotification($.Localize("FSC.Error.Note.NoTitle"),"error")}}class V{static Register(){Handlebars.registerHelper("sc-date-selector",V.DateSelector),Handlebars.registerHelper("day-has-note",V.DayHasNotes),Handlebars.registerHelper("day-moon-phase",V.DayMoonPhase)}static DateSelector(e){if(e.hash.hasOwnProperty("id")){const t=e.hash.id,a=R.GetSelector(t,{showDate:!0,showTime:!1});return new Handlebars.SafeString(a.build())}return""}static DayHasNotes(e){if(e.hash.hasOwnProperty("day")){const t=e.hash.day.numericRepresentation,a=ee.instance.activeCalendar.year.getMonth("visible"),n=ee.instance.activeCalendar.year.visibleYear;if(a){const e=ee.instance.activeCalendar.notes.filter((e=>e.isVisible(n,a.numericRepresentation,t)));if(e.length){const t=$.UserID(),a=e.filter((e=>-1===e.remindUsers.indexOf(t))),n=e.filter((e=>-1!==e.remindUsers.indexOf(t)));let s="";if(a.length){const e=a.length<100?a.length:99;s=`<span class="note-count" title="${V.GenerateNoteIconTitle(e,a)}">${e}</span>`}if(n.length){const e=n.length<100?n.length:99;s+=`<span class="note-count reminders" title="${V.GenerateNoteIconTitle(e,n)}">${e}</span>`}return new Handlebars.SafeString(s)}}}return""}static GenerateNoteIconTitle(e,t){let a=`${e} ${$.Localize("FSC.Configuration.General.Notes")}`;if(t.length<3){a=$.Localize("FSC.Configuration.General.Notes")+":\n";for(let e=0;e<t.length;e++)0!==e&&(a+="\n"),a+=`${t[e].title.replace(/"/g,"&quot;")}`}return a}static DayMoonPhase(e){if(e.hash.hasOwnProperty("day")){const t=e.hash.day;let a="";for(let e=0;e<ee.instance.activeCalendar.year.moons.length;e++){const n=ee.instance.activeCalendar.year.moons[e].getMoonPhase(ee.instance.activeCalendar.year,"visible",t);if(n&&(n.singleDay||t.selected||t.current)){let t=T.GetMoonPhaseIcon(n.icon,ee.instance.activeCalendar.year.moons[e].color);a+=`<span class="moon-phase ${n.icon}" title="${ee.instance.activeCalendar.year.moons[e].name} - ${n.name}">${t}</span>`}}return new Handlebars.SafeString(a)}return""}}class B extends L{constructor(){super(),this.rule=c.None,this.customMod=0}clone(){const e=new B;return e.id=this.id,e.rule=this.rule,e.customMod=this.customMod,e}toConfig(){return{id:this.id,rule:this.rule,customMod:this.customMod}}toTemplate(){return{...super.toTemplate(),rule:this.rule,customMod:this.customMod}}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("id")&&(this.id=e.id),e.hasOwnProperty("rule")&&(this.rule=e.rule),e.hasOwnProperty("customMod")&&(this.customMod=e.customMod))}isLeapYear(e){return k.checkLeapYearRules(this),this.rule===c.Gregorian?e%4==0&&(e%100!=0||e%100==0&&e%400==0):this.rule===c.Custom&&e%this.customMod==0}howManyLeapYears(e){let t=0;return this.rule===c.Gregorian?t=Math.floor(e/4)-Math.floor(e/100)+Math.floor(e/400):this.rule===c.Custom&&0!==this.customMod&&(t=Math.floor(e/this.customMod)),this.isLeapYear(e)&&t>0&&(t-=1),t}previousLeapYear(e){if(this.rule===c.Gregorian||this.rule===c.Custom&&0!==this.customMod){let t=e;for(;Number.isInteger(t)&&!this.isLeapYear(t);)t--;return t}return null}fraction(e){const t=this.previousLeapYear(e);if(null!==t&&0!==t){const a=e%t;return this.rule===c.Gregorian?a/4:a/this.customMod}return 0}}class _{constructor(e){this.status=f.Stopped,this.pauseClicked=!1,this.updateFrequency=e}start(t=!1){this.status!==f.Started?(this.pauseClicked=!1,ee.instance.activeCalendar.year.time.unifyGameAndClockPause&&!t&&game.togglePause(!1,!0),void 0===this.intervalNumber?(e.debug("TimeKeeper Starting"),this.intervalNumber=window.setInterval(this.interval.bind(this),1e3*this.updateFrequency),this.updateStatus(),$.IsGm()&&ee.instance.primary&&(this.saveInterval(),this.saveIntervalNumber=window.setInterval(this.saveInterval.bind(this),1e4))):this.updateStatus()):(this.pauseClicked=!0,this.updateStatus(f.Paused),ee.instance.activeCalendar.year.time.unifyGameAndClockPause&&game.togglePause(!0,!0))}stop(){void 0!==this.intervalNumber&&(e.debug("TimeKeeper Stopping"),window.clearInterval(this.intervalNumber),window.clearInterval(this.saveIntervalNumber),ee.instance.activeCalendar.year.time.unifyGameAndClockPause&&game.togglePause(!0,!0),this.intervalNumber=void 0,this.saveIntervalNumber=void 0,this.updateStatus(),$.IsGm()&&ee.instance.primary&&this.saveInterval(!0))}getStatus(){return this.status}setStatus(e){this.status=e,ee.instance.element.find(".time-display .clock, .time-controls .time-start, .time-controls .time-stop, .current-time .clock").removeClass("stopped started paused").addClass(this.status),this.status===f.Started?ee.instance.element.find(".time-controls .time-start").removeClass("fa-play").addClass("fa-pause"):ee.instance.element.find(".time-controls .time-start").removeClass("fa-pause").addClass("fa-play")}setClockTime(e){ee.instance.element.find(".time-display .time, .current-time .time").text(e)}interval(){if(this.updateStatus(),this.status===f.Started){const t=ee.instance.activeCalendar.year.time.gameTimeRatio*this.updateFrequency,a=ee.instance.activeCalendar.year.time.changeTime(0,0,t);0!==a&&(ee.instance.activeCalendar.year.changeDay(a),ee.instance.updateApp()),$.IsGm()&&ee.instance.primary&&(ee.instance.activeCalendar.generalSettings.gameWorldTimeIntegration===d.None?(ee.instance.updateApp(),H.emit({type:h.time,data:{timeKeeperStatus:this.status}}).catch(e.error)):ee.instance.activeCalendar.syncTime().catch(e.error)),j.emit(p.DateTimeChange,t)}}saveInterval(t=!1){$.IsGm()&&ee.instance.primary&&(ee.instance.activeCalendar.generalSettings.gameWorldTimeIntegration===d.None?H.emit({type:h.time,data:{timeKeeperStatus:this.status}}).catch(e.error):ee.instance.activeCalendar.syncTime().catch(e.error),$.SaveCurrentDate(ee.instance.activeCalendar.year,t).catch(e.error))}updateStatus(t=null){const a=this.status;null!==t?this.status=t:void 0!==this.intervalNumber?this.pauseClicked||game.paused||ee.instance.activeCalendar.year.time.combatRunning?this.status=f.Paused:this.status=f.Started:this.status=f.Stopped,a!==this.status&&(e.debug(`Updating Timer Status from ${a} to ${this.status}`),j.emit(p.ClockStartStop),this.emitSocket())}emitSocket(){if($.IsGm()&&ee.instance.primary){const t={type:h.time,data:{timeKeeperStatus:this.status}};H.emit(t).catch(e.error),ee.instance.processSocket(t).catch(e.error)}}}class Q extends L{constructor(e=24,t=60,a=60){super(),this.seconds=0,this.combatRunning=!1,this.unifyGameAndClockPause=!1,this.updateFrequency=1,this.hoursInDay=e,this.minutesInHour=t,this.secondsInMinute=a,this.secondsInCombatRound=6,this.gameTimeRatio=1,this.secondsPerDay=this.hoursInDay*this.minutesInHour*this.secondsInMinute,this.timeKeeper=new _(this.updateFrequency)}toConfig(){return{id:this.id,hoursInDay:this.hoursInDay,minutesInHour:this.minutesInHour,secondsInMinute:this.secondsInMinute,secondsInCombatRound:this.secondsInCombatRound,gameTimeRatio:this.gameTimeRatio,unifyGameAndClockPause:this.unifyGameAndClockPause,updateFrequency:this.updateFrequency}}clone(){const e=new Q(this.hoursInDay,this.minutesInHour,this.secondsInMinute);return e.id=this.id,e.secondsInCombatRound=this.secondsInCombatRound,e.seconds=this.seconds,e.gameTimeRatio=this.gameTimeRatio,e.combatRunning=this.combatRunning,e.unifyGameAndClockPause=this.unifyGameAndClockPause,e.updateFrequency=this.updateFrequency,e}loadFromSettings(e){e&&Object.keys(e).length&&(e.hasOwnProperty("id")&&(this.id=e.id),this.hoursInDay=e.hoursInDay,this.minutesInHour=e.minutesInHour,this.secondsInMinute=e.secondsInMinute,this.gameTimeRatio=e.gameTimeRatio,this.secondsPerDay=this.hoursInDay*this.minutesInHour*this.secondsInMinute,e.hasOwnProperty("unifyGameAndClockPause")&&(this.unifyGameAndClockPause=e.unifyGameAndClockPause),e.hasOwnProperty("updateFrequency")&&(this.updateFrequency=e.updateFrequency,this.timeKeeper.updateFrequency=e.updateFrequency),e.hasOwnProperty("secondsInCombatRound")&&(this.secondsInCombatRound=e.secondsInCombatRound))}getCurrentTime(){let e=this.seconds,t=0,a=0;return e>=this.secondsInMinute&&(t=Math.floor(e/this.secondsInMinute),e-=t*this.secondsInMinute),t>=this.minutesInHour&&(a=Math.floor(t/this.minutesInHour),t-=a*this.minutesInHour),e=Math.floor(e),{hour:a,minute:t,seconds:e}}toString(){const e=this.getCurrentTime();return T.FormatDateTime({year:0,month:1,day:1,...e},ee.instance.activeCalendar.generalSettings.dateFormat.time)}setTime(e=0,t=0,a=0){this.seconds=e*this.minutesInHour*this.secondsInMinute+t*this.secondsInMinute+a}changeTime(t=0,a=0,n=0){n=+n.toFixed(3);const s=t*this.minutesInHour*this.secondsInMinute+a*this.secondsInMinute+n,i=this.seconds+s;return e.debug(`Checking if ${i} seconds is valid`),i>=this.secondsPerDay?(e.debug("More time than in a day, changing time again with new seconds "+(i-this.secondsPerDay)),this.seconds=0,this.changeTime(0,0,i-this.secondsPerDay)+1):i<0?(this.seconds=this.secondsPerDay,this.changeTime(0,0,i)+-1):(e.debug(`Updating seconds to ${i}`),this.seconds=i,0)}getTotalSeconds(e,t=!0){return e*this.hoursInDay*this.minutesInHour*this.secondsInMinute+(t?this.seconds:0)}async setWorldTime(t){let a=t-game.time.worldTime;const n=await game.time.advance(a);e.debug(`Set New Game World Time: ${n}`)}}class Z extends L{constructor(e){super("",e),this.prefix="",this.postfix="",this.months=[],this.weekdays=[],this.showWeekdayHeadings=!0,this.firstWeekday=0,this.yearZero=0,this.timeChangeTriggered=!1,this.combatChangeTriggered=!1,this.seasons=[],this.moons=[],this.yearNames=[],this.yearNamesStart=0,this.yearNamingRule=l.Default,this.selectedYear=e,this.visibleYear=e,this.leapYearRule=new B,this.time=new Q}toConfig(){return{id:this.id,numericRepresentation:this.numericRepresentation,prefix:this.prefix,postfix:this.postfix,showWeekdayHeadings:this.showWeekdayHeadings,firstWeekday:this.firstWeekday,yearZero:this.yearZero,yearNames:this.yearNames,yearNamingRule:this.yearNamingRule,yearNamesStart:this.yearNamesStart}}toTemplate(){const e=this.getMonth(),t=this.getMonth("visible");let a=[],n=[],s=[];if(e){const t=e.getDay();if(t){if(this.moons.length)for(let e=0;e<this.moons.length;e++){const t=this.moons[e].getMoonPhase(this,"current");a.push({name:this.moons[e].name,color:this.moons[e].color,phase:this.moons[e].getMoonPhase(this,"current"),iconSVG:T.GetMoonPhaseIcon(t.icon,this.moons[e].color)})}const i=ee.instance.activeCalendar.notes.filter((a=>a.isVisible(this.numericRepresentation,e.numericRepresentation,t.numericRepresentation))),r=$.UserID();i.length&&(n=i.filter((e=>-1===e.remindUsers.indexOf(r))),s=i.filter((e=>-1!==e.remindUsers.indexOf(r))))}}const i=this.getCurrentSeason();let r=[];return t&&(r=this.daysIntoWeeks(t,this.visibleYear,this.weekdays.length)),{...super.toTemplate(),currentSeasonName:i.name,currentSeasonColor:i.color,firstWeekday:this.firstWeekday,numericRepresentation:this.numericRepresentation,selectedDayMoons:a,selectedDayNotes:{reminders:s.length,normal:n.length},showWeekdayHeaders:this.showWeekdayHeadings,visibleMonth:null==t?void 0:t.toTemplate(this),weekdays:this.weekdays.map((e=>e.toTemplate())),weeks:r,yearZero:this.yearZero,yearNames:this.yearNames,yearNamesStart:this.yearNamesStart,yearNamingRule:this.yearNamingRule}}loadFromSettings(t){t&&Object.keys(t).length&&(e.debug("Setting the year from data."),t.hasOwnProperty("id")&&(this.id=t.id),this.numericRepresentation=t.numericRepresentation,this.prefix=t.prefix,this.postfix=t.postfix,t.hasOwnProperty("showWeekdayHeadings")&&(this.showWeekdayHeadings=t.showWeekdayHeadings),t.hasOwnProperty("firstWeekday")&&(this.firstWeekday=t.firstWeekday),t.hasOwnProperty("yearZero")&&(this.yearZero=t.yearZero),t.hasOwnProperty("yearNames")&&(this.yearNames=t.yearNames),t.hasOwnProperty("yearNamingRule")&&(this.yearNamingRule=t.yearNamingRule),t.hasOwnProperty("yearNamesStart")&&(this.yearNamesStart=t.yearNamesStart))}daysIntoWeeks(e,t,a){const n=[],s=this.monthStartingDayOfWeek(e,t),i=this.leapYearRule.isLeapYear(t),r=e.getDaysForTemplate(i);if(r.length&&a>0){const e=[];let t=0;for(let n=0;n<a;n++)if(n<s)e.push(!1);else{const a=n-s;a<r.length?(e.push(r[a]),t++):e.push(!1)}n.push(e);const i=Math.ceil((r.length-t)/a);for(let e=0;e<i;e++){const s=[];for(let n=0;n<a;n++){const i=t+e*a+n;i<r.length?s.push(r[i]):s.push(!1)}n.push(s)}}return n}clone(){const e=new Z(this.numericRepresentation);return e.id=this.id,e.postfix=this.postfix,e.prefix=this.prefix,e.yearZero=this.yearZero,e.selectedYear=this.selectedYear,e.visibleYear=this.visibleYear,e.months=this.months.map((e=>e.clone())),e.weekdays=this.weekdays.map((e=>e.clone())),e.leapYearRule=this.leapYearRule.clone(),e.showWeekdayHeadings=this.showWeekdayHeadings,e.firstWeekday=this.firstWeekday,e.time=this.time.clone(),e.seasons=this.seasons.map((e=>e.clone())),e.moons=this.moons.map((e=>e.clone())),e.yearNames=this.yearNames.map((e=>e)),e.yearNamesStart=this.yearNamesStart,e.yearNamingRule=this.yearNamingRule,e}getDisplayName(e=!1){let t;const a=this.getYearName(e?this.selectedYear:this.visibleYear);return t=a?`${this.prefix} ${a} (${e?this.selectedYear.toString():this.visibleYear.toString()}) ${this.postfix}`:`${""!==this.prefix?this.prefix+" ":""}${e?this.selectedYear.toString():this.visibleYear.toString()}${""!==this.postfix?" "+this.postfix:""}`,t}getMonth(e="current"){const t=e.toLowerCase();return this.months.find((e=>e[t]))}resetMonths(e="current"){const t=e.toLowerCase();this.months.forEach((a=>{"visible"!==e&&a.resetDays(e),a[t]=!1}))}setCurrentToVisible(){if(this.time.timeKeeper.getStatus()!==f.Started){this.visibleYear=this.numericRepresentation,this.resetMonths("visible");const e=this.getMonth();e&&(e.visible=!0)}}updateMonth(t,a,n,s=null){const i=a.toLowerCase(),r="current"===i?this.numericRepresentation:"visible"===i?this.visibleYear:this.selectedYear,o=this.leapYearRule.isLeapYear(r);(-1===t||t>=this.months.length)&&(t=this.months.length-1);let c=n?0:-1;if(null!==s)c=s;else{const e=this.getMonth();if(e){const t=e.getDay();t&&(c=t.numericRepresentation-1)}}if(this.resetMonths(a),o&&0===this.months[t].numberOfLeapYearDays||!o&&0===this.months[t].numberOfDays)return e.debug(`The month "${this.months[t].name}" has no days skipping to ${n?"next":"previous"} month.`),this.months[t][i]=!0,this.changeMonth(n?1:-1,a,s);this.months[t][i]=!0,"current"===i&&(e.debug(`New Month: ${this.months[t].name}`),this.months[t].updateDay(c,o))}changeYear(t,a=!0,n="visible",s=null){const i=n.toLowerCase();if("visible"===i?this.visibleYear=this.visibleYear+t:"selected"===i?this.selectedYear=this.selectedYear+t:(this.numericRepresentation=this.numericRepresentation+t,e.debug(`New Year: ${this.numericRepresentation}`)),this.months.length&&a){let e=0;-1===t&&(e=this.months.length-1),this.updateMonth(e,n,t>0,s)}}changeMonth(t,a="visible",n=null){const s=a.toLowerCase(),i=t>0;for(let r=0;r<this.months.length;r++)if(this.months[r][s]){if(i&&r+t>=this.months.length){e.debug(`Advancing the ${s} month (${r}) by more months (${t}) than there are in the year (${this.months.length}), advancing the year by 1`),this.changeYear(1,!0,s,n);const a=t-(this.months.length-r);a>0&&this.changeMonth(a,s,n)}else if(!i&&r+t<0){this.changeYear(-1,!0,s,n);const e=t+r+1;e<0&&this.changeMonth(e,s,n)}else this.updateMonth(r+t,a,i,n);break}}changeDay(t,a="current"){const n=a.toLowerCase(),s="current"===n?this.numericRepresentation:this.selectedYear,i=this.leapYearRule.isLeapYear(s),r=this.getMonth();if(r){const a=t>0;let s=0;const o=r.getDay(n);o&&(s=r.days.findIndex((e=>e.numericRepresentation===o.numericRepresentation)));const c=i?r.numberOfLeapYearDays:r.numberOfDays;a&&s+t>=c?(e.debug(`Advancing the ${n} day (${s}) by more days (${t}) than there are in the month (${c}), advancing the month by 1`),this.changeMonth(1,n,0),this.changeDay(t-(c-s),n)):!a&&s+t<0?(e.debug(`Advancing the ${n} day (${s}) by less days (${t}) than there are in the month (${c}), advancing the month by -1`),this.changeMonth(-1,n,-1),this.changeDay(t+s+1,n)):r.changeDay(t,i,n)}}changeDayBulk(e,t="current"){let a=this.leapYearRule.isLeapYear(this.numericRepresentation),n=this.totalNumberOfDays(a,!0);for(;e>n;)this.changeYear(1,!1,t),e-=n,a=this.leapYearRule.isLeapYear(this.numericRepresentation),n=this.totalNumberOfDays(a,!0);this.changeDay(e,t)}changeTime(e,t,a=1){t=t.toLowerCase();const n=e?a:-1*a;let s=0;this.timeChangeTriggered=!0,"hour"===t?s=this.time.changeTime(n):"minute"===t?s=this.time.changeTime(0,n):"second"===t&&(s=this.time.changeTime(0,0,n)),0!==s&&this.changeDay(s)}totalNumberOfDays(e=!1,t=!1){let a=0;return this.months.forEach((n=>{(n.intercalary&&n.intercalaryInclude||!n.intercalary||t)&&(a+=e?n.numberOfLeapYearDays:n.numberOfDays)})),a}monthStartingDayOfWeek(e,t){return e?e.intercalary&&!e.intercalaryInclude?0:this.dayOfTheWeek(t,e.numericRepresentation,1):0}dayOfTheWeek(e,t,a){if(this.weekdays.length){const n=k.weekdayAdjust();void 0!==n&&(this.firstWeekday=n);const s=this.months.find((e=>e.numericRepresentation===t));let i;return i=s&&null!==s.startingWeekday?a+s.startingWeekday-2:this.dateToDays(e,t,a)+this.firstWeekday,(i%this.weekdays.length+this.weekdays.length)%this.weekdays.length}return 0}dateToDays(e,t,a,n=!1,s=!1){const i=e<this.yearZero,r=this.totalNumberOfDays(!1,s),o=this.totalNumberOfDays(!0,s)-r;let l=this.months.findIndex((e=>e.numericRepresentation===t));const h=this.leapYearRule.isLeapYear(e),d=this.leapYearRule.howManyLeapYears(e),m=this.leapYearRule.howManyLeapYears(this.yearZero);let u,y=Math.abs(e-this.yearZero);l<0&&(l=0),i&&(y-=1);let g=r*y;if((a-=this.months[l].numericRepresentationOffset)<1&&(a=1),i){u=h?(m-(d+1))*o:(m-d)*o,g+=u;for(let e=this.months.length-1;e>=0;e--)e>l&&(s||!this.months[e].intercalary||this.months[e].intercalary&&this.months[e].intercalaryInclude)&&(g+=h?this.months[e].numberOfLeapYearDays:this.months[e].numberOfDays);g+=(h?this.months[l].numberOfLeapYearDays:this.months[l].numberOfDays)-a}else{u=Math.abs(d-m)*o,g+=u;for(let e=0;e<this.months.length;e++)e<l&&(s||!this.months[e].intercalary||this.months[e].intercalary&&this.months[e].intercalaryInclude)&&(g+=h?this.months[e].numberOfLeapYearDays:this.months[e].numberOfDays);g+=a}return i?(g+=1,e<=0&&this.leapYearRule.rule!==c.None&&(0!==this.yearZero||h?0!==this.yearZero&&h&&(g+=o):g-=o)):g-=1,e>0&&0===this.yearZero&&this.leapYearRule.rule!==c.None&&(g+=o),i?-1*g:g}toSeconds(){let e=0;const t=this.getMonth();if(t){const a=t.getDay();e=T.ToSeconds(this.numericRepresentation,t.numericRepresentation,a?a.numericRepresentation:1,!0,this)}return e}secondsToDate(e){const t=e<0;e=Math.abs(e);let a,n,s,i,r=0,o=0,c=0;if(i=Math.floor(e/this.time.secondsPerDay),e-=i*this.time.secondsPerDay,s=Math.floor(e/(this.time.secondsInMinute*this.time.minutesInHour))%this.time.hoursInDay,e-=s*(this.time.secondsInMinute*this.time.minutesInHour),n=Math.floor(e/this.time.secondsInMinute)%this.time.secondsInMinute,a=(e-=n*this.time.secondsInMinute)%60,t){s>0&&(s=this.time.hoursInDay-s-(a>0||n>0?1:0)),n>0&&(n=this.time.minutesInHour-n-(a>0?1:0)),a>0&&(a=this.time.secondsInMinute-a),c=this.yearZero-1;let e=this.leapYearRule.isLeapYear(c);for(o=this.months.length-1,r=e?this.months[o].numberOfLeapYearDays-1:this.months[o].numberOfDays-1,0===a&&0===n&&0===s&&i--;i>0;){const t=this.totalNumberOfDays(e,!0);let a=e?this.months[o].numberOfLeapYearDays:this.months[o].numberOfDays;if(i>=t)c-=1,e=this.leapYearRule.isLeapYear(c),a=e?this.months[o].numberOfLeapYearDays:this.months[o].numberOfDays,i-=t;else if(i>=a){o-=1;let t=e?this.months[o].numberOfLeapYearDays:this.months[o].numberOfDays,n=0;for(;0===t&&n<=this.months.length;)o--,t=e?this.months[o].numberOfLeapYearDays:this.months[o].numberOfDays,n++;r=e?this.months[o].numberOfLeapYearDays-1:this.months[o].numberOfDays-1,i-=a}else r-=1,i-=1}}else{c=this.yearZero;let e=this.leapYearRule.isLeapYear(c);for(o=0,r=0;i>0;){const t=this.totalNumberOfDays(e,!0),a=e?this.months[o].numberOfLeapYearDays:this.months[o].numberOfDays;if(i>=t)c+=1,e=this.leapYearRule.isLeapYear(c),i-=t;else if(i>=a){o+=1;let t=e?this.months[o].numberOfLeapYearDays:this.months[o].numberOfDays,n=0;for(;0===t&&n<=this.months.length;)o++,t=e?this.months[o].numberOfLeapYearDays:this.months[o].numberOfDays,n++;i-=a}else r+=1,i-=1}c<0&&r++}return{year:c,month:o,day:r,hour:s,minute:n,seconds:a}}secondsToInterval(e){let t=e,a=0,n=0,s=0,i=0,r=0;t>=this.time.secondsInMinute&&(a=Math.floor(t/this.time.secondsInMinute),t-=a*this.time.secondsInMinute),a>=this.time.minutesInHour&&(n=Math.floor(a/this.time.minutesInHour),a-=n*this.time.minutesInHour);let o=0;n>=this.time.hoursInDay&&(o=Math.floor(n/this.time.hoursInDay),n-=o*this.time.hoursInDay);const c=this.totalNumberOfDays(!1,!1)/this.months.map((e=>!e.intercalary)).length;return i=Math.floor(o/c),s=o-Math.round(i*c),r=Math.floor(i/this.months.length),i-=Math.round(r*this.months.length),{second:t,minute:a,hour:n,day:s,month:i,year:r}}updateTime(e){let t=this.leapYearRule.isLeapYear(e.year);this.numericRepresentation=e.year,this.updateMonth(e.month,"current",!0),this.months[e.month].updateDay(e.day,t),this.time.setTime(e.hour,e.minute,e.seconds)}getCurrentSeason(){let e=0,t=0;const a=this.getMonth("visible");if(a){e=this.months.findIndex((e=>e.numericRepresentation===a.numericRepresentation));const n=a.getDay("selected")||a.getDay();t=n?n.numericRepresentation:1}const n=this.getSeason(e,t);return{name:n.name,color:n.color}}getSeason(e,t){let a=new x("",1,1);if(t>0&&e>=0){let n=null;const s=this.seasons.sort(((e,t)=>this.months.findIndex((t=>t.numericRepresentation===e.startingMonth))-this.months.findIndex((e=>e.numericRepresentation===t.startingMonth))||e.startingDay-t.startingDay));for(let a=0;a<s.length;a++){const i=this.months.findIndex((e=>e.numericRepresentation===s[a].startingMonth));(i===e&&s[a].startingDay<=t||i<e)&&(n=s[a])}null===n&&(n=s[s.length-1]),n&&(a=n.clone())}return this.months.length>0&&(a.startingMonth=this.months.findIndex((e=>e.numericRepresentation===a.startingMonth)),a.startingDay=this.months[a.startingMonth>=0?a.startingMonth:0].days.findIndex((e=>e.numericRepresentation===a.startingDay))),a}getYearName(e){let t="";if(this.yearNames.length){let a=0;this.yearNamingRule===l.Repeat?a=((e-this.yearNamesStart)%this.yearNames.length+this.yearNames.length)%this.yearNames.length:this.yearNamingRule===l.Random?a=((T.randomHash(`${e}-AbCxYz`)-this.yearNamesStart)%this.yearNames.length+this.yearNames.length)%this.yearNames.length:(a=Math.abs(this.yearNamesStart-e),a>=this.yearNames.length&&(a=this.yearNames.length-1)),t=this.yearNames[a]}return t}processOwnCombatRoundTime(t){let a=this.time.secondsInCombatRound,n=1;if(t.hasOwnProperty("previous")&&t.previous.round&&(n=t.round-t.previous.round),0!==a&&0!==n){const t=this.secondsToDate(this.toSeconds()+a*n);this.updateTime(t),$.IsGm()&&ee.instance.primary&&$.SaveCurrentDate(this).catch(e.error)}}getSunriseSunsetTime(e,t,a,n=!0,s=!0){const i=this.months.findIndex((e=>e.numericRepresentation===t.numericRepresentation)),r=t.days.findIndex((e=>e.numericRepresentation===a.numericRepresentation)),o=this.seasons.sort(((e,t)=>this.months.findIndex((t=>t.numericRepresentation===e.startingMonth))-this.months.findIndex((e=>e.numericRepresentation===t.startingMonth))||e.startingDay-t.startingDay));let c=o.length-1;for(let e=0;e<o.length;e++){const t=this.months.findIndex((t=>t.numericRepresentation===o[e].startingMonth));(t===i&&o[e].startingDay<=a.numericRepresentation||t<i)&&(c=e)}const l=(c+1)%this.seasons.length;if(c<o.length&&l<o.length){let t=o[c];const a=o[l];let h=e,d=h;c===o.length-1&&((this.months[i].numericRepresentation<o[c].startingMonth||o[c].startingMonth===this.months[i].numericRepresentation&&this.months[i].days[r].numericRepresentation<o[c].startingDay)&&(h=e-1),d=h+1);const m=T.DaysBetweenDates({year:h,month:t.startingMonth,day:t.startingDay,hour:0,minute:0,seconds:0},{year:e,month:this.months[i].numericRepresentation,day:this.months[i].days[r].numericRepresentation,hour:0,minute:0,seconds:0}),u=T.DaysBetweenDates({year:h,month:t.startingMonth,day:t.startingDay,hour:0,minute:0,seconds:0},{year:d,month:a.startingMonth,day:a.startingDay,hour:0,minute:0,seconds:0}),y=m*((n?a.sunriseTime-t.sunriseTime:a.sunsetTime-t.sunsetTime)/u),g=Math.round((n?t.sunriseTime:t.sunsetTime)+y);return s?O.dateToTimestamp({year:e,month:i,day:r,hour:0,minute:0,second:0})+g:g}return 0}}class q extends L{constructor(){super(),this.viewCalendar={player:!0,trustedPlayer:!0,assistantGameMaster:!0,users:void 0},this.addNotes={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0},this.reorderNotes={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0},this.changeDateTime={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:void 0}}static clonePermissions(e){return{player:e.player,trustedPlayer:e.trustedPlayer,assistantGameMaster:e.assistantGameMaster,users:e.users}}clone(){const e=new q;return e.id=this.id,e.viewCalendar=q.clonePermissions(this.viewCalendar),e.addNotes=q.clonePermissions(this.addNotes),e.reorderNotes=q.clonePermissions(this.reorderNotes),e.changeDateTime=q.clonePermissions(this.changeDateTime),e}toTemplate(){return{...super.toTemplate(),viewCalendar:this.viewCalendar,addNotes:this.addNotes,reorderNotes:this.reorderNotes,changeDateTime:this.changeDateTime}}loadFromSettings(e){e&&Object.keys(e).length&&(this.viewCalendar=e.viewCalendar,this.addNotes=e.addNotes,this.changeDateTime=e.changeDateTime,e.hasOwnProperty("reorderNotes")&&(this.reorderNotes=e.reorderNotes))}}class K extends L{constructor(){super(),this.gameWorldTimeIntegration=d.Mixed,this.showClock=!0,this.pf2eSync=!0,this.dateFormat={date:"MMMM DD, YYYY",time:"HH:mm:ss",monthYear:"MMMM YAYYYYYZ"},this.permissions=new q}clone(){const e=new K;return e.id=this.id,e.gameWorldTimeIntegration=this.gameWorldTimeIntegration,e.showClock=this.showClock,e.pf2eSync=this.pf2eSync,e.dateFormat.date=this.dateFormat.date,e.dateFormat.time=this.dateFormat.time,e.dateFormat.monthYear=this.dateFormat.monthYear,e.permissions=this.permissions.clone(),e}toTemplate(){return{...super.toTemplate(),gameWorldTimeIntegration:this.gameWorldTimeIntegration,showClock:this.showClock,pf2eSync:this.pf2eSync,dateFormat:this.dateFormat,permissions:this.permissions.toTemplate()}}loadFromSettings(e){e&&Object.keys(e).length&&(this.id=e.id,this.gameWorldTimeIntegration=e.gameWorldTimeIntegration,this.showClock=e.showClock,e.hasOwnProperty("pf2eSync")&&(this.pf2eSync=e.pf2eSync),e.hasOwnProperty("permissions")?this.permissions.loadFromSettings(e.permissions):e.hasOwnProperty("playersAddNotes")&&(this.permissions.addNotes.player=e.playersAddNotes,this.permissions.addNotes.trustedPlayer=e.playersAddNotes,this.permissions.addNotes.assistantGameMaster=e.playersAddNotes),e.hasOwnProperty("dateFormat")&&(this.dateFormat=e.dateFormat))}}class J extends L{constructor(e){if(super(e.name),this.generalSettings=new K,this.notes=[],this.noteCategories=[],this.id=T.generateUniqueId(),this.gameSystem=g.Other,game.system)switch(game.system.id){case g.DnD5E:this.gameSystem=g.DnD5E;break;case g.PF1E:this.gameSystem=g.PF1E;break;case g.PF2E:this.gameSystem=g.PF2E;break;case g.WarhammerFantasy4E:this.gameSystem=g.WarhammerFantasy4E}this.year=new Z(0),Y.setToPredefined(this.year,i.Gregorian)}static LoadCalendars(){const e=new J({id:"",name:"default"});return e.settingUpdate(),[e]}canUser(e,t){return null!==e&&!!(e.isGM||t.player&&e.hasRole(1)||t.trustedPlayer&&e.hasRole(2)||t.assistantGameMaster&&e.hasRole(3)||t.users&&t.users.includes(e.id?e.id:""))}clone(){const e=new J({id:"",name:this.name});return e.id=this.id,e.name=this.name,e.gameSystem=this.gameSystem,e.generalSettings=this.generalSettings.clone(),e.year=this.year.clone(),e.notes=this.notes.map((e=>e.clone())),e.noteCategories=this.noteCategories.map((e=>({name:e.name,textColor:e.textColor,color:e.color}))),e}toTemplate(){let e=!1,t=1,a=1,n=1;const s=this.year.getMonth(),i=this.year.getMonth("selected"),r=this.year.getMonth("visible");if(i){a=i.numericRepresentation;const t=i.getDay("selected");t&&(n=t.numericRepresentation,t.current||(e=!0))}else if(s){a=s.numericRepresentation;const e=s.getDay();e&&(n=e.numericRepresentation)}return r&&(t=r.numericRepresentation),{...super.toTemplate(),addNotes:this.canUser(game.user,this.generalSettings.permissions.addNotes),changeDateTime:this.canUser(game.user,this.generalSettings.permissions.changeDateTime),currentYear:this.year.toTemplate(),gameSystem:this.gameSystem,isGM:$.IsGm(),name:this.name,notes:this.getNotesForDay().map((e=>e.toTemplate())),reorderNotes:this.canUser(game.user,this.generalSettings.permissions.reorderNotes),showClock:this.generalSettings.showClock,showCurrentDay:this.year.visibleYear===this.year.numericRepresentation,showDateControls:this.generalSettings.gameWorldTimeIntegration!==d.ThirdParty,showSelectedDay:this.year.visibleYear===this.year.selectedYear,showSetCurrentDate:this.canUser(game.user,this.generalSettings.permissions.changeDateTime)&&e,showTimeControls:this.generalSettings.showClock&&this.generalSettings.gameWorldTimeIntegration!==d.ThirdParty,calendarDisplay:T.FormatDateTime({year:this.year.numericRepresentation,month:t,day:1,hour:0,minute:0,seconds:0},this.generalSettings.dateFormat.monthYear),selectedDisplay:T.FormatDateTime({year:this.year.selectedYear,month:a,day:n,hour:0,minute:0,seconds:0},this.generalSettings.dateFormat.date),timeDisplay:T.FormatDateTime({year:0,month:0,day:0,...this.year.time.getCurrentTime()},this.generalSettings.dateFormat.time)}}getNotesForDay(){const e=[],t=this.year.selectedYear||this.year.numericRepresentation,a=this.year.getMonth("selected")||this.year.getMonth();if(a){const n=a.getDay("selected")||a.getDay();n&&this.notes.forEach((s=>{s.isVisible(t,a.numericRepresentation,n.numericRepresentation)&&e.push(s)}))}return e.sort(J.dayNoteSort),e}static dayNoteSort(e,t){return e.order-t.order||e.hour-t.hour||e.minute-t.minute}searchNotes(e){const t=[];return e=e.toLowerCase(),this.notes.forEach((a=>{let n=0;const s=T.GetDisplayDate({year:a.year,month:a.month,day:a.day,hour:a.hour,minute:a.minute,allDay:a.allDay},{...a.endDate,allDay:a.allDay}).toLowerCase(),i=a.title.toLowerCase(),r=a.content.toLowerCase();RegExp(e).test(s)&&(n+=1e3),RegExp(e).test(i)&&(n+=500),RegExp(e).test(r)&&(n+=100);const o=e.split(" ");for(var c=0;c<o.length;c++)RegExp("\\b"+o[c]+"\\b").test(s)?n+=50:s.indexOf(o[c])>-1&&(n+=30),RegExp("\\b"+o[c]+"\\b").test(i)?n+=20:i.indexOf(o[c])>-1&&(n+=10),RegExp("\\b"+o[c]+"\\b").test(r)?n+=2:r.indexOf(o[c])>-1&&n++;n>0&&t.push({match:n,note:a})})),t.sort(((e,t)=>t.match-e.match)),t.map((e=>e.note))}async syncTime(t=!1){if(this.canUser(game.user,this.generalSettings.permissions.changeDateTime)&&(this.generalSettings.gameWorldTimeIntegration===d.Self||this.generalSettings.gameWorldTimeIntegration===d.Mixed)){e.debug("Year.syncTime()");const a=this.year.toSeconds();(a!==game.time.worldTime||t)&&(this.year.timeChangeTriggered=!0,await this.year.time.setWorldTime(a))}}setFromTime(t,a){if(e.debug("Year.setFromTime()"),this.gameSystem===g.PF2E&&this.generalSettings.pf2eSync&&(t+=k.getWorldCreateSeconds()),0!==a)if(this.generalSettings.gameWorldTimeIntegration!==d.Self&&this.generalSettings.gameWorldTimeIntegration!==d.Mixed||this.year.time.timeKeeper.getStatus()!==f.Started){if(this.generalSettings.gameWorldTimeIntegration!==d.Self&&this.generalSettings.gameWorldTimeIntegration!==d.Mixed||!this.year.timeChangeTriggered&&!this.year.combatChangeTriggered)if(this.generalSettings.gameWorldTimeIntegration!==d.ThirdParty&&this.generalSettings.gameWorldTimeIntegration!==d.Mixed||this.year.timeChangeTriggered)e.debug("Not Applying Change!");else{e.debug("Tracking Rule: ThirdParty.\nTriggered Change: External Change. Applying Change!");const a=this.year.secondsToDate(t);this.year.updateTime(a),$.IsGm()&&ee.instance.primary&&$.SaveCurrentDate(this.year).catch(e.error)}else if(e.debug("Tracking Rule: Self.\nTriggered Change: Simple Calendar/Combat Turn. Applying Change!"),!this.year.timeChangeTriggered){const a=this.year.secondsToDate(t);this.year.updateTime(a),$.IsGm()&&ee.instance.primary&&$.SaveCurrentDate(this.year).catch(e.error)}}else{e.debug("Tracking Rule: Self/Mixed\nClock Is Running, no need to update the date.");const n=this.year.secondsToDate(t);this.year.updateTime(n),this.year.time.timeKeeper.setClockTime(this.year.time.toString()),this.year.time.updateFrequency*this.year.time.gameTimeRatio!==a&&ee.instance.updateApp()}e.debug("Resetting time change triggers."),this.year.timeChangeTriggered=!1,this.year.combatChangeTriggered=!1}settingUpdate(t="all"){if("all"!==t&&"year"!==t||this.year.loadFromSettings($.LoadYearData()),"all"===t||"month"===t){e.debug("Loading month configuration from settings.");const t=$.LoadMonthData();if(t.length){e.debug("Setting the months from data."),this.year.months=[];for(let e=0;e<t.length;e++){const a=new I;a.loadFromSettings(t[e]),this.year.months.push(a)}}}if("all"===t||"weekday"===t){e.debug("Loading weekday configuration from settings.");const t=$.LoadWeekdayData();if(t.length){e.debug("Setting the weekdays from data."),this.year.weekdays=[];for(let e=0;e<t.length;e++){const a=new P;a.loadFromSettings(t[e]),this.year.weekdays.push(a)}}}if("all"===t||"notes"===t){e.debug("Loading notes from settings.");const t=$.LoadNotes();this.notes=t.map((e=>{const t=new E;return t.loadFromSettings(e),t}))}if("all"!==t&&"leapyear"!==t||(e.debug("Loading Leap Year Settings"),this.year.leapYearRule.loadFromSettings($.LoadLeapYearRules())),"all"!==t&&"time"!==t||(e.debug("Loading time configuration from settings."),this.year.time.loadFromSettings($.LoadTimeData())),"all"===t||"season"===t){e.debug("Loading season configuration from settings.");const t=$.LoadSeasonData();if(this.year.seasons=[],t.length){e.debug("Setting the seasons from data.");for(let e=0;e<t.length;e++){const a=new x;a.loadFromSettings(t[e]),this.year.seasons.push(a)}}}if("all"===t||"moon"===t){e.debug("Loading moon configuration from settings.");const t=$.LoadMoonData();if(this.year.moons=[],t.length){e.debug("Setting the moons from data.");for(let e=0;e<t.length;e++){const a=new W;a.loadFromSettings(t[e]),this.year.moons.push(a)}}}"all"!==t&&"general"!==t||(e.debug("Loading General Settings"),this.generalSettings.loadFromSettings($.LoadGeneralSettings())),"all"!==t&&"note-categories"!==t||(this.noteCategories=$.LoadNoteCategories()),this.loadCurrentDate()}loadCurrentDate(){e.debug("Loading current date from settings.");const t=$.LoadCurrentDate();if(t&&Object.keys(t).length){this.year.numericRepresentation=t.year,this.year.selectedYear=t.year,this.year.visibleYear=t.year,this.year.resetMonths("current"),this.year.resetMonths("visible");const a=this.year.months.find((e=>e.numericRepresentation===t.month));if(a){a.current=!0,a.visible=!0;const n=a.days.find((e=>e.numericRepresentation===t.day));n?n.current=!0:(e.error("Save day could not be found in this month, perhaps number of days has changed. Setting current day to first day of month"),a.days[0].current=!0)}else e.error("Saved month could not be found, perhaps months have changed. Setting current month to the first month"),this.year.months[0].current=!0,this.year.months[0].visible=!0,this.year.months[0].days[0].current=!0;this.year.time.seconds=t.seconds,void 0===this.year.time.seconds&&(this.year.time.seconds=0)}else this.year.months.length?(e.debug("No current date setting found, setting default current date."),this.year.months[0].current=!0,this.year.months[0].visible=!0,this.year.months[0].days[0].current=!0):e.error("Error setting the current date.")}}class X extends FormApplication{constructor(e){super(e),this.searchTerm="",this.results=[]}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/foundryvtt-simple-calendar/templates/search.html",e.title="FSC.Search",e.classes=["form","simple-calendar"],e.resizable=!0,e.closeOnSubmit=!1,e.width=500,e.height=400,e}getData(e){return{...super.getData(e),isGM:$.IsGm(),searchTerm:this.searchTerm,results:this.results.map((e=>e.toTemplate()))}}activateListeners(e){super.activateListeners(e),e.find(".search-box .fa-search").on("click",X.instance.search.bind(this)),e.find(".note-list .note").on("click",X.instance.viewNote.bind(this))}_updateObject(e,t){return Promise.resolve(!1)}showApp(){this.render(!0)}search(){this.searchTerm=(this.element.find("#simpleCalendarSearchBox").val()||"").toString(),this.results=[],this.searchTerm&&(this.results=this.object.searchNotes(this.searchTerm)),this.showApp()}viewNote(t){t.stopPropagation();const a=t.currentTarget.getAttribute("data-index");if(a){const e=this.results.find((e=>e.id===a));e&&(U.instance=new U(e,!0),U.instance.showApp())}else e.error("No Data index on note element found.")}}class ee extends Application{constructor(){super(),this.calendars=[],this.clockClass="stopped",this.timeUnits={second:!0,minute:!1,hour:!1},this.primary=!1,this.hasBeenResized=!1,this.compactView=!1,this.compactViewShowNotes=!1,this.calendars.push(new J({id:"",name:"Gregorian"}))}get activeCalendar(){return this.calendars[0]}static get defaultOptions(){const e=super.defaultOptions;return e.template="modules/foundryvtt-simple-calendar/templates/calendar.html",e.title="FSC.Title",e.classes=["simple-calendar"],e.resizable=!0,e}init(){V.Register(),$.RegisterSettings(),this.calendars=J.LoadCalendars()}initializeSockets(){if(H.on(this.processSocket.bind(this)),$.IsGm()){const t={type:h.primary,data:{primaryCheck:!0}};this.primaryCheckTimeout=window.setTimeout(this.primaryCheckTimeoutCall.bind(this),5e3),H.emit(t).catch(e.error)}else j.emit(p.Ready);H.emit({type:h.checkClockRunning,data:{}}).catch(e.error)}async primaryCheckTimeoutCall(){e.debug("No primary GM found, taking over as primary"),this.primary=!0;const t={type:h.primary,data:{amPrimary:this.primary}};await H.emit(t);const a={type:h.time,data:{timeKeeperStatus:f.Stopped}};await H.emit(a),this.activeCalendar.year.time.unifyGameAndClockPause&&game.togglePause(!0,!0),await this.timeKeepingCheck(),this.updateApp(),j.emit(p.PrimaryGM),j.emit(p.Ready)}async processSocket(t){if(e.debug(`Processing ${t.type} socket emit`),t.type===h.time)this.activeCalendar.year.time.timeKeeper.setStatus(t.data.timeKeeperStatus),this.clockClass=this.activeCalendar.year.time.timeKeeper.getStatus(),this.activeCalendar.year.time.timeKeeper.setClockTime(this.activeCalendar.year.time.toString());else if(t.type===h.checkClockRunning)$.IsGm()&&this.primary&&H.emit({type:h.time,data:{timeKeeperStatus:this.activeCalendar.year.time.timeKeeper.getStatus()}}).catch(e.error);else if(t.type===h.journal)$.IsGm()&&this.primary&&(e.debug("Saving notes from user."),await $.SaveNotes(t.data.notes));else if(t.type===h.primary)$.IsGm()&&(t.data.primaryCheck?(e.debug("Checking if I am the primary"),await H.emit({type:h.primary,data:{amPrimary:this.primary}})):void 0!==t.data.amPrimary&&(t.data.amPrimary?(e.debug("A primary GM is all ready present."),window.clearTimeout(this.primaryCheckTimeout),this.primary=!1,j.emit(p.Ready)):e.debug("We are all ready waiting to take over as primary.")));else if(t.type===h.dateTime){if($.IsGm()&&this.primary&&(e.debug("Processing Date/Time Change Request."),t.data.dataType)){switch(t.data.dataType){case"time":isNaN(t.data.amount)||this.activeCalendar.year.changeTime(t.data.isNext,t.data.unit,t.data.amount);break;case"day":this.activeCalendar.year.changeDay(t.data.isNext?1:-1,"current");break;case"month":this.activeCalendar.year.changeMonth(t.data.isNext?1:-1,"current");break;case"year":this.activeCalendar.year.changeYear(t.data.isNext?1:-1,!1,"current")}$.SaveCurrentDate(this.activeCalendar.year).catch(e.error),this.activeCalendar.syncTime().catch(e.error)}}else if(t.type===h.date){if($.IsGm()&&this.primary){const e=this.activeCalendar.year.months.find((e=>e.numericRepresentation===t.data.month));if(e){const a=e.days.find((e=>e.numericRepresentation===t.data.day));a&&this.setCurrentDate(t.data.year,e,a)}}}else if(t.type===h.noteReminders)this.checkNoteReminders(t.data.justTimeChange);else if(t.type===h.emitHook){const e=t.data.hook;e&&j.emit(e,t.data.param)}}getData(e){return{calendar:this.activeCalendar.toTemplate(),clockClass:this.clockClass,compactView:this.compactView,compactViewShowNotes:this.compactViewShowNotes,isPrimary:this.primary,timeUnits:this.timeUnits}}_getHeaderButtons(){const e=[];return this.compactView?e.push({label:"FSC.Full",class:"compact-view",icon:"fa fa-expand",onclick:this.minimize.bind(this)}):e.push({label:"FSC.Compact",class:"compact-view",icon:"fa fa-compress",onclick:this.minimize.bind(this)}),e.concat(super._getHeaderButtons())}getSceneControlButtons(e){if(this.activeCalendar.canUser(game.user,this.activeCalendar.generalSettings.permissions.viewCalendar)){let t=e.find((e=>"token"===e.name));t&&t.hasOwnProperty("tools")&&t.tools.push({name:"calendar",title:"FSC.ButtonTitle",icon:"fas fa-calendar",button:!0,onClick:ee.instance.showApp.bind(ee.instance)})}}showApp(){this.activeCalendar.canUser(game.user,this.activeCalendar.generalSettings.permissions.viewCalendar)&&(this.hasBeenResized=!1,this.activeCalendar.year.setCurrentToVisible(),this.render(!0,{}))}closeApp(){this.close().catch((t=>e.error(t)))}async minimize(){this.compactViewShowNotes=!1,this.compactView=!this.compactView,this.activeCalendar.year.resetMonths("selected"),this.render(!0)}async maximize(){this.compactView=!1,this.render(!0)}_onResize(e){super._onResize(e),this.hasBeenResized=!0}setWidthHeight(e){if(this.hasBeenResized)return;let t=1,a=1;const n=this.element.find(".window-header");if(n){t+=n.outerHeight(!0)||32}else t+=32;const s=this.element.find(".window-content");if(s){const e=s.height(),n=s.outerHeight(!0);t+=e&&n?n-e:0;const i=s.width(),r=s.outerWidth(!0);a+=i&&r?r-i:0}if(this.compactView){let n,s=0,i=0;if(this.activeCalendar.year.showWeekdayHeadings)for(let e=0;e<this.activeCalendar.year.weekdays.length;e++)this.activeCalendar.year.weekdays[e].name.length>s&&(s=this.activeCalendar.year.weekdays[e].name.length);for(let e=0;e<this.activeCalendar.year.months.length;e++)this.activeCalendar.year.months[e].name.length>i&&(i=this.activeCalendar.year.months[e].name.length);n=this.activeCalendar.year.getDisplayName().length+1,a=7*(s+i+n+7)+62;const r=e.find(".compact-calendar .season-moon-info"),o=e.find(".compact-calendar .current-date .date"),c=e.find(".compact-calendar .current-time"),l=e.find(".compact-calendar .time-controls"),h=e.find(".compact-calendar .note-list .note");if(r){t+=r.outerHeight(!0)||0}if(o){const e=o.outerHeight(!0);let n=o.outerWidth(!1);t+=e||0,n&&(n+=32,n+=25,n>a&&(a=n))}if(c){t+=c.outerHeight(!0)||0}if(l){const e=l.outerHeight(!0);t+=e?2*e:0}if(h){const e=h.outerHeight(!0);t+=e?2*e:0}a<250&&(a=250)}else{const n=e.find(".calendar-row .calendar-display"),s=e.find(".calendar-row .controls"),i=e.find(".date-notes-header h2"),r=e.find(".date-notes-header .add-note");if(n){t+=n.outerHeight(!0)||0,a+=n.outerWidth(!0)||0}if(s){const e=s.outerHeight(!0);e&&e>t&&(t=e),a+=s.outerWidth(!0)||0}if(i&&r){const e=i.outerHeight(!0),n=(i.outerWidth(!0)||0)+(r.outerWidth(!0)||0);n>a&&(a=n),t+=(e||0)+24}a+=16,t+=166}this.setPosition({width:a,height:t})}ensureCurrentDateIsVisible(t){const a=t.find(".calendar"),n=a.outerHeight();if(n&&n>=500){const t=a.find(".day.current"),s=a.find(".day.selected");let i=null;if(s.length?i=s[0]:t.length&&(i=t[0]),null!==i){const t=a[0].getBoundingClientRect(),s=i.getBoundingClientRect();s.top>=t.top&&s.left>=t.left&&s.bottom<=t.bottom&&s.right<=t.right||(e.debug("The Current/Selected day is not in the viewport, updating the day list scroll top position."),a[0].scrollTop=s.top-t.top-n/2)}}}activateListeners(t){if(e.debug("Simple-Calendar activateListeners()"),t.hasOwnProperty("length")){if(this.setWidthHeight(t),this.compactView)this.element.find(".window-resizable-handle").hide(),this.element.find(".compact-view").empty().append("<i class='fa fa-expand'></i> "+$.Localize("FSC.Full")),t.find(".compact-calendar .season-moon-info .add-note").on("click",ee.instance.addNote.bind(this)),t.find(".compact-calendar .season-moon-info .notes").on("click",ee.instance.showCompactNotes.bind(this)),t.find(".compact-calendar .current-date .fa").on("click",ee.instance.gmControlClick.bind(this)),t.find(".compact-calendar .time-controls .selector").on("click",ee.instance.compactTimeControlClick.bind(this)),t.find(".compact-calendar .note-list .note").on("click",ee.instance.viewNote.bind(this));else{this.element.find(".window-resizable-handle").show(),this.element.find(".compact-view").empty().append("<i class='fa fa-compress'></i> "+$.Localize("FSC.Compact")),this.ensureCurrentDateIsVisible(t);const e=t.find(".current-date .fa");for(let t=0;t<e.length;t++)e[t].classList.contains("fa-chevron-left")?e[t].addEventListener("click",ee.instance.viewPreviousMonth.bind(this)):e[t].classList.contains("fa-chevron-right")&&e[t].addEventListener("click",ee.instance.viewNextMonth.bind(this));t.find(".calendar .days .day").on("click",ee.instance.dayClick.bind(this)),t.find(".calendar-controls .today").on("click",ee.instance.todayClick.bind(this)),t.find(".time-controls .time-unit .selector").on("click",ee.instance.timeUnitClick.bind(this)),t.find(".controls .time-controls .control").on("click",ee.instance.gmControlClick.bind(this)),t.find(".controls .date-controls .control").on("click",ee.instance.gmControlClick.bind(this)),t.find(".controls .btn-apply").on("click",ee.instance.dateControlApply.bind(this)),t.find(".calendar-controls .configure-button").on("click",ee.instance.configurationClick.bind(this)),t.find(".calendar-controls .search").on("click",ee.instance.searchClick.bind(this)),t.find(".date-notes .add-note").on("click",ee.instance.addNote.bind(this)),t.find(".date-notes .note").on("click",ee.instance.viewNote.bind(this)),t.find(".date-notes .note").on("drag",ee.instance.noteDrag.bind(this)),t.find(".date-notes .note").on("dragend",ee.instance.noteDragEnd.bind(this))}t.find(".time-start").on("click",ee.instance.startTime.bind(this)),t.find(".time-stop").on("click",ee.instance.stopTime.bind(this))}}showCompactNotes(e){e.preventDefault(),this.compactViewShowNotes=!this.compactViewShowNotes,this.updateApp()}viewPreviousMonth(t){e.debug("Changing view to previous month"),t.stopPropagation(),this.activeCalendar.year.changeMonth(-1),this.updateApp()}viewNextMonth(t){e.debug("Changing view to next month"),t.stopPropagation(),this.activeCalendar.year.changeMonth(1),this.updateApp()}dayClick(t){e.debug("Day Clicked"),t.stopPropagation();let a=t.target;a.parentElement&&(a.classList.contains("note-count")?a=a.parentElement:a.classList.contains("moon-phase")&&a.parentElement.parentElement&&(a=a.parentElement.parentElement));const n=a.getAttribute("data-day");if(n){const t=parseInt(n),s=a.classList.contains("selected");if(t>-1){if(this.activeCalendar.year.resetMonths("selected"),!s){const e=this.activeCalendar.year.getMonth("visible");if(e){const a=e.days.findIndex((e=>e.numericRepresentation===t));a>-1&&(e.selected=!0,e.days[a].selected=!0,this.activeCalendar.year.selectedYear=this.activeCalendar.year.visibleYear)}}this.updateApp()}else e.error("Day has invalid data attribute!")}else e.error("Day is missing data attribute!")}todayClick(e){e.preventDefault();const t=this.activeCalendar.year.getMonth("selected");if(t){t.selected=!1;const e=t.getDay("selected");e&&(e.selected=!1)}const a=this.activeCalendar.year.getMonth("visible");a&&(a.visible=!1);const n=this.activeCalendar.year.getMonth();if(n){const e=n.getDay();e&&(this.activeCalendar.year.selectedYear=this.activeCalendar.year.numericRepresentation,this.activeCalendar.year.visibleYear=this.activeCalendar.year.numericRepresentation,n.visible=!0,n.selected=!0,e.selected=!0,this.updateApp())}}compactTimeControlClick(t){var a;t.stopPropagation();const n=t.currentTarget,s=n.getAttribute("data-type"),i=n.getAttribute("data-amount");if(s&&i){const t=parseInt(i);if($.IsGm()&&this.primary)isNaN(t)||"second"!==s&&"minute"!==s&&"hour"!==s||(this.activeCalendar.year.changeTime(!0,s,t),$.SaveCurrentDate(this.activeCalendar.year).catch(e.error),this.activeCalendar.syncTime().catch(e.error));else if(null===(a=game.users)||void 0===a?void 0:a.find((e=>e.isGM&&e.active))){const a={dataType:"time",isNext:!0,amount:t,unit:s};e.debug("Sending Date/Time Change to Primary GM"),H.emit({type:h.dateTime,data:a}).catch(e.error)}else $.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn")}else!s||"dawn"!==s&&"midday"!==s&&"dusk"!==s&&"midnight"!==s||(this.timeOfDayControlClick(s),$.SaveCurrentDate(this.activeCalendar.year).catch(e.error),this.activeCalendar.syncTime(!0).catch(e.error))}timeUnitClick(e){var t;e.stopPropagation();const a=null===(t=e.currentTarget.getAttribute("data-type"))||void 0===t?void 0:t.toLowerCase();this.timeUnits.second=!1,this.timeUnits.minute=!1,this.timeUnits.hour=!1,this.timeUnits[a]=!0,this.updateApp()}gmControlClick(t){var a;t.stopPropagation();const n=t.currentTarget,s=n.getAttribute("data-type"),i=n.classList.contains("next");let r=!1;if($.IsGm()&&this.primary)switch(s){case"time":const t=n.getAttribute("data-amount");if(t){const a=parseInt(t);if(!isNaN(a)){e.debug((i?"Forward":"Back")+" Time Clicked");const t=this.timeUnits.second?"second":this.timeUnits.minute?"minute":"hour";this.activeCalendar.year.changeTime(i,t,a),r=!0}}break;case"day":e.debug((i?"Forward":"Back")+" Day Clicked"),this.activeCalendar.year.changeDay(i?1:-1,"current"),r=!0;break;case"month":e.debug((i?"Forward":"Back")+" Month Clicked"),this.activeCalendar.year.changeMonth(i?1:-1,"current"),r=!0;break;case"year":e.debug((i?"Forward":"Back")+" Year Clicked"),this.activeCalendar.year.changeYear(i?1:-1,!1,"current"),r=!0;break;case"dawn":case"midday":case"dusk":case"midnight":this.timeOfDayControlClick(s),r=!0}else if(null===(a=game.users)||void 0===a?void 0:a.find((e=>e.isGM&&e.active))){const t={dataType:s,isNext:i,amount:0,unit:this.timeUnits.second?"second":this.timeUnits.minute?"minute":"hour"};if("time"===s){const e=n.getAttribute("data-amount");e&&(t.amount=parseInt(e))}e.debug(`Sending Date/Time Change to Primary GM: ${s}, ${i}`),H.emit({type:h.dateTime,data:t}).catch(e.error)}else $.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn");r&&($.SaveCurrentDate(this.activeCalendar.year).catch(e.error),this.activeCalendar.syncTime(!0).catch(e.error))}timeOfDayControlClick(e){let t,a=this.activeCalendar.year.getMonth();switch(e){case"dawn":if(a&&(t=a.getDay(),t)){let e=this.activeCalendar.year.getSunriseSunsetTime(this.activeCalendar.year.numericRepresentation,a,t,!0,!1);this.activeCalendar.year.time.seconds>=e?(this.activeCalendar.year.changeDay(1,"current"),a=this.activeCalendar.year.getMonth(),a&&(t=a.getDay(),t&&(e=this.activeCalendar.year.getSunriseSunsetTime(this.activeCalendar.year.numericRepresentation,a,t,!0,!1),this.activeCalendar.year.time.seconds=e))):this.activeCalendar.year.time.seconds=e}break;case"midday":const e=this.activeCalendar.year.time.secondsPerDay/2;this.activeCalendar.year.time.seconds>=e&&this.activeCalendar.year.changeDay(1,"current"),this.activeCalendar.year.time.seconds=e;break;case"dusk":if(a&&(t=a.getDay(),t)){let e=this.activeCalendar.year.getSunriseSunsetTime(this.activeCalendar.year.numericRepresentation,a,t,!1,!1);this.activeCalendar.year.time.seconds>=e?(this.activeCalendar.year.changeDay(1,"current"),a=this.activeCalendar.year.getMonth(),a&&(t=a.getDay(),t&&(e=this.activeCalendar.year.getSunriseSunsetTime(this.activeCalendar.year.numericRepresentation,a,t,!1,!1),this.activeCalendar.year.time.seconds=e))):this.activeCalendar.year.time.seconds=e}break;case"midnight":this.activeCalendar.year.changeTime(!0,"second",this.activeCalendar.year.time.secondsPerDay-this.activeCalendar.year.time.seconds)}}dateControlApply(t){if(t.stopPropagation(),this.activeCalendar.canUser(game.user,this.activeCalendar.generalSettings.permissions.changeDateTime)){let t=!1;const a=this.activeCalendar.year.selectedYear,n=this.activeCalendar.year.getMonth("selected");if(n){const s=n.getDay("selected");s&&(e.debug("Updating current date to selected day."),t=!0,a===this.activeCalendar.year.visibleYear&&n.visible?this.setCurrentDate(a,n,s):new Dialog({title:$.Localize("FSC.SetCurrentDateDialog.Title"),content:$.Localize("FSC.SetCurrentDateDialog.Content").replace("{DATE}",`${n.name} ${s.numericRepresentation}, ${a}`),buttons:{yes:{label:$.Localize("Yes"),callback:this.setCurrentDate.bind(this,a,n,s)},no:{label:$.Localize("No")}},default:"no"}).render(!0))}t||($.SaveCurrentDate(this.activeCalendar.year).catch(e.error),this.activeCalendar.syncTime().catch(e.error))}else $.UiNotification($.Localize("FSC.Error.Calendar.GMCurrent"),"warn")}setCurrentDate(t,a,n){var s;if($.IsGm()&&this.primary)this.activeCalendar.year.numericRepresentation=t,this.activeCalendar.year.resetMonths(),a.current=!0,a.selected=!1,n.current=!0,n.selected=!1,$.SaveCurrentDate(this.activeCalendar.year).catch(e.error),this.activeCalendar.syncTime().catch(e.error);else if(null===(s=game.users)||void 0===s?void 0:s.find((e=>e.isGM&&e.active))){const s={year:t,month:a.numericRepresentation,day:n.numericRepresentation};e.debug(`Sending Date Change to Primary GM: ${s.year}, ${s.month}, ${s.day}`),H.emit({type:h.date,data:s}).catch(e.error)}else $.UiNotification(game.i18n.localize("FSC.Warn.Calendar.NotGM"),"warn")}searchClick(e){e.stopPropagation(),!X.instance||X.instance&&!X.instance.rendered?(X.instance=new X(this.activeCalendar),X.instance.showApp()):X.instance.bringToTop()}configurationClick(e){e.stopPropagation(),$.IsGm()?!z.instance||z.instance&&!z.instance.rendered?(z.instance=new z(this.activeCalendar.clone()),z.instance.showApp()):z.instance.bringToTop():$.UiNotification($.Localize("FSC.Error.Calendar.GMConfigure"),"warn")}addNote(t){var a;if(t.stopPropagation(),null===(a=game.users)||void 0===a?void 0:a.find((e=>e.isGM&&e.active))){const t=this.activeCalendar.year.getMonth("selected")||this.activeCalendar.year.getMonth();if(t){const a=t.getDay("selected")||t.getDay();if(a){const n=this.activeCalendar.year.selectedYear||this.activeCalendar.year.numericRepresentation,s=new E;s.initialize(n,t.numericRepresentation,a.numericRepresentation,t.name),void 0===this.newNote||this.newNote.rendered||(this.newNote.closeApp(),this.newNote=void 0),void 0===this.newNote?(this.newNote=new U(s),this.newNote.showApp()):(this.newNote.bringToTop(),this.newNote.maximize().catch(e.error))}else $.UiNotification($.Localize("FSC.Error.Note.NoSelectedDay"),"warn")}else $.UiNotification($.Localize("FSC.Error.Note.NoSelectedMonth"),"warn")}else $.UiNotification(game.i18n.localize("FSC.Warn.Notes.NotGM"),"warn")}viewNote(t){t.stopPropagation();const a=t.currentTarget.getAttribute("data-index");if(a){const e=this.activeCalendar.notes.find((e=>e.id===a));e&&(U.instance=new U(e,!0),U.instance.showApp())}else e.error("No Data index on note element found.")}updateApp(){this.rendered&&this.render(!1)}settingUpdate(e=!1,t="all"){this.activeCalendar.settingUpdate(t),e&&this.activeCalendar.year.time.timeKeeper.getStatus()!==f.Started&&this.updateApp()}gamePaused(e){this.activeCalendar.year.time.unifyGameAndClockPause&&(game.paused?this.activeCalendar.year.time.timeKeeper.setStatus(f.Paused):this.activeCalendar.year.time.timeKeeper.start(!0))}worldTimeUpdate(t,a){e.debug(`World Time Update, new time: ${t}. Delta of: ${a}.`),this.activeCalendar.setFromTime(t,a)}createCombatant(e,t,a){const n=game.combats;if(!this.activeCalendar.year.time.combatRunning&&n){const t=n.find((t=>{var a;return t.id===(null===(a=e.parent)||void 0===a?void 0:a.id)})),a=game.scenes,s=a&&a.active?a.active.id:null;t&&t.started&&(null!==s&&t.scene&&t.scene.id===s||null===s)&&(this.activeCalendar.year.time.combatRunning=!0)}}combatUpdate(t,a,n){e.debug("Combat Update");const s=game.scenes,i=s&&s.active?s.active.id:null;t.started&&(null!==i&&t.scene&&t.scene.id===i||null===i)&&(this.activeCalendar.year.time.combatRunning=!0,n&&n.hasOwnProperty("advanceTime")&&(0!==n.advanceTime?(e.debug("Combat Change Triggered"),this.activeCalendar.year.combatChangeTriggered=!0):this.activeCalendar.year.processOwnCombatRoundTime(t)))}combatDelete(t){e.debug("Combat Ended");const a=game.scenes,n=a&&a.active?a.active.id:null;null!==n&&t.scene&&t.scene.id===n&&(this.activeCalendar.year.time.combatRunning=!1)}startTime(){const e=game.scenes,t=game.combats,a=e&&e.active?e.active.id:null;t&&t.size>0&&t.find((e=>e.started&&(null!==a&&e.scene&&e.scene.id===a||null===a)))?$.UiNotification(game.i18n.localize("FSC.Warn.Time.ActiveCombats"),"warn"):this.activeCalendar.generalSettings.gameWorldTimeIntegration!==d.None&&this.activeCalendar.generalSettings.gameWorldTimeIntegration!==d.Self&&this.activeCalendar.generalSettings.gameWorldTimeIntegration!==d.Mixed||this.activeCalendar.year.time.timeKeeper.start()}stopTime(){this.activeCalendar.year.time.timeKeeper.stop()}async timeKeepingCheck(){this.activeCalendar.generalSettings.gameWorldTimeIntegration!==d.None&&$.IsGm()&&await this.activeCalendar.syncTime()}noteDrag(e){const t=e.target,a=t.parentNode,n=e.clientX,s=e.clientY;t.classList.add("drag-active");let i=null===document.elementFromPoint(n,s)?t:document.elementFromPoint(n,s);null!==a&&null!==i&&a===i.parentNode&&(i=i!==t.nextSibling?i:i.nextSibling,a.insertBefore(t,i))}noteDragEnd(t){const a=t.target,n=a.parentNode,s=a.getAttribute("data-index");if(a.classList.remove("drag-active"),s&&n){const t=this.activeCalendar.getNotesForDay();for(let e=0;e<n.children.length;e++){const a=n.children[e].getAttribute("data-index"),s=t.find((e=>e.id===a));s&&(s.order=e)}let a=$.LoadNotes().map((e=>{const t=new E;return t.loadFromSettings(e),t}));a=a.map((e=>t.find((t=>t.id===e.id))||e)),$.SaveNotes(a).catch(e.error)}}checkNoteReminders(t=!1){const a=$.UserID(),n=this.activeCalendar.notes.filter((e=>e.remindUsers.indexOf(a)>-1));if(n.length){const s=this.activeCalendar.year.getMonth(),i=s?s.getDay():this.activeCalendar.year.months[0].days[0],o=this.activeCalendar.year.time.getCurrentTime(),c=o.hour,l=o.minute,h={year:this.activeCalendar.year.numericRepresentation,month:s?s.numericRepresentation:1,day:i?i.numericRepresentation:1,hour:c,minute:l,allDay:!1},d=n.filter((e=>{if(e.repeats===r.Never||t||(e.repeats===r.Yearly?e.year!==h.year&&(e.reminderSent=!1):e.repeats===r.Monthly?(e.year!==h.year||e.month!==h.month||e.month===h.month&&e.year!==h.year)&&(e.reminderSent=!1):e.repeats===r.Weekly&&(e.year===h.year&&e.month===h.month&&e.day===h.day&&(e.day!==h.day||e.month===h.month&&e.year===h.year)||(e.reminderSent=!1))),!e.reminderSent&&e.isVisible(h.year,h.month,h.day)){if(e.allDay)return!0;if(h.hour===e.hour){if(h.minute>=e.minute)return!0}else{if(h.hour>e.hour)return!0;if(h.year>e.year||h.month>e.month||h.day>e.day)return!0}}return!1}));for(let t=0;t<d.length;t++){const n=d[t];ChatMessage.create({speaker:{alias:"Simple Calendar Reminder"},whisper:[a],content:`<div style="margin-bottom: 0.5rem;font-size:0.75rem">${n.display()}</div><h2>${n.title}</h2>${n.content}`}).catch(e.error),n.reminderSent=!0}}}}class te{static show(t=null,a=null,n=null){e.warn("The SimpleCalendar.show function has been depreciated. Please update to use the SimpleCalendar.api.showCalendar() function."),null!==t&&null!==a&&null!==n?O.showCalendar({year:t,month:a,day:n}):O.showCalendar()}static setDateTime(t=null,a=null,n=null,s=null,i=null,r=null){e.warn("The SimpleCalendar.setDateTime function has been depreciated. Please update to use the SimpleCalendar.api.setDate() function."),null===t&&(t=void 0),null===a&&(a=void 0),null===n&&(n=void 0),null===s&&(s=void 0),null===i&&(i=void 0),null===r&&(r=void 0),O.setDate({year:t,month:a,day:n,hour:s,minute:i,second:r})}static changeDateTime(t=0,a=0,n=0,s=0,i=0,r=0){e.warn("The SimpleCalendar.changeDateTime function has been depreciated. Please update to use the SimpleCalendar.api.changeDate() function."),O.changeDate({year:r,month:i,day:s,hour:n,minute:a,second:t})}}ee.instance=new ee,Hooks.on("init",(()=>{ee.instance.init(),window.SimpleCalendar={show:te.show,setDateTime:te.setDateTime,changeDateTime:te.changeDateTime,api:O,Hooks:p}})),Hooks.on("ready",(()=>{ee.instance.initializeSockets(),ee.instance.checkNoteReminders()})),Hooks.on("getSceneControlButtons",ee.instance.getSceneControlButtons.bind(ee.instance)),Hooks.on("updateWorldTime",ee.instance.worldTimeUpdate.bind(ee.instance)),Hooks.on("createCombatant",ee.instance.createCombatant.bind(ee.instance)),Hooks.on("updateCombat",ee.instance.combatUpdate.bind(ee.instance)),Hooks.on("deleteCombat",ee.instance.combatDelete.bind(ee.instance)),Hooks.on("pauseGame",ee.instance.gamePaused.bind(ee.instance)),e.debugMode=!1})()})();