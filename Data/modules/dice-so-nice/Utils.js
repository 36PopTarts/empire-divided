import{TEXTURELIST as e,COLORSETS as a}from"./DiceColors.js";class Utils{static async migrateOldSettings(){let e=game.settings.get("dice-so-nice","settings");e.hasOwnProperty("enabled")&&(await game.user.setFlag("dice-so-nice","settings",e),await game.settings.set("dice-so-nice","settings",{}));let a=game.settings.get("dice-so-nice","formatVersion");if(""==a||"4.1"!=a){if(!game.user.isGM)return ui.notifications.warn(game.i18n.localize("DICESONICE.migrateMessageNeedGM")),!1}else if("4.1"==a){if(game.user.isGM)await Promise.all(game.users.map((async e=>{let a=e.getFlag("dice-so-nice","appearance")?duplicate(e.getFlag("dice-so-nice","appearance")):null;if(a&&a.hasOwnProperty("labelColor")){let a={"-=colorset":null,"-=diceColor":null,"-=edgeColor":null,"-=font":null,"-=labelColor":null,"-=material":null,"-=outlineColor":null,"-=system":null,"-=texture":null};await e.setFlag("dice-so-nice","appearance",a)}})));else{let e=game.user.getFlag("dice-so-nice","appearance")?duplicate(game.user.getFlag("dice-so-nice","appearance")):null;if(e&&e.hasOwnProperty("labelColor")){let e={"-=colorset":null,"-=diceColor":null,"-=edgeColor":null,"-=font":null,"-=labelColor":null,"-=material":null,"-=outlineColor":null,"-=system":null,"-=texture":null};await game.user.setFlag("dice-so-nice","appearance",e)}}return!0}let t=!1;if(""==a){let e=game.user.getFlag("dice-so-nice","settings")?duplicate(game.user.getFlag("dice-so-nice","settings")):{};if(e.diceColor||e.labelColor){let a=mergeObject(game.dice3d.constructor.DEFAULT_OPTIONS,e,{insertKeys:!1,insertValues:!1}),s=mergeObject(game.dice3d.constructor.DEFAULT_APPEARANCE(),e,{insertKeys:!1,insertValues:!1});await game.settings.set("dice-so-nice","settings",mergeObject(a,{"-=dimensions":null,"-=fxList":null})),await game.user.setFlag("dice-so-nice","appearance",s),t=!0}await Promise.all(game.users.map((async e=>{let a=e.getFlag("dice-so-nice","appearance")?duplicate(e.getFlag("dice-so-nice","appearance")):null;if(a&&a.hasOwnProperty("labelColor")){let s={global:a};await e.unsetFlag("dice-so-nice","appearance"),await e.setFlag("dice-so-nice","appearance",s),t=!0}let s=e.getFlag("dice-so-nice","sfxList")?duplicate(e.getFlag("dice-so-nice","sfxList")):null;s&&(Array.isArray(s)||(s=Object.values(s)),s.forEach((e=>{e.onResult=[e.onResult]})),await e.unsetFlag("dice-so-nice","sfxList"),await e.setFlag("dice-so-nice","sfxList",s),t=!0)})))}return await Promise.all(game.users.map((async e=>{let a=e.getFlag("dice-so-nice","appearance")?duplicate(e.getFlag("dice-so-nice","appearance")):null;if(a&&a.hasOwnProperty("labelColor")){let a={"-=colorset":null,"-=diceColor":null,"-=edgeColor":null,"-=font":null,"-=labelColor":null,"-=material":null,"-=outlineColor":null,"-=system":null,"-=texture":null};await e.setFlag("dice-so-nice","appearance",a)}}))),game.settings.set("dice-so-nice","formatVersion","4.1"),t&&ui.notifications.info(game.i18n.localize("DICESONICE.migrateMessage")),!0}static localize(e){return Object.keys(e).reduce(((a,t)=>(a[t]=game.i18n.localize(e[t]),a)),{})}static contrastOf(e){"#"===e.slice(0,1)&&(e=e.slice(1)),3===e.length&&(e=e.split("").map((function(e){return e+e})).join(""));return(299*parseInt(e.substr(0,2),16)+587*parseInt(e.substr(2,2),16)+114*parseInt(e.substr(4,2),16))/1e3>=128?"#000000":"#FFFFFF"}static prepareTextureList(){return Object.keys(e).reduce(((a,t)=>(a[t]=game.i18n.localize(e[t].name),a)),{})}static prepareFontList(){let e={auto:game.i18n.localize("DICESONICE.FontAuto")};return game.dice3d.box.dicefactory.fontFamilies.forEach((a=>{e[a]=a})),e}static prepareColorsetList(){let e=Object.values(a);e.sort(((e,a)=>game.i18n.localize(e.description)<game.i18n.localize(a.description)?-1:game.i18n.localize(e.description)>game.i18n.localize(a.description)?1:void 0));let t={};for(let a=0;a<e.length;a++){if("hidden"==e[a].visibility)continue;let s=game.i18n.localize(e[a].category);t.hasOwnProperty(s)||(t[s]={}),t[s][e[a].name]=game.i18n.localize(e[a].description)}return t}static prepareSystemList(){let e=game.dice3d.box.dicefactory.systems;return Object.keys(e).reduce(((a,t)=>(a[t]=game.i18n.localize(e[t].name),a)),{})}static filterObject(e,a){return Object.keys(e).filter((t=>a(e[t]))).reduce(((a,t)=>(a[t]=e[t],a)),{})}static actionSaveAs(e){let a,t=game.user.getFlag("dice-so-nice","saves");a=t?new Map(Object.entries(t)):new Map;let s={appearance:game.user.getFlag("dice-so-nice","appearance"),sfxList:game.user.getFlag("dice-so-nice","sfxList"),settings:game.settings.get("dice-so-nice","settings")};a.set(e,s),game.user.unsetFlag("dice-so-nice","saves").then((()=>{game.user.setFlag("dice-so-nice","saves",Object.fromEntries(a))}))}static async actionDeleteSave(e){let a=game.user.getFlag("dice-so-nice","saves"),t=new Map(Object.entries(a));t.delete(e),game.user.unsetFlag("dice-so-nice","saves").then((async()=>{await game.user.setFlag("dice-so-nice","saves",Object.fromEntries(t)),ui.notifications.info(game.i18n.localize("DICESONICE.saveMessage"))}))}static async actionLoadSave(e){let a=game.user.getFlag("dice-so-nice","saves"),t=new Map(Object.entries(a)).get(e);t.appearance&&(await game.user.unsetFlag("dice-so-nice","appearance"),await game.user.setFlag("dice-so-nice","appearance",t.appearance)),t.sfxList&&(await game.user.unsetFlag("dice-so-nice","sfxList"),await game.user.setFlag("dice-so-nice","sfxList",t.sfxList)),await game.settings.set("dice-so-nice","settings",t.settings)}}export{Utils};
//# sourceMappingURL=Utils.js.map
